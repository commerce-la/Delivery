<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>엑셀 변환 도구</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SheetJS (브라우저용) -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      line-height: 1.5;
    }

    header {
      padding: 16px 24px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.95);
      position: sticky;
      top: 0;
      backdrop-filter: blur(10px);
      z-index: 10;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
    }

    main {
      max-width: 960px;
      margin: 0 auto;
      padding: 32px 16px 48px;
    }

    .card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.4);
    }

    .card h2 {
      margin-top: 0;
      font-size: 22px;
      margin-bottom: 8px;
    }

    .card p {
      margin-top: 0;
      margin-bottom: 16px;
      color: #cbd5f5;
      font-size: 14px;
    }

    .file-input {
      margin: 16px 0;
    }

    input[type="file"] {
      font-size: 14px;
    }

    button {
      margin-top: 16px;
      padding: 10px 20px;
      border-radius: 9999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      background: #2563eb;
      color: #f9fafb;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status {
      margin-top: 12px;
      font-size: 13px;
      color: #a5b4fc;
      min-height: 18px;
    }

    .preview {
      margin-top: 24px;
      font-size: 13px;
      color: #e5e7eb;
      max-height: 220px;
      overflow: auto;
      border-top: 1px solid rgba(148, 163, 184, 0.4);
      padding-top: 16px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 12px;
      background: rgba(15, 23, 42, 0.9);
    }

    th, td {
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 4px 6px;
      text-align: left;
      white-space: nowrap;
    }

    th {
      background: rgba(37, 99, 235, 0.2);
    }
  </style>
</head>
<body>
  <header>
    <h1>엑셀 변환 도구 (GitHub Pages)</h1>
  </header>

  <main>
    <div class="card">
      <h2>엑셀 업로드 → 규칙 적용 → 새 엑셀 다운로드</h2>
      <p>
        아래에 엑셀 파일(.xlsx)을 업로드하면, 미리 정의된 규칙에 따라 데이터를 변환하고
        <strong>새로운 엑셀 파일</strong>로 다운로드해 줍니다.
        <br />
        (모든 처리는 브라우저 안에서만 실행되고, 서버로 업로드되지 않습니다.)
      </p>

      <div class="file-input">
        <input type="file" id="file-input" accept=".xlsx,.xls" />
      </div>

      <button id="convert-btn" disabled>엑셀 변환하기</button>

      <div class="status" id="status"></div>

      <div class="preview" id="preview"></div>
    </div>
  </main>

  <script>
    const fileInput = document.getElementById("file-input");
    const convertBtn = document.getElementById("convert-btn");
    const statusEl = document.getElementById("status");
    const previewEl = document.getElementById("preview");

    let originalRows = [];

    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) {
        convertBtn.disabled = true;
        statusEl.textContent = "파일을 선택해 주세요.";
        return;
      }

      try {
        statusEl.textContent = "엑셀 읽는 중...";
        previewEl.innerHTML = "";

        const data = await file.arrayBuffer();

        // 엑셀 읽기
        const workbook = XLSX.read(data);
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];

        // 시트 → JS 객체 배열로 변환
        originalRows = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

        statusEl.textContent = `첫 번째 시트("${firstSheetName}")에서 ${originalRows.length}개의 행을 읽었습니다.`;
        convertBtn.disabled = originalRows.length === 0;

        // 미리보기 표시 (앞부분 몇 줄만)
        showPreviewTable(originalRows);

      } catch (err) {
        console.error(err);
        statusEl.textContent = "엑셀 파일을 읽는 중 오류가 발생했습니다.";
        convertBtn.disabled = true;
      }
    });

    convertBtn.addEventListener("click", () => {
      if (!originalRows || originalRows.length === 0) {
        statusEl.textContent = "먼저 엑셀 파일을 업로드해 주세요.";
        return;
      }

      try {
        statusEl.textContent = "규칙을 적용하는 중...";

        // ⬇⬇⬇ 여기가 "규칙"을 정의하는 부분입니다 ⬇⬇⬇
        const transformedRows = applyRules(originalRows);
        // ⬆⬆⬆ 이 함수 안을 바꾸면 원하는 규칙으로 가공할 수 있어요 ⬆⬆⬆

        // JS 객체 배열 → 워크시트
        const newWorksheet = XLSX.utils.json_to_sheet(transformedRows);

        // 새 워크북 만들고 시트 추가
        const newWorkbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, "결과");

        // 엑셀 파일로 다운로드 (파일명은 원하는 대로 변경 가능)
        XLSX.writeFile(newWorkbook, "waybill.xlsx", { compression: true });

        statusEl.textContent = `변환 완료! 총 ${transformedRows.length}개의 행이 결과 파일에 포함되었습니다.`;

      } catch (err) {
        console.error(err);
        statusEl.textContent = "변환 중 오류가 발생했습니다.";
      }
    });

/**
 * 규칙 적용 함수
 * rows: alpha_delivery 형식의 행 배열
 */
function applyRules(rows) {
  // rows 의 예시 컬럼 (alpha_goods 기준):
  // "상품코드", "품목명", "바코드", "상품명", "규격", "단위", "입수", "납품단가", "상품분류1", "상품분류2", "상품분류3" ...

  // 여기서는 alpha_delivery 의 각 상품 행을
  // waybill 양식의 한 줄로 변환한다고 가정합니다.
  // 받는분/보내는분 정보는 아직 정해진 게 없어서 일단 공란("")으로 두고,
  // 품목명과 박스수량만 채워 넣는 기본 매핑입니다.

  const result = rows.map((row) => {
    // alpha 파일에서 품목 이름은 "상품명" 또는 "품목명" 컬럼에서 가져옵니다.
    const itemName = row["상품명"] || row["품목명"] || "";

    return {
      "받는분성명": "",                 // 필요하면 나중에 고정 값이나 다른 컬럼 값으로 채워도 됨
      "받는분주소(전체, 분할)": "",
      "받는분전화번호": "",
      "받는분기타연락처": "",
      "품목명": "",                     // ▶ alpha의 상품명을 waybill 품목명으로
      "박스수량": 1,                    // ▶ 기본값 1박스로 설정
      "기본운임": "",                   // ▶ 운임 정보가 있으면 나중에 규칙 추가 가능
      "운임구분": "",
      "보내는분성명": "",
      "보내는분주소(전체, 분할)": "경기도 김포시 애기봉로 206",
      "보내는분전화번호": "031-987-9495",
      "배송메세지1": "",
      "기타1": ""
    };
  });

  return result;
}

    function showPreviewTable(rows) {
      if (!rows || rows.length === 0) {
        previewEl.innerHTML = "<em>미리보기할 데이터가 없습니다.</em>";
        return;
      }

      const maxRows = 20; // 미리보기는 최대 20개까지만
      const previewRows = rows.slice(0, maxRows);

      const keys = Object.keys(previewRows[0]);

      let html = "<div>원본 데이터 미리보기 (상위 " + previewRows.length + "행)</div>";
      html += "<table><thead><tr>";
      for (const key of keys) {
        html += "<th>" + escapeHtml(key) + "</th>";
      }
      html += "</tr></thead><tbody>";

      for (const row of previewRows) {
        html += "<tr>";
        for (const key of keys) {
          html += "<td>" + escapeHtml(row[key]) + "</td>";
        }
        html += "</tr>";
      }

      html += "</tbody></table>";
      previewEl.innerHTML = html;
    }

    function escapeHtml(value) {
      if (value === null || value === undefined) return "";
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }
  </script>
</body>
</html>

