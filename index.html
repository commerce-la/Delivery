<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì—‘ì…€ ë³€í™˜ ë„êµ¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SheetJS (ë¸Œë¼ìš°ì €ìš©) -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      line-height: 1.5;
    }

    header {
      padding: 16px 24px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.95);
      position: sticky;
      top: 0;
      backdrop-filter: blur(10px);
      z-index: 10;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
    }

    main {
      max-width: 960px;
      margin: 0 auto;
      padding: 32px 16px 48px;
    }

    .card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.4);
    }

    .card h2 {
      margin-top: 0;
      font-size: 22px;
      margin-bottom: 8px;
    }

    .card p {
      margin-top: 0;
      margin-bottom: 16px;
      color: #cbd5f5;
      font-size: 14px;
    }

    .file-input {
      margin: 16px 0;
    }

    input[type="file"] {
      font-size: 14px;
    }

    button {
      margin-top: 16px;
      padding: 10px 20px;
      border-radius: 9999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      background: #2563eb;
      color: #f9fafb;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status {
      margin-top: 12px;
      font-size: 13px;
      color: #a5b4fc;
      min-height: 18px;
    }

    .preview {
      margin-top: 24px;
      font-size: 13px;
      color: #e5e7eb;
      max-height: 220px;
      overflow: auto;
      border-top: 1px solid rgba(148, 163, 184, 0.4);
      padding-top: 16px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 12px;
      background: rgba(15, 23, 42, 0.9);
    }

    th, td {
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 4px 6px;
      text-align: left;
      white-space: nowrap;
    }

    th {
      background: rgba(37, 99, 235, 0.2);
    }
  </style>
</head>
<body>
  <header>
    <h1>ì—‘ì…€ ë³€í™˜ ë„êµ¬ (GitHub Pages)</h1>
  </header>

  <main>
    <div class="card">
      <h2>ì—‘ì…€ ì—…ë¡œë“œ â†’ ê·œì¹™ ì ìš© â†’ ìƒˆ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</h2>
      <p>
        ì•„ë˜ì— ì—‘ì…€ íŒŒì¼(.xlsx)ì„ ì—…ë¡œë“œí•˜ë©´, ë¯¸ë¦¬ ì •ì˜ëœ ê·œì¹™ì— ë”°ë¼ ë°ì´í„°ë¥¼ ë³€í™˜í•˜ê³ 
        <strong>ìƒˆë¡œìš´ ì—‘ì…€ íŒŒì¼</strong>ë¡œ ë‹¤ìš´ë¡œë“œí•´ ì¤ë‹ˆë‹¤.
        <br />
        (ëª¨ë“  ì²˜ë¦¬ëŠ” ë¸Œë¼ìš°ì € ì•ˆì—ì„œë§Œ ì‹¤í–‰ë˜ê³ , ì„œë²„ë¡œ ì—…ë¡œë“œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)
      </p>

      <div class="file-input">
        <input type="file" id="file-input" accept=".xlsx,.xls" />
      </div>

      <button id="convert-btn" disabled>ì—‘ì…€ ë³€í™˜í•˜ê¸°</button>

      <div class="status" id="status"></div>

      <div class="preview" id="preview"></div>
    </div>
  </main>

  <script>
    const fileInput = document.getElementById("file-input");
    const convertBtn = document.getElementById("convert-btn");
    const statusEl = document.getElementById("status");
    const previewEl = document.getElementById("preview");

    let originalRows = [];

    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) {
        convertBtn.disabled = true;
        statusEl.textContent = "íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.";
        return;
      }

      try {
        statusEl.textContent = "ì—‘ì…€ ì½ëŠ” ì¤‘...";
        previewEl.innerHTML = "";

        const data = await file.arrayBuffer();

        // ì—‘ì…€ ì½ê¸°
        const workbook = XLSX.read(data);
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];

        // ì‹œíŠ¸ â†’ JS ê°ì²´ ë°°ì—´ë¡œ ë³€í™˜
        originalRows = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

        statusEl.textContent = `ì²« ë²ˆì§¸ ì‹œíŠ¸("${firstSheetName}")ì—ì„œ ${originalRows.length}ê°œì˜ í–‰ì„ ì½ì—ˆìŠµë‹ˆë‹¤.`;
        convertBtn.disabled = originalRows.length === 0;

        // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ (ì•ë¶€ë¶„ ëª‡ ì¤„ë§Œ)
        showPreviewTable(originalRows);

      } catch (err) {
        console.error(err);
        statusEl.textContent = "ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        convertBtn.disabled = true;
      }
    });

    convertBtn.addEventListener("click", () => {
      if (!originalRows || originalRows.length === 0) {
        statusEl.textContent = "ë¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.";
        return;
      }

      try {
        statusEl.textContent = "ê·œì¹™ì„ ì ìš©í•˜ëŠ” ì¤‘...";

        // â¬‡â¬‡â¬‡ ì—¬ê¸°ê°€ "ê·œì¹™"ì„ ì •ì˜í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤ â¬‡â¬‡â¬‡
        const transformedRows = applyRules(originalRows);
        // â¬†â¬†â¬† ì´ í•¨ìˆ˜ ì•ˆì„ ë°”ê¾¸ë©´ ì›í•˜ëŠ” ê·œì¹™ìœ¼ë¡œ ê°€ê³µí•  ìˆ˜ ìˆì–´ìš” â¬†â¬†â¬†

        // JS ê°ì²´ ë°°ì—´ â†’ ì›Œí¬ì‹œíŠ¸
        const newWorksheet = XLSX.utils.json_to_sheet(transformedRows);

        // ìƒˆ ì›Œí¬ë¶ ë§Œë“¤ê³  ì‹œíŠ¸ ì¶”ê°€
        const newWorkbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, "ê²°ê³¼");

        // ì—‘ì…€ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ (íŒŒì¼ëª…ì€ ì›í•˜ëŠ” ëŒ€ë¡œ ë³€ê²½ ê°€ëŠ¥)
        XLSX.writeFile(newWorkbook, "result.xlsx", { compression: true });

        statusEl.textContent = `ë³€í™˜ ì™„ë£Œ! ì´ ${transformedRows.length}ê°œì˜ í–‰ì´ ê²°ê³¼ íŒŒì¼ì— í¬í•¨ë˜ì—ˆìŠµë‹ˆë‹¤.`;

      } catch (err) {
        console.error(err);
        statusEl.textContent = "ë³€í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      }
    });

    /**
     * ê·œì¹™ ì ìš© í•¨ìˆ˜
     * rows: [{ì—´1: ê°’, ì—´2: ê°’, ...}, ...]
     */
    function applyRules(rows) {
      // ğŸ”½ ì˜ˆì‹œ ê·œì¹™ (ì›í•˜ëŠ” ëŒ€ë¡œ ìˆ˜ì • ê°€ëŠ¥) ğŸ”½
      // 1) "ì‚¬ìš©" ì»¬ëŸ¼ì´ "Y"ì¸ í–‰ë§Œ ë‚¨ê¸°ê¸°
      // 2) "ê¸ˆì•¡" ì»¬ëŸ¼ ìˆ«ìë¡œ ë³€í™˜
      // 3) "ë¶€ê°€ì„¸í¬í•¨ê¸ˆì•¡" ì»¬ëŸ¼ì„ ì¶”ê°€ (ê¸ˆì•¡ * 1.1)
      // 4) ìˆœë²ˆ ì»¬ëŸ¼(1ë¶€í„° ì‹œì‘) ì¶”ê°€

      // ì»¬ëŸ¼ ì´ë¦„ì€ ì‹¤ì œ ì—‘ì…€ ì²« í–‰ í—¤ë”ì™€ ë™ì¼í•´ì•¼ í•©ë‹ˆë‹¤.
      // ì˜ˆ: ì—‘ì…€ ì²« í–‰ì´ [ì´ë¦„, ê¸ˆì•¡, ì‚¬ìš©] ì´ë©´ ì•„ë˜ì²˜ëŸ¼ ì‚¬ìš© ê°€ëŠ¥
      const filtered = rows.filter(row => String(row["ì‚¬ìš©"]).trim().toUpperCase() === "Y");

      const transformed = filtered.map((row, index) => {
        const amount = Number(row["ê¸ˆì•¡"] || 0);
        return {
          "ìˆœë²ˆ": index + 1,
          "ì´ë¦„": row["ì´ë¦„"] ?? "",
          "ê¸ˆì•¡": amount,
          "ë¶€ê°€ì„¸í¬í•¨ê¸ˆì•¡": Math.round(amount * 1.1),
          // í•„ìš”í•˜ë©´ ì›ë³¸ ë°ì´í„°ë„ ê°™ì´ ë„£ì„ ìˆ˜ ìˆìŒ
          "ë¹„ê³ ": row["ë¹„ê³ "] ?? ""
        };
      });

      return transformed;
    }

    function showPreviewTable(rows) {
      if (!rows || rows.length === 0) {
        previewEl.innerHTML = "<em>ë¯¸ë¦¬ë³´ê¸°í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</em>";
        return;
      }

      const maxRows = 10; // ë¯¸ë¦¬ë³´ê¸°ëŠ” ìµœëŒ€ 10ê°œê¹Œì§€ë§Œ
      const previewRows = rows.slice(0, maxRows);

      const keys = Object.keys(previewRows[0]);

      let html = "<div>ì›ë³¸ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (ìƒìœ„ " + previewRows.length + "í–‰)</div>";
      html += "<table><thead><tr>";
      for (const key of keys) {
        html += "<th>" + escapeHtml(key) + "</th>";
      }
      html += "</tr></thead><tbody>";

      for (const row of previewRows) {
        html += "<tr>";
        for (const key of keys) {
          html += "<td>" + escapeHtml(row[key]) + "</td>";
        }
        html += "</tr>";
      }

      html += "</tbody></table>";
      previewEl.innerHTML = html;
    }

    function escapeHtml(value) {
      if (value === null || value === undefined) return "";
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }
  </script>
</body>
</html>

