<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì—‘ì…€ â†’ waybill ë³€í™˜ ë„êµ¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SheetJS (ë¸Œë¼ìš°ì €ìš©) -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      line-height: 1.5;
    }

    header {
      padding: 16px 24px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.95);
      position: sticky;
      top: 0;
      backdrop-filter: blur(10px);
      z-index: 10;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
    }

    main {
      max-width: 1040px;
      margin: 0 auto;
      padding: 32px 16px 48px;
    }

    .card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.4);
      margin-bottom: 24px;
    }

    .card h2 {
      margin-top: 0;
      font-size: 22px;
      margin-bottom: 8px;
    }

    .card p {
      margin-top: 0;
      margin-bottom: 16px;
      color: #cbd5f5;
      font-size: 14px;
    }

    .file-input {
      margin: 16px 0;
    }

    input[type="file"] {
      font-size: 14px;
    }

    button {
      margin-top: 16px;
      padding: 10px 20px;
      border-radius: 9999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      background: #2563eb;
      color: #f9fafb;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status {
      margin-top: 12px;
      font-size: 13px;
      color: #a5b4fc;
      min-height: 18px;
    }

    .preview {
      margin-top: 24px;
      font-size: 13px;
      color: #e5e7eb;
      max-height: 220px;
      overflow: auto;
      border-top: 1px solid rgba(148, 163, 184, 0.4);
      padding-top: 16px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 12px;
      background: rgba(15, 23, 42, 0.9);
    }

    th, td {
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 4px 6px;
      white-space: nowrap;
    }

    th {
      background: rgba(37, 99, 235, 0.3);
    }

    .mapping {
      margin-top: 16px;
      font-size: 13px;
    }

    .mapping-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px 16px;
      margin-top: 12px;
    }

    .mapping-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .mapping-item label {
      font-size: 12px;
      color: #e5e7eb;
    }

    .mapping-item select {
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
    }

    .mapping-hint {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .section-title {
      font-size: 16px;
      margin-top: 0;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <header>
    <h1>ì—‘ì…€ â†’ waybill ë³€í™˜ ë„êµ¬</h1>
  </header>

  <main>
    <!-- 1. íŒŒì¼ ì—…ë¡œë“œ -->
    <div class="card">
      <h2>1. ì—‘ì…€ ì—…ë¡œë“œ</h2>
      <p>
        ì–´ë–¤ í˜•ì‹ì˜ ì—‘ì…€ì´ë¼ë„ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <br />
        ì—…ë¡œë“œ í›„, ì•„ë˜ì—ì„œ <strong>ê° ì—´ì„ waybill ì–‘ì‹ì˜ ì–´ë–¤ í•­ëª©ì— ì“¸ì§€</strong> ì„ íƒí•˜ë©´,
        ë™ì¼í•œ waybill í˜•ì‹ìœ¼ë¡œ ì—‘ì…€ íŒŒì¼ì„ ë§Œë“¤ì–´ ì¤ë‹ˆë‹¤.
      </p>

      <div class="file-input">
        <input type="file" id="file-input" accept=".xlsx,.xls" />
      </div>

      <div class="status" id="status"></div>
    </div>

    <!-- 2. ì—…ì²´ëª… + ì—´ ë§¤í•‘ ì„¤ì • -->
    <div class="card">
      <h2>2. ì—…ì²´ëª… & ì—´ ë§¤í•‘ ì„¤ì •</h2>
      <p>
        ë¨¼ì € ì—…ì²´ëª…ì„ ì„ íƒí•˜ê³ , ì—…ë¡œë“œí•œ ì—‘ì…€ì˜ ì»¬ëŸ¼(ì—´)ì„ waybill í•­ëª©ì— ì—°ê²°í•´ ì£¼ì„¸ìš”.
      </p>

      <!-- ì—…ì²´ëª… ì„ íƒ -->
      <div class="mapping">
        <h3 class="section-title">ì—…ì²´ëª… ì„ íƒ</h3>

        <div class="mapping-item" style="max-width: 240px;">
          <label for="vendor-select">ì—…ì²´ëª…</label>
          <select id="vendor-select">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="ì•ŒíŒŒ">ì•ŒíŒŒ</option>
          </select>
          <div class="mapping-hint">* í˜„ì¬ëŠ” "ì•ŒíŒŒ" ì„ íƒë§Œ ì§€ì›í•©ë‹ˆë‹¤.</div>
        </div>

        <hr style="margin: 20px 0; border-color: rgba(148,163,184,0.3);" />
      </div>

      <!-- ì—´ ë§¤í•‘ UI -->
      <div id="mapping" class="mapping">
        ì•„ì§ íŒŒì¼ì´ ì—…ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
      </div>
    </div>

    <!-- 3. ë¯¸ë¦¬ë³´ê¸° & ë³€í™˜ -->
    <div class="card">
      <h2>3. ë¯¸ë¦¬ë³´ê¸° & ë³€í™˜ ì‹¤í–‰</h2>
      <p>
        ì•„ë˜ì— ì›ë³¸ ë°ì´í„°ì˜ ì¼ë¶€ë¥¼ ë¯¸ë¦¬ ë³´ì—¬ì¤ë‹ˆë‹¤. <br />
        ì—…ì²´ëª…ê³¼ ì—´ ë§¤í•‘ì„ í™•ì¸í•œ í›„ <strong>ì—‘ì…€ ë³€í™˜í•˜ê¸°</strong> ë²„íŠ¼ì„ ëˆ„ë¥´ë©´, waybill í˜•ì‹ì˜ ì—‘ì…€ì´ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.
      </p>

      <button id="convert-btn" disabled>ì—‘ì…€ ë³€í™˜í•˜ê¸° (waybill.xlsx)</button>

      <div class="status" id="status-convert"></div>

      <div class="preview" id="preview"></div>
    </div>
  </main>

  <!-- ğŸ”» ìŠ¤í¬ë¦½íŠ¸ëŠ” ê¼­ body ë§¨ ëì— ë‘ì„¸ìš” ğŸ”» -->
  <script>
    const fileInput = document.getElementById("file-input");
    const convertBtn = document.getElementById("convert-btn");
    const statusEl = document.getElementById("status");
    const statusConvertEl = document.getElementById("status-convert");
    const previewEl = document.getElementById("preview");
    const mappingEl = document.getElementById("mapping");
    const vendorSelect = document.getElementById("vendor-select");

    let originalRows = [];
    let headers = [];
    let selectedVendor = "";

    // waybill ì–‘ì‹ ê³ ì • ì»¬ëŸ¼ ì •ì˜
    const WAYBILL_FIELDS = [
      { key: "ë°›ëŠ”ë¶„ì„±ëª…", label: "ë°›ëŠ”ë¶„ ì„±ëª…" },
      { key: "ë°›ëŠ”ë¶„ì£¼ì†Œ(ì „ì²´, ë¶„í• )", label: "ë°›ëŠ”ë¶„ ì£¼ì†Œ(ì „ì²´, ë¶„í• )" },
      { key: "ë°›ëŠ”ë¶„ì „í™”ë²ˆí˜¸", label: "ë°›ëŠ”ë¶„ ì „í™”ë²ˆí˜¸" },
      { key: "ë°›ëŠ”ë¶„ê¸°íƒ€ì—°ë½ì²˜", label: "ë°›ëŠ”ë¶„ ê¸°íƒ€ ì—°ë½ì²˜" },
      { key: "í’ˆëª©ëª…", label: "í’ˆëª©ëª…" },
      { key: "ë°•ìŠ¤ìˆ˜ëŸ‰", label: "ë°•ìŠ¤ ìˆ˜ëŸ‰" },
      { key: "ê¸°ë³¸ìš´ì„", label: "ê¸°ë³¸ ìš´ì„" },
      { key: "ìš´ì„êµ¬ë¶„", label: "ìš´ì„ êµ¬ë¶„" },
      { key: "ë³´ë‚´ëŠ”ë¶„ì„±ëª…", label: "ë³´ë‚´ëŠ”ë¶„ ì„±ëª…" },
      { key: "ë³´ë‚´ëŠ”ë¶„ì£¼ì†Œ(ì „ì²´, ë¶„í• )", label: "ë³´ë‚´ëŠ”ë¶„ ì£¼ì†Œ(ì „ì²´, ë¶„í• )" },
      { key: "ë³´ë‚´ëŠ”ë¶„ì „í™”ë²ˆí˜¸", label: "ë³´ë‚´ëŠ”ë¶„ ì „í™”ë²ˆí˜¸" },
      { key: "ë°°ì†¡ë©”ì„¸ì§€1", label: "ë°°ì†¡ ë©”ì„¸ì§€ 1" },
      { key: "ê¸°íƒ€1", label: "ê¸°íƒ€1" }
    ];

    // ì—…ì²´ëª… ì„ íƒ ì´ë²¤íŠ¸
    vendorSelect.addEventListener("change", (e) => {
      selectedVendor = e.target.value;
    });

    // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸
    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      statusConvertEl.textContent = "";
      if (!file) {
        convertBtn.disabled = true;
        statusEl.textContent = "íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.";
        mappingEl.textContent = "ì•„ì§ íŒŒì¼ì´ ì—…ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
        previewEl.innerHTML = "";
        return;
      }

      try {
        statusEl.textContent = "ì—‘ì…€ ì½ëŠ” ì¤‘...";
        previewEl.innerHTML = "";
        mappingEl.textContent = "";

        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];

        originalRows = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

        if (!originalRows || originalRows.length === 0) {
          statusEl.textContent = `ì²« ë²ˆì§¸ ì‹œíŠ¸("${firstSheetName}")ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`;
          convertBtn.disabled = true;
          mappingEl.textContent = "ë§¤í•‘ì„ í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }

        headers = Object.keys(originalRows[0]);
        statusEl.textContent = `ì²« ë²ˆì§¸ ì‹œíŠ¸("${firstSheetName}")ì—ì„œ ${originalRows.length}ê°œì˜ í–‰ì„ ì½ì—ˆìŠµë‹ˆë‹¤.`;

        convertBtn.disabled = false;

        showPreviewTable(originalRows);
        buildMappingUI(headers);

      } catch (err) {
        console.error(err);
        statusEl.textContent = "ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        convertBtn.disabled = true;
        mappingEl.textContent = "ë§¤í•‘ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
      }
    });

    // ë³€í™˜ ë²„íŠ¼
    convertBtn.addEventListener("click", () => {
      statusConvertEl.textContent = "";

      if (!selectedVendor) {
        statusConvertEl.textContent = "ë¨¼ì € ì—…ì²´ëª…ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.";
        return;
      }

      if (!originalRows || originalRows.length === 0) {
        statusConvertEl.textContent = "ë¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.";
        return;
      }

      const mapping = getMapping();
      if (!mapping) {
        statusConvertEl.textContent = "ì—´ ë§¤í•‘ì„ ì½ì–´ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        return;
      }

      try {
        statusConvertEl.textContent = "ê·œì¹™ì„ ì ìš©í•˜ëŠ” ì¤‘...";

        const transformedRows = applyRules(originalRows, mapping);

        const newWorksheet = XLSX.utils.json_to_sheet(transformedRows);
        const newWorkbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, "waybill");

        XLSX.writeFile(newWorkbook, "waybill.xlsx", { compression: true });

        statusConvertEl.textContent =
          `ë³€í™˜ ì™„ë£Œ! ì´ ${transformedRows.length}ê°œì˜ í–‰ì´ waybill.xlsxì— í¬í•¨ë˜ì—ˆìŠµë‹ˆë‹¤.`;

      } catch (err) {
        console.error(err);
        statusConvertEl.textContent = "ë³€í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      }
    });

    // ë§¤í•‘ UI ë§Œë“¤ê¸°
    function buildMappingUI(headers) {
      if (!headers || headers.length === 0) {
        mappingEl.textContent = "ì…ë ¥ ì—‘ì…€ì˜ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      let html = "";
      html += `<div class="mapping-hint">`;
      html += `ê° waybill í•­ëª©ì— ëŒ€í•´, ì–´ë–¤ ì…ë ¥ ì—‘ì…€ ì—´ì„ ì‚¬ìš©í• ì§€ ì„ íƒí•˜ì„¸ìš”. `;
      html += `ì„ íƒí•˜ì§€ ì•Šì€ í•­ëª©ì€ ë¹ˆ ê°’ìœ¼ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤.`;
      html += `</div>`;

      html += `<div class="mapping-grid">`;

      for (const field of WAYBILL_FIELDS) {
        html += `<div class="mapping-item">`;
        html += `<label for="map-${field.key}">waybill: ${field.key}</label>`;
        html += `<select id="map-${field.key}" data-field="${field.key}">`;
        html += `<option value="">(ë¹„ì›Œë‘ê¸°)</option>`;

        for (const h of headers) {
          html += `<option value="${escapeHtml(h)}">${escapeHtml(h)}</option>`;
        }

        html += `</select>`;
        html += `</div>`;
      }

      html += `</div>`;
      mappingEl.innerHTML = html;
    }

    // ì…€ë ‰íŠ¸ ë°•ìŠ¤ì—ì„œ ë§¤í•‘ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    function getMapping() {
      const mapping = {};
      for (const field of WAYBILL_FIELDS) {
        const select = document.querySelector(`select[data-field="${field.key}"]`);
        if (!select) continue;
        const value = select.value;
        mapping[field.key] = value || null;
      }
      return mapping;
    }

function applyRules(rows, mapping) {
  let workingRows = [...rows];

  // ============================
  // â˜… 0. ì•ŒíŒŒ ì „ìš© ì„ ì²˜ë¦¬ ê·œì¹™
  // ============================
  if (selectedVendor === "ì•ŒíŒŒ") {
    workingRows = workingRows.map((row) => {
      const purchaser = (row["ë°œì£¼ì²˜"] ?? "").toString().trim();
      const receiver = (row["ìˆ˜ë ¹ìëª…"] ?? "").toString().trim();

      // ê·œì¹™ C: ë°œì£¼ì²˜ì™€ ìˆ˜ë ¹ìëª…ì´ ëª¨ë‘ "ì•ˆì„±ë¬¼ë¥˜"ë©´ ì£¼ë¬¸ëŸ‰ì„ 0ìœ¼ë¡œ ê°•ì œ ë³€ê²½
      if (purchaser === "ì•ˆì„±ë¬¼ë¥˜" && receiver === "ì•ˆì„±ë¬¼ë¥˜") {
        return {
          ...row,
          ì£¼ë¬¸ëŸ‰: 0
        };
      }

      return row;
    });
  }

  // ============================
  // â˜… 1. ì£¼ë¬¸ëŸ‰ 0 í–‰ ì œê±° (ì•ŒíŒŒ ì „ìš©)
  // ============================
  if (selectedVendor === "ì•ŒíŒŒ") {
    workingRows = workingRows.filter((row) => {
      const raw = row["ì£¼ë¬¸ëŸ‰"];

      if (raw === null || raw === undefined || raw === "") return false;

      const num = Number(String(raw).replace(/,/g, "").trim() || "0");

      return Number.isFinite(num) && num !== 0;
    });
  }

  // ============================
  // â˜… 2. ê°œë³„ í–‰ ë³€í™˜ ì²˜ë¦¬
  // ============================
  const result = workingRows.map((row) => {
    const out = {};

    for (const field of WAYBILL_FIELDS) {
      const key = field.key;

      // ë³´ë‚´ëŠ”ë¶„ ì£¼ì†Œ ê³ ì •
      if (key === "ë³´ë‚´ëŠ”ë¶„ì£¼ì†Œ(ì „ì²´, ë¶„í• )") {
        out[key] = "ê²½ê¸°ë„ ê¹€í¬ì‹œ ì• ê¸°ë´‰ë¡œ 206";
        continue;
      }

      // ë³´ë‚´ëŠ”ë¶„ ì „í™”ë²ˆí˜¸ ê³ ì •
      if (key === "ë³´ë‚´ëŠ”ë¶„ì „í™”ë²ˆí˜¸") {
        out[key] = "031-987-9495";
        continue;
      }

      // ì•ŒíŒŒ ì „ìš©: ë°œì£¼ì²˜ = ì•ˆì„±ë¬¼ë¥˜ â†’ ë³´ë‚´ëŠ”ë¶„ì„±ëª… = ì•ŒíŒŒ ì•ˆì„±
      if (selectedVendor === "ì•ŒíŒŒ" && key === "ë³´ë‚´ëŠ”ë¶„ì„±ëª…") {
        const purchaser = (row["ë°œì£¼ì²˜"] ?? "").toString().trim();
        out[key] = purchaser === "ì•ˆì„±ë¬¼ë¥˜" ? "ì•ŒíŒŒ ì•ˆì„±" : "";
        continue;
      }

      // ì•ŒíŒŒ ì „ìš©: ìˆ˜ë ¹ì ì •ë³´ ë§¤í•‘
      if (selectedVendor === "ì•ŒíŒŒ") {

        if (key === "ë°›ëŠ”ë¶„ì„±ëª…") {
          out[key] = row["ìˆ˜ë ¹ìëª…"] ?? "";
          continue;
        }

        if (key === "ë°›ëŠ”ë¶„ì£¼ì†Œ(ì „ì²´, ë¶„í• )") {
          out[key] = row["ìˆ˜ë ¹ì ì£¼ì†Œ"] ?? "";
          continue;
        }

        if (key === "ë°›ëŠ”ë¶„ì „í™”ë²ˆí˜¸") {
          const phone1 = (row["ìˆ˜ë ¹ì ì „í™”ë²ˆí˜¸"] ?? "").toString().trim();
          const phone2 = (row["ìˆ˜ë ¹ì íœ´ëŒ€ì „í™”"] ?? "").toString().trim();
          out[key] = phone1 || phone2 || "";
          continue;
        }

        if (key === "ë°›ëŠ”ë¶„ê¸°íƒ€ì—°ë½ì²˜") {
          out[key] = row["ìˆ˜ë ¹ì íœ´ëŒ€ì „í™”"] ?? "";
          continue;
        }
      }

      // ì¼ë°˜ ë§¤í•‘ ì²˜ë¦¬ (ì•ŒíŒŒì—¬ë„ ì—¬ê¸°ë¡œ ì˜¤ëŠ” í•­ëª© ìˆìŒ)
      const mappedHeader = mapping[key];

      if (!mappedHeader) {
        if (key === "ë°•ìŠ¤ìˆ˜ëŸ‰") out[key] = 1;
        else out[key] = "";
        continue;
      }

      const value = row[mappedHeader];

      if (key === "ë°•ìŠ¤ìˆ˜ëŸ‰") {
        const num = Number(value);
        out[key] = Number.isFinite(num) && num > 0 ? num : 1;
      } else {
        out[key] = value ?? "";
      }
    }

    return out;
  });

  return result;
}

    // ì›ë³¸ ë¯¸ë¦¬ë³´ê¸°
    function showPreviewTable(rows) {
      if (!rows || rows.length === 0) {
        previewEl.innerHTML = "<em>ë¯¸ë¦¬ë³´ê¸°í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</em>";
        return;
      }

      const maxRows = 10;
      const previewRows = rows.slice(0, maxRows);
      const keys = Object.keys(previewRows[0]);

      let html = "<div>ì›ë³¸ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (ìƒìœ„ " + previewRows.length + "í–‰)</div>";
      html += "<table><thead><tr>";
      for (const key of keys) {
        html += "<th>" + escapeHtml(key) + "</th>";
      }
      html += "</tr></thead><tbody>";

      for (const row of previewRows) {
        html += "<tr>";
        for (const key of keys) {
          html += "<td>" + escapeHtml(row[key]) + "</td>";
        }
        html += "</tr>";
      }

      html += "</tbody></table>";
      previewEl.innerHTML = html;
    }

    function escapeHtml(value) {
      if (value === null || value === undefined) return "";
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }
  </script>
</body>
</html>
