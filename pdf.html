<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF → 운송장 엑셀 변환 (OCR) - Debug</title>

  <style>
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:#0f172a; color:#e5e7eb; }
    .wrap { max-width: 1100px; margin:0 auto; padding:24px 16px 40px; }
    h1 { font-size:18px; margin:0 0 8px; }
    p { margin:0 0 14px; color:#cbd5f5; font-size:14px; line-height:1.5; }
    .card { background: rgba(15,23,42,.9); border:1px solid rgba(148,163,184,.35); border-radius:16px; padding:18px; box-shadow:0 20px 40px rgba(0,0,0,.25); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    input[type="file"]{ background:#020617; border:1px solid rgba(148,163,184,.5); color:#e5e7eb; padding:10px; border-radius:12px; }
    button{ background:#2563eb; color:#fff; border:0; border-radius:999px; padding:10px 18px; cursor:pointer; }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .btn-secondary{ background:#334155; }
    .pill{ display:inline-block; padding:2px 10px; border-radius:999px; background:rgba(37,99,235,.18); border:1px solid rgba(37,99,235,.35); font-size:12px; color:#cbd5f5; }
    .status{ margin-top:10px; font-size:13px; color:#a5b4fc; min-height:18px; white-space:pre-wrap; }
    .log{ margin-top:14px; padding:12px; background:#020617; border:1px solid rgba(148,163,184,.25); border-radius:12px; max-height:280px; overflow:auto; font-size:12px; color:#e5e7eb; white-space:pre-wrap; }
    .progress-wrap { margin-top:12px; }
    .bar { background:#1e293b; border-radius:999px; height:10px; overflow:hidden; border:1px solid rgba(148,163,184,.25); }
    .bar > div { height:100%; width:0%; background:#38bdf8; transition:width .2s; }
    .ptext { font-size:12px; color:#a5b4fc; margin-top:6px; }
    .warn { color:#fbbf24; }
    .err { color:#fb7185; }
    .ok { color:#86efac; }
    code { color:#e5e7eb; }
  </style>

  <!-- ✅ 중요한 변경점:
       외부 스크립트는 defer로 로드 → HTML 렌더링/JS 초기 로그는 즉시 출력 가능 -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.worker.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script defer src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
</head>

<body>
  <div class="wrap">
    <h1>PDF → 운송장(waybill) 엑셀 변환 (OCR) <span class="pill">Debug</span></h1>
    <p>
      지금처럼 “로그가 하나도 안 뜨고 0% 고정”이면 보통 <b>스크립트 로딩 실패</b> 또는 <b>JS 실행 실패</b>야.<br>
      아래 상태가 <span class="ok">OK</span>로 바뀌는지 확인해줘.
    </p>

    <div class="card">
      <div class="row">
        <input id="pdfFile" type="file" accept="application/pdf" />
        <button id="btnConvert" disabled>변환 실행</button>
        <button id="btnCancel" class="btn-secondary" disabled>취소</button>
        <span class="pill" id="libInfo">라이브러리: 확인 중...</span>
      </div>

      <div class="progress-wrap">
        <div class="bar"><div id="progressBar"></div></div>
        <div class="ptext" id="progressText">전체 진행률: 0%</div>
      </div>

      <div class="status" id="status"></div>
      <div class="log" id="log"></div>

      <p style="margin-top:12px; font-size:12px; color:#9ca3af; line-height:1.45;">
        ✅ 5초 안에 라이브러리가 OK가 안 되면, GitHub Pages에서 CDN이 막히거나 네트워크가 차단된 거야.<br>
        그 경우 해결책: <b>pdf.js / tesseract.js / xlsx를 레포에 직접 올려서 로컬 경로로 불러오기</b>가 가장 확실해.
      </p>
    </div>
  </div>

  <script>
    // ====== “JS가 실행되는지” 가장 먼저 확인하는 장치 ======
    const $ = (id) => document.getElementById(id);
    const logEl = $("log");
    const statusEl = $("status");
    const libInfoEl = $("libInfo");
    const btnConvert = $("btnConvert");
    const btnCancel = $("btnCancel");
    const pdfFile = $("pdfFile");
    const progressBarEl = $("progressBar");
    const progressTextEl = $("progressText");

    function log(msg, cls="") {
      const time = new Date().toLocaleTimeString();
      const line = `[${time}] ${msg}\n`;
      logEl.textContent += line;
      logEl.scrollTop = logEl.scrollHeight;
      if (cls) statusEl.innerHTML = `<span class="${cls}">${msg}</span>`;
      else statusEl.textContent = msg;
    }
    function setProgress(pct) {
      const v = Math.max(0, Math.min(100, pct));
      progressBarEl.style.width = v.toFixed(1) + "%";
      progressTextEl.textContent = `전체 진행률: ${v.toFixed(1)}%`;
    }

    // ✅ 전역 에러를 로그로 보여줌 (콘솔 안 봐도 됨)
    window.addEventListener("error", (e) => {
      log(`JS 에러: ${e.message}`, "err");
    });
    window.addEventListener("unhandledrejection", (e) => {
      log(`Promise 에러: ${e.reason?.message || e.reason}`, "err");
    });

    log("✅ 페이지 JS 시작됨 (이 로그가 안 뜨면 JS 자체가 실행 안 된 상태)", "ok");

    // ====== 라이브러리 로딩 체크 (5초 타임아웃) ======
    function checkLibs() {
      const okPdf = typeof window.pdfjsLib !== "undefined";
      const okTes = typeof window.Tesseract !== "undefined";
      const okXLSX = typeof window.XLSX !== "undefined";
      return { okPdf, okTes, okXLSX };
    }

    const start = Date.now();
    const timer = setInterval(() => {
      const { okPdf, okTes, okXLSX } = checkLibs();
      const elapsed = ((Date.now() - start) / 1000).toFixed(1);

      libInfoEl.textContent = `라이브러리: pdf.js=${okPdf?"OK":"NO"} / tesseract=${okTes?"OK":"NO"} / xlsx=${okXLSX?"OK":"NO"} (${elapsed}s)`;

      if (okPdf && okTes && okXLSX) {
        libInfoEl.className = "pill ok";
        log("✅ 라이브러리 로딩 완료", "ok");
        clearInterval(timer);

        // 이제부터 변환 로직을 연결
        wireApp();
      }

      // 5초 지나도 안 되면 거의 CDN 문제
      if (Date.now() - start > 5000 && !(okPdf && okTes && okXLSX)) {
        libInfoEl.className = "pill err";
        log("❌ 5초 내 라이브러리 로딩 실패: CDN 차단/네트워크 문제 가능성 큼", "err");
        clearInterval(timer);
      }
    }, 200);

    // ====== 실제 앱 연결 (라이브러리 로딩 후 실행) ======
    function wireApp() {
      // pdf.js worker 설정
      // (workerSrc를 명시하지 않으면 일부 환경에서 멈추는 경우가 있음)
      window.pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.worker.min.js";

      let cancelRequested = false;

      pdfFile.addEventListener("change", () => {
        const file = pdfFile.files?.[0];
        btnConvert.disabled = !file;
        log(file ? `PDF 선택됨: ${file.name}` : "PDF 선택 해제");
      });

      btnCancel.addEventListener("click", () => {
        cancelRequested = true;
        btnCancel.disabled = true;
        log("취소 요청됨", "warn");
      });

      btnConvert.addEventListener("click", async () => {
        const file = pdfFile.files?.[0];
        if (!file) return;

        cancelRequested = false;
        btnConvert.disabled = true;
        btnCancel.disabled = false;
        setProgress(1);
        log("변환 시작", "ok");

        try {
          log("PDF 로딩 중...");
          const buf = await file.arrayBuffer();
          setProgress(5);

          const pdf = await window.pdfjsLib.getDocument({ data: buf }).promise;
          log(`PDF 페이지 수: ${pdf.numPages}`);
          setProgress(10);

          // 1페이지만 OCR 테스트(문제 원인 파악용) — 필요하면 all로 확장 가능
          const pageNo = 1;
          log(`페이지 ${pageNo} 렌더링...`);
          const page = await pdf.getPage(pageNo);
          const viewport = page.getViewport({ scale: 2.0 });

          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = Math.floor(viewport.width);
          canvas.height = Math.floor(viewport.height);
          await page.render({ canvasContext: ctx, viewport }).promise;
          setProgress(20);

          if (cancelRequested) throw new Error("사용자가 취소했습니다.");

          log("OCR 시작(1페이지)...");
          const result = await window.Tesseract.recognize(canvas, "kor+eng", {
            logger: (m) => {
              if (typeof m.progress === "number") {
                // 20~90 구간에서 진행률 반영
                setProgress(20 + 70 * m.progress);
              }
            }
          });

          if (cancelRequested) throw new Error("사용자가 취소했습니다.");

          const text = result?.data?.text || "";
          log(`OCR 완료. 텍스트 길이: ${text.length}`);
          setProgress(90);

          // 아주 단순 waybill 1행 생성(테스트용)
          const row = {
            "받는분성명": "",
            "받는분주소(전체, 분할)": "",
            "받는분전화번호": "",
            "받는분기타연락처": "",
            "품목명": "",
            "수량": ""
          };

          const ws = window.XLSX.utils.json_to_sheet([row]);
          const wb = window.XLSX.utils.book_new();
          window.XLSX.utils.book_append_sheet(wb, ws, "waybill");
          window.XLSX.writeFile(wb, file.name.replace(/\.pdf$/i, "") + "_waybill.xlsx");

          setProgress(100);
          log("완료! 엑셀 다운로드 시작", "ok");
        } catch (e) {
          log(`오류: ${e?.message || e}`, "err");
        } finally {
          btnConvert.disabled = false;
          btnCancel.disabled = true;
        }
      });
    }
  </script>
</body>
</html>
