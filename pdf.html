<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>OCR 테스트</title>

  <!-- tesseract / xlsx는 일반 script -->
  <script defer src="./libs/tesseract/tesseract.js"></script>
  <script defer src="./libs/xlsx/xlsx.full.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .log { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; height: 200px; overflow: auto; }
  </style>
</head>

<body>
  <h2>라이브러리 로드 테스트</h2>
  <input type="file" id="pdfFile" accept="application/pdf">
  <button id="btnTest">OCR 테스트</button>

  <div class="log" id="log"></div>

  <!-- pdf.js는 ESM -->
  <script type="module">
    import * as pdfjsLib from "./libs/pdfjs/pdf.mjs";

    // pdf.js worker 설정 (ESM 방식)
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      new URL("./pdf.worker.mjs", import.meta.url).toString();

    const logEl = document.getElementById("log");
    const btn = document.getElementById("btnTest");
    const input = document.getElementById("pdfFile");

    function log(msg) {
      logEl.textContent += msg + "\n";
    }

    // 라이브러리 확인
    log("pdfjsLib: " + (pdfjsLib ? "OK" : "FAIL"));
    log("Tesseract: " + (window.Tesseract ? "OK" : "FAIL"));
    log("XLSX: " + (window.XLSX ? "OK" : "FAIL"));

    btn.onclick = async () => {
      if (!input.files[0]) {
        alert("PDF 선택");
        return;
      }

      log("PDF 로딩...");
      const buf = await input.files[0].arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;

      log("페이지 수: " + pdf.numPages);

      const page = await pdf.getPage(1);
      const viewport = page.getViewport({ scale: 2.0 });

      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      canvas.width = viewport.width;
      canvas.height = viewport.height;

      await page.render({ canvasContext: ctx, viewport }).promise;
      log("OCR 시작...");

      const result = await window.Tesseract.recognize(canvas, "kor+eng");
      log("OCR 완료");
      log(result.data.text.slice(0, 300));
    };
  </script>
</body>
</html>
