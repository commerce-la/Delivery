<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>알파 Waybill 변환</title>

  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, sans-serif; background:#0f172a; color:#e5e7eb; }
    main { max-width: 980px; margin: 0 auto; padding: 24px 16px 40px; }
    .card { background: rgba(15,23,42,.9); border: 1px solid rgba(148,163,184,.35); border-radius: 16px; padding: 18px; margin-bottom: 16px; }
    h1 { font-size: 18px; margin: 0 0 8px; }
    p { margin: 0 0 10px; color:#cbd5f5; font-size: 13px; line-height: 1.5; }
    label { display:block; font-size: 12px; margin: 12px 0 6px; }
    input[type="file"]{ width:100%; padding:10px; background:#020617; color:#e5e7eb; border:1px solid rgba(148,163,184,.6); border-radius:10px; }
    button{ margin-top:14px; padding:10px 16px; border:0; border-radius:9999px; background:#2563eb; color:#fff; cursor:pointer; }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .status{ margin-top:10px; font-size:12px; color:#a5b4fc; white-space:pre-wrap; }
    table{ border-collapse:collapse; width:100%; font-size:12px; margin-top:12px; }
    th,td{ border:1px solid rgba(148,163,184,.5); padding:4px 6px; white-space:nowrap; }
    th{ background:rgba(37,99,235,.25); }
  </style>
</head>

<body>
<main>
  <h1>알파 Waybill 변환</h1>
  <p>공통 품목 파일 + 알파 주문 파일 → waybill.xlsx 생성</p>

  <div class="card">
    <label>1. 공통 품목 파일 (erp_goods.xlsx)</label>
    <input id="goodsFile" type="file" accept=".xlsx,.xls" />

    <label>2. 알파 주문 파일</label>
    <input id="orderFile" type="file" accept=".xlsx,.xls" />

    <button id="convertBtn" disabled>waybill.xlsx 생성</button>
    <div id="status" class="status"></div>
    <div id="preview"></div>
  </div>
</main>

<script>
const SENDER_ADDR  = "경기도 김포시 애기봉로 206";
const SENDER_PHONE = "031-987-9495";

let alphaMap = new Map();
let nameToCarton = new Map();
let orderRows = [];

const goodsFile = document.getElementById("goodsFile");
const orderFile = document.getElementById("orderFile");
const convertBtn = document.getElementById("convertBtn");
const statusEl = document.getElementById("status");
const previewEl = document.getElementById("preview");

goodsFile.onchange = async e => {
  alphaMap.clear();
  nameToCarton.clear();
  const rows = await readExcel(e.target.files[0]);

  rows.forEach(r => {
    const codes = String(r["알파 상품코드"] || "").split(",");
    codes.forEach(c => {
      c = norm(c);
      if (c) alphaMap.set(c, r);
    });
  });

  alphaMap.forEach(v => {
    nameToCarton.set(v["품목명"], num(v["최대수량"]));
  });

  status("품목 파일 로드 완료");
  toggle();
};

orderFile.onchange = async e => {
  orderRows = await readExcel(e.target.files[0]);
  status("주문 파일 로드 완료");
  toggle();
};

convertBtn.onclick = () => {
  const out = [];

  orderRows.forEach(r => {
    const orderQty = num(r["주문량"]);
    if (!orderQty) return;

    const goods = alphaMap.get(norm(r["상품코드"])) || {};
    const name = goods["품목명"] || r["상품명"];
    const carton = num(goods["최대수량"]);
    const fare = goods["최대운임"] || "";
    const units = num(r["입수"]);

    const isSpecial = name.includes("시트지");
    const qty = isSpecial ? orderQty : orderQty * units;

    const mainQty = carton && qty > carton ? carton : qty;
    const boxQty = carton && qty > carton ? Math.floor(qty / carton) : 1;
    const remainder = carton && qty > carton ? qty - carton * boxQty : 0;

    const base = makeRow(r, name, mainQty, boxQty, fare);
    out.push(base);
    if (remainder) out.push(makeRow(r, name, remainder, 1, fare));
  });

  out.sort((a,b)=>String(a["받는분성명"]).localeCompare(b["받는분성명"],"ko"));

  download(out);
};

function makeRow(r, name, qty, box, fare){
  return {
    "받는분성명": r["수령자명"],
    "받는분주소(전체, 분할)": r["수령자 주소"],
    "받는분전화번호": r["수령자 전화번호"] || r["수령자 휴대전화"],
    "받는분기타연락처": r["수령자 휴대전화"],
    "품목명": `${name} - ${qty}EA`,
    "박스수량": box,
    "기본운임": fare,
    "운임구분": "",
    "보내는분성명": r["발주처"] === "안성물류" ? "알파 안성" : "",
    "보내는분주소(전체, 분할)": SENDER_ADDR,
    "보내는분전화번호": SENDER_PHONE,
    "배송메세지1": r["요청메모"] || "",
    "주문번호": r["주문번호"] || ""
  };
}

function download(rows){
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "waybill");
  XLSX.writeFile(wb, "waybill.xlsx");
  status(`완료! (${rows.length}행 생성)`);
}

function toggle(){ convertBtn.disabled = !(alphaMap.size && orderRows.length); }
function status(t){ statusEl.textContent = t; }
function norm(x){ return x ? String(x).replace(/\.0$/,"").trim() : ""; }
function num(x){ return Number(String(x||0).replace(/,/g,""))||0; }

async function readExcel(file){
  const buf = await file.arrayBuffer();
  const wb = XLSX.read(buf);
  return XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {defval:""});
}
</script>
</body>
</html>
7
