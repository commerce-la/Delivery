<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>운송장 변환</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SheetJS (브라우저용) -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      line-height: 1.5;
    }

    main {
      max-width: 1040px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    .title {
      font-size: 18px;
      margin: 0 0 8px;
    }

    .subtitle {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 18px;
    }

    .card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.4);
      margin-bottom: 24px;
    }

    .card h2 {
      margin-top: 0;
      font-size: 20px;
      margin-bottom: 8px;
    }

    .card p {
      margin-top: 0;
      margin-bottom: 16px;
      color: #cbd5f5;
      font-size: 14px;
    }

    .file-input {
      margin: 8px 0 16px;
    }

    input[type="file"],
    select {
      font-size: 14px;
    }

    button {
      margin-top: 16px;
      padding: 10px 20px;
      border-radius: 9999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      background: #2563eb;
      color: #f9fafb;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status {
      margin-top: 8px;
      font-size: 13px;
      color: #a5b4fc;
      min-height: 18px;
    }

    .preview {
      margin-top: 24px;
      font-size: 13px;
      color: #e5e7eb;
      max-height: 260px;
      overflow: auto;
      border-top: 1px solid rgba(148, 163, 184, 0.4);
      padding-top: 16px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 12px;
      background: rgba(15, 23, 42, 0.9);
    }

    th, td {
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 4px 6px;
      white-space: nowrap;
    }

    th {
      background: rgba(37, 99, 235, 0.3);
    }

    .mapping {
      margin-top: 16px;
      font-size: 13px;
    }

    .mapping-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px 16px;
      margin-top: 12px;
    }

    .mapping-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .mapping-item label {
      font-size: 12px;
      color: #e5e7eb;
    }

    .mapping-item select {
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
    }

    .mapping-hint {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .section-title {
      font-size: 16px;
      margin-top: 0;
      margin-bottom: 8px;
    }

    .sub-status {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
      min-height: 16px;
    }
  </style>
</head>
<body>
  <main>
    <h1 class="title">운송장 변환</h1>
    <p class="subtitle">알파 전용 규칙을 사용하여 주문 엑셀을 택배사 waybill 형식으로 변환합니다.</p>

    <!-- 1. 업체명 선택 -->
    <div class="card">
      <h2>1. 업체명 선택</h2>
      <p>먼저 어떤 업체의 규칙을 사용할지 선택해 주세요. (현재는 알파 전용 규칙이 적용됩니다.)</p>

      <div class="mapping-item" style="max-width: 260px;">
        <label for="vendor-select">업체명</label>
        <select id="vendor-select">
          <option value="">선택하세요</option>
          <option value="알파">알파</option>
        </select>
        <div class="mapping-hint">
          * "알파" 선택 시 알파 전용 변환 규칙이 적용됩니다.
        </div>
      </div>
      <div class="status" id="status-vendor"></div>
    </div>

    <!-- 2. 파일 업로드 (품목 파일 + 주문 파일) -->
    <div class="card">
      <h2>2. 품목 파일 & 주문 파일 업로드</h2>
      <p>
        <strong>품목 파일</strong>에는 상품코드, 품목명, 입수, 상품분류1, 기본, 카톤, 운임 등의 상품 정보가 들어 있고,<br />
        <strong>주문 파일</strong>에는 실제 출고할 주문 내역이 들어 있습니다.
      </p>

      <h3 class="section-title">2-1. 품목 파일 업로드 (알파 상품 마스터)</h3>
      <div class="file-input">
        <input type="file" id="file-input-items" accept=".xlsx,.xls" />
      </div>
      <div class="sub-status" id="status-items">품목 파일을 업로드해 주세요.</div>

      <h3 class="section-title" style="margin-top:20px;">2-2. 주문 파일 업로드</h3>
      <div class="file-input">
        <input type="file" id="file-input-orders" accept=".xlsx,.xls" />
      </div>
      <div class="sub-status" id="status-orders">주문 파일을 업로드해 주세요.</div>

      <div class="mapping" id="mapping">
        주문 파일을 업로드하면 열 매핑 옵션이 여기에 표시됩니다.
      </div>
    </div>

    <!-- 3. 미리보기 & 변환 실행 -->
    <div class="card">
      <h2>3. 미리보기 & 변환 실행</h2>
      <p>
        주문 파일의 상위 몇 행을 미리 보여줍니다. 업체명/파일 업로드/매핑을 확인한 뒤,<br />
        <strong>엑셀 변환하기</strong>를 누르면 waybill 형식으로 변환된 엑셀이 다운로드됩니다.
      </p>

      <button id="convert-btn" disabled>엑셀 변환하기 (waybill.xlsx)</button>

      <div class="status" id="status-convert"></div>

      <div class="preview" id="preview"></div>
    </div>
  </main>

  <script>
    // (선택 사항) 로그인 체크: iframe 단독 호출 막고 싶으면 사용
    if (window.top === window.self) {
      // 직접 접근 시 메인으로 돌려보내기
      if (sessionStorage.getItem("loggedIn") === "true") {
        window.location.href = "main.html";
      } else {
        window.location.href = "index.html";
      }
    }

    const vendorSelect      = document.getElementById("vendor-select");
    const statusVendorEl    = document.getElementById("status-vendor");

    const fileInputItems    = document.getElementById("file-input-items");
    const fileInputOrders   = document.getElementById("file-input-orders");
    const statusItemsEl     = document.getElementById("status-items");
    const statusOrdersEl    = document.getElementById("status-orders");

    const convertBtn        = document.getElementById("convert-btn");
    const statusConvertEl   = document.getElementById("status-convert");
    const previewEl         = document.getElementById("preview");
    const mappingEl         = document.getElementById("mapping");

    let selectedVendor = "";
    let itemRows  = [];   // 품목 파일
    let orderRows = [];   // 주문 파일
    let orderHeaders = [];

    const WAYBILL_FIELDS = [
      { key: "받는분성명",               label: "받는분 성명" },
      { key: "받는분주소(전체, 분할)",    label: "받는분 주소(전체, 분할)" },
      { key: "받는분전화번호",           label: "받는분 전화번호" },
      { key: "받는분기타연락처",         label: "받는분 기타 연락처" },
      { key: "품목명",                  label: "품목명" },
      { key: "박스수량",                label: "박스 수량" },
      { key: "기본운임",                label: "기본 운임" },
      { key: "운임구분",                label: "운임 구분" },
      { key: "보내는분성명",            label: "보내는분 성명" },
      { key: "보내는분주소(전체, 분할)", label: "보내는분 주소(전체, 분할)" },
      { key: "보내는분전화번호",        label: "보내는분 전화번호" },
      { key: "배송메세지1",             label: "배송 메세지 1" },
      { key: "기타1",                   label: "기타1" }
    ];

    const alphaGoodsByCode = new Map();
    let alphaGoodsLoaded   = false;

    vendorSelect.addEventListener("change", (e) => {
      selectedVendor = e.target.value;
      if (!selectedVendor) {
        statusVendorEl.textContent = "업체명을 선택해 주세요.";
      } else {
        statusVendorEl.textContent = `선택된 업체: ${selectedVendor}`;
      }
      updateConvertButtonState();
    });

    fileInputItems.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      alphaGoodsByCode.clear();
      alphaGoodsLoaded = false;

      if (!file) {
        statusItemsEl.textContent = "품목 파일을 다시 선택해 주세요.";
        updateConvertButtonState();
        return;
      }

      try {
        statusItemsEl.textContent = "품목 파일 읽는 중...";
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];

        itemRows = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

        if (!itemRows || itemRows.length === 0) {
          statusItemsEl.textContent = `품목 시트("${firstSheetName}")에 데이터가 없습니다.`;
          updateConvertButtonState();
          return;
        }

        for (const row of itemRows) {
          const code      = (row["상품코드"]   ?? "").toString().trim();
          const itemName  = (row["품목명"]     ?? "").toString().trim();
          const units     = row["입수"];
          const cat1      = (row["상품분류1"]  ?? "").toString().trim();
          const basicFare = row["기본"];
          const carton    = row["카톤"];
          const fareShip  = row["운임"];

          if (!code) continue;

          alphaGoodsByCode.set(code, {
            상품코드:   code,
            품목명:     itemName,
            입수:       units,
            상품분류1:  cat1,
            기본:       basicFare,
            카톤:       carton,
            운임:       fareShip
          });
        }

        alphaGoodsLoaded = alphaGoodsByCode.size > 0;
        statusItemsEl.textContent =
          `품목 파일(${firstSheetName})에서 ${itemRows.length}행, 상품코드 ${alphaGoodsByCode.size}개를 읽었습니다.`;
      } catch (err) {
        console.error(err);
        statusItemsEl.textContent = "품목 파일을 읽는 중 오류가 발생했습니다.";
      }

      updateConvertButtonState();
    });

    fileInputOrders.addEventListener("change", async (e) => {
      const file = e.target.files[0];

      if (!file) {
        statusOrdersEl.textContent = "주문 파일을 다시 선택해 주세요.";
        orderRows = [];
        orderHeaders = [];
        mappingEl.textContent = "주문 파일을 업로드하면 열 매핑 옵션이 여기에 표시됩니다.";
        previewEl.innerHTML = "";
        updateConvertButtonState();
        return;
      }

      try {
        statusOrdersEl.textContent = "주문 파일 읽는 중...";
        previewEl.innerHTML = "";
        mappingEl.textContent = "(열 정보를 분석하는 중입니다...)";

        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];

        orderRows = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

        if (!orderRows || orderRows.length === 0) {
          statusOrdersEl.textContent = `주문 시트("${firstSheetName}")에 데이터가 없습니다.`;
          mappingEl.textContent = "매핑을 할 주문 데이터가 없습니다.";
          orderHeaders = [];
          updateConvertButtonState();
          return;
        }

        orderHeaders = Object.keys(orderRows[0]);
        statusOrdersEl.textContent =
          `주문 시트("${firstSheetName}")에서 ${orderRows.length}개의 행을 읽었습니다.`;

        showPreviewTable(orderRows);
        buildMappingUI(orderHeaders);
      } catch (err) {
        console.error(err);
        statusOrdersEl.textContent = "주문 파일을 읽는 중 오류가 발생했습니다.";
        mappingEl.textContent = "매핑을 생성할 수 없습니다.";
      }

      updateConvertButtonState();
    });

    convertBtn.addEventListener("click", () => {
      statusConvertEl.textContent = "";

      if (!selectedVendor) {
        statusConvertEl.textContent = "먼저 업체명을 선택해 주세요.";
        return;
      }

      if (!orderRows || orderRows.length === 0) {
        statusConvertEl.textContent = "먼저 주문 파일을 업로드해 주세요.";
        return;
      }

      if (selectedVendor === "알파" && !alphaGoodsLoaded) {
        statusConvertEl.textContent = "알파 품목 파일(상품 마스터)을 먼저 업로드해 주세요.";
        return;
      }

      const mapping = getMapping();
      if (!mapping) {
        statusConvertEl.textContent = "열 매핑을 읽어오는 중 문제가 발생했습니다.";
        return;
      }

      try {
        statusConvertEl.textContent = "규칙을 적용하는 중...";

        let transformedRows = applyRules(orderRows, mapping);

        transformedRows.sort((a, b) => {
          const nameA = (a["받는분성명"] ?? "").toString().trim();
          const nameB = (b["받는분성명"] ?? "").toString().trim();
          return nameA.localeCompare(nameB, "ko");
        });

        const cleanedRows = transformedRows.map(row => {
          const copy = { ...row };
          delete copy["_internal_qty"];
          return copy;
        });

        const newWorksheet = XLSX.utils.json_to_sheet(cleanedRows);
        const newWorkbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, "waybill");

        XLSX.writeFile(newWorkbook, "waybill.xlsx", { compression: true });

        statusConvertEl.textContent =
          `변환 완료! 총 ${cleanedRows.length}개의 행이 waybill.xlsx에 포함되었습니다.`;
      } catch (err) {
        console.error(err);
        statusConvertEl.textContent = "변환 중 오류가 발생했습니다.";
      }
    });

    function updateConvertButtonState() {
      let enable = !!selectedVendor && orderRows.length > 0;
      if (selectedVendor === "알파") {
        enable = enable && alphaGoodsLoaded;
      }
      convertBtn.disabled = !enable;
    }

    function buildMappingUI(headers) {
      if (!headers || headers.length === 0) {
        mappingEl.textContent = "주문 파일의 컬럼을 찾을 수 없습니다.";
        return;
      }

      let html = "";
      html += `<div class="mapping-hint">`;
      html += `각 waybill 항목에 대해, 어떤 <strong>주문 파일의 열</strong>을 사용할지 선택하세요. `;
      html += `선택하지 않은 항목은 빈 값으로 들어갑니다.`;
      html += `</div>`;

      html += `<div class="mapping-grid">`;

      for (const field of WAYBILL_FIELDS) {
        html += `<div class="mapping-item">`;
        html += `<label for="map-${field.key}">waybill: ${field.key}</label>`;
        html += `<select id="map-${field.key}" data-field="${field.key}">`;
        html += `<option value="">(비워두기)</option>`;

        for (const h of headers) {
          html += `<option value="${escapeHtml(h)}">${escapeHtml(h)}</option>`;
        }

        html += `</select>`;
        html += `</div>`;
      }

      html += `</div>`;
      mappingEl.innerHTML = html;
    }

    function getMapping() {
      const mapping = {};
      for (const field of WAYBILL_FIELDS) {
        const select = document.querySelector(`select[data-field="${field.key}"]`);
        if (!select) continue;
        const value = select.value;
        mapping[field.key] = value || null;
      }
      return mapping;
    }

    function toNumberOrZero(value) {
      if (value === null || value === undefined) return 0;
      if (value === "") return 0;
      const num = Number(String(value).replace(/,/g, "").trim() || "0");
      return Number.isFinite(num) ? num : 0;
    }

    function applyRules(rows, mapping) {
      let workingRows = [...rows];

      if (selectedVendor === "알파") {
        workingRows = workingRows.map((row) => {
          const purchaser = (row["발주처"] ?? "").toString().trim();
          const receiver  = (row["수령자명"] ?? "").toString().trim();

          if (purchaser === "안성물류" && receiver === "안성물류") {
            return { ...row, 주문량: 0 };
          }
          return row;
        });
      }

      if (selectedVendor === "알파") {
        workingRows = workingRows.filter((row) => {
          const raw = row["주문량"];
          if (raw === null || raw === undefined || raw === "") return false;
          const num = toNumberOrZero(raw);
          return num !== 0;
        });
      }

      const result = workingRows.map((row) => {
        const out = {};
        let internalQty = 0;

        if (selectedVendor === "알파") {
          const orderQty = toNumberOrZero(row["주문량"]);
          let unitsPerBox = 0;
          let isArtMate   = false;

          const code = (row["상품코드"] ?? "").toString().trim();
          if (code && alphaGoodsByCode.has(code)) {
            const goods = alphaGoodsByCode.get(code);
            unitsPerBox = toNumberOrZero(goods.입수);
            if (goods.상품분류1 === "아트메이트") {
              isArtMate = true;
            }
          }

          internalQty = isArtMate ? orderQty : unitsPerBox * orderQty;
        } else {
          internalQty = toNumberOrZero(row["주문량"] ?? row["수량"]);
        }

        let adjustedQty = internalQty;
        let boxQty = 1;

        if (selectedVendor === "알파") {
          const code = (row["상품코드"] ?? "").toString().trim();
          if (code && alphaGoodsByCode.has(code)) {
            const goods = alphaGoodsByCode.get(code);
            const carton = toNumberOrZero(goods.카톤);

            if (carton > 0 && internalQty > carton) {
              boxQty = Math.floor(internalQty / carton);
              adjustedQty = carton;
            }
          }
        }

        for (const field of WAYBILL_FIELDS) {
          const key = field.key;

          if (key === "보내는분주소(전체, 분할)") {
            out[key] = "경기도 김포시 애기봉로 206";
            continue;
          }

          if (key === "보내는분전화번호") {
            out[key] = "031-987-9495";
            continue;
          }

          if (selectedVendor === "알파" && key === "보내는분성명") {
            const purchaser = (row["발주처"] ?? "").toString().trim();
            out[key] = purchaser === "안성물류" ? "알파 안성" : "";
            continue;
          }

          if (selectedVendor === "알파") {
            if (key === "받는분성명") {
              out[key] = row["수령자명"] ?? "";
              continue;
            }

            if (key === "받는분주소(전체, 분할)") {
              out[key] = row["수령자 주소"] ?? "";
              continue;
            }

            if (key === "받는분전화번호") {
              const phone1 = (row["수령자 전화번호"] ?? "").toString().trim();
              const phone2 = (row["수령자 휴대전화"] ?? "").toString().trim();
              out[key] = phone1 || phone2 || "";
              continue;
            }

            if (key === "받는분기타연락처") {
              out[key] = row["수령자 휴대전화"] ?? "";
              continue;
            }
          }

          if (selectedVendor === "알파" && key === "기본운임") {
            let value = "";

            const code = (row["상품코드"] ?? "").toString().trim();
            if (code && alphaGoodsByCode.has(code)) {
              const goods      = alphaGoodsByCode.get(code);
              const cartonNum  = toNumberOrZero(goods.카톤);
              const basicFare  = goods.기본;
              const shipFare   = goods.운임;

              const qtyForFare = toNumberOrZero(adjustedQty);

              if (
                cartonNum > 0 &&
                qtyForFare === cartonNum &&
                shipFare !== undefined &&
                shipFare !== null &&
                shipFare !== ""
              ) {
                value = shipFare;
              } else if (
                basicFare !== undefined &&
                basicFare !== null &&
                basicFare !== ""
              ) {
                value = basicFare;
              }
            }

            if (!value) {
              const mappedHeader = mapping[key];
              if (mappedHeader) {
                value = row[mappedHeader] ?? "";
              }
            }

            out[key] = value;
            continue;
          }

          if (selectedVendor === "알파" && key === "품목명") {
            let baseName = "";
            const code = (row["상품코드"] ?? "").toString().trim();

            if (code && alphaGoodsByCode.has(code)) {
              const goods = alphaGoodsByCode.get(code);
              if (goods && goods.품목명) {
                baseName = goods.품목명;
              }
            }

            if (!baseName) {
              const mappedHeaderForItem = mapping[key];
              if (mappedHeaderForItem) {
                baseName = row[mappedHeaderForItem] ?? "";
              }
            }

            out[key] = `${baseName} - ${adjustedQty}EA`;
            continue;
          }

          if (selectedVendor === "알파" && key === "박스수량") {
            out[key] = boxQty;
            continue;
          }

          const mappedHeader = mapping[key];

          if (!mappedHeader) {
            if (key === "박스수량") {
              out[key] = 1;
            } else {
              out[key] = "";
            }
            continue;
          }

          const value = row[mappedHeader];

          if (key === "박스수량") {
            const num = Number(value);
            out[key] = Number.isFinite(num) && num > 0 ? num : 1;
          } else {
            out[key] = value ?? "";
          }
        }

        out["_internal_qty"] = internalQty;
        return out;
      });

      return result;
    }

    function showPreviewTable(rows) {
      if (!rows || rows.length === 0) {
        previewEl.innerHTML = "<em>미리보기할 데이터가 없습니다.</em>";
        return;
      }

      const maxRows = 10;
      const previewRows = rows.slice(0, maxRows);
      const keys = Object.keys(previewRows[0]);

      let html = "<div>주문 데이터 미리보기 (상위 " + previewRows.length + "행)</div>";
      html += "<table><thead><tr>";
      for (const key of keys) {
        html += "<th>" + escapeHtml(key) + "</th>";
      }
      html += "</tr></thead><tbody>";

      for (const row of previewRows) {
        html += "<tr>";
        for (const key of keys) {
          html += "<td>" + escapeHtml(row[key]) + "</td>";
        }
        html += "</tr>";
      }

      html += "</tbody></table>";
      previewEl.innerHTML = html;
    }

    function escapeHtml(value) {
      if (value === null || value === undefined) return "";
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&quot;");
    }
  </script>
</body>
</html>
