<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ìš´ì†¡ì¥ ë³€í™˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SheetJS (ë¸Œë¼ìš°ì €ìš©) -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      line-height: 1.5;
    }

    main {
      max-width: 1040px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    .title {
      font-size: 18px;
      margin: 0 0 8px;
    }

    .subtitle {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 18px;
    }

    .card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.4);
      margin-bottom: 24px;
    }

    .card h2 {
      margin-top: 0;
      font-size: 20px;
      margin-bottom: 8px;
    }

    .card p {
      margin-top: 0;
      margin-bottom: 16px;
      color: #cbd5f5;
      font-size: 14px;
    }

    .file-input {
      margin: 8px 0 16px;
    }

    input[type="file"],
    select {
      font-size: 14px;
    }

    button {
      margin-top: 16px;
      padding: 10px 20px;
      border-radius: 9999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      background: #2563eb;
      color: #f9fafb;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status {
      margin-top: 8px;
      font-size: 13px;
      color: #a5b4fc;
      min-height: 18px;
    }

    .preview {
      margin-top: 24px;
      font-size: 13px;
      color: #e5e7eb;
      max-height: 260px;
      overflow: auto;
      border-top: 1px solid rgba(148, 163, 184, 0.4);
      padding-top: 16px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 12px;
      background: rgba(15, 23, 42, 0.9);
    }

    th, td {
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 4px 6px;
      white-space: nowrap;
    }

    th {
      background: rgba(37, 99, 235, 0.3);
    }

    .mapping {
      margin-top: 16px;
      font-size: 13px;
    }

    .mapping-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px 16px;
      margin-top: 12px;
    }

    .mapping-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .mapping-item label {
      font-size: 12px;
      color: #e5e7eb;
    }

    .mapping-item select {
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
    }

    .mapping-hint {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .section-title {
      font-size: 16px;
      margin-top: 0;
      margin-bottom: 8px;
    }

    .sub-status {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
      min-height: 16px;
    }
  </style>
</head>
<body>
  <main>
    <h1 class="title">ìš´ì†¡ì¥ ë³€í™˜</h1>
    <p class="subtitle">ì•ŒíŒŒ / ë„¤ì´ë²„ ì „ìš© ê·œì¹™ì„ ì‚¬ìš©í•˜ì—¬ ì£¼ë¬¸ ì—‘ì…€ì„ íƒë°°ì‚¬ waybill í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.</p>

    <!-- 1. ì—…ì²´ëª… ì„ íƒ -->
    <div class="card">
      <h2>1. ì—…ì²´ëª… ì„ íƒ</h2>
      <p>ë¨¼ì € ì–´ë–¤ ì—…ì²´ì˜ ê·œì¹™ì„ ì‚¬ìš©í• ì§€ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>

      <div class="mapping-item" style="max-width: 260px;">
        <label for="vendor-select">ì—…ì²´ëª…</label>
        <select id="vendor-select">
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          <option value="ì•ŒíŒŒ">ì•ŒíŒŒ</option>
          <option value="ì˜¤í”¼ìŠ¤ë””í¬">ì˜¤í”¼ìŠ¤ë””í¬</option>7
          <option value="ë„¤ì´ë²„">ë„¤ì´ë²„</option>
        </select>
        <div class="mapping-hint">
          * "ì•ŒíŒŒ" ì„ íƒ ì‹œ ì•ŒíŒŒ ì „ìš© ê·œì¹™, "ë„¤ì´ë²„" ì„ íƒ ì‹œ ë„¤ì´ë²„ ì „ìš© ê·œì¹™ì´ ì ìš©ë©ë‹ˆë‹¤.
        </div>
      </div>
      <div class="status" id="status-vendor"></div>
    </div>

    <!-- 2. íŒŒì¼ ì—…ë¡œë“œ (í’ˆëª© íŒŒì¼ + ì£¼ë¬¸ íŒŒì¼) -->
    <div class="card">
      <h2>2. í’ˆëª© íŒŒì¼ & ì£¼ë¬¸ íŒŒì¼ ì—…ë¡œë“œ</h2>
      <p>
        <strong>í’ˆëª© íŒŒì¼</strong>ì—ëŠ” ìƒí’ˆì½”ë“œ, í’ˆëª©ëª…, ì…ìˆ˜, ìƒí’ˆë¶„ë¥˜1, ê¸°ë³¸, ì¹´í†¤, ìš´ì„ ë“±ì˜ ìƒí’ˆ ì •ë³´ê°€ ë“¤ì–´ ìˆê³ ,<br />
        <strong>ì£¼ë¬¸ íŒŒì¼</strong>ì—ëŠ” ì‹¤ì œ ì¶œê³ í•  ì£¼ë¬¸ ë‚´ì—­ì´ ë“¤ì–´ ìˆìŠµë‹ˆë‹¤.
      </p>

      <h3 class="section-title">2-1. í’ˆëª© íŒŒì¼ ì—…ë¡œë“œ (ì•ŒíŒŒ ìƒí’ˆ ë§ˆìŠ¤í„°)</h3>
      <div class="file-input">
        <input type="file" id="file-input-items" accept=".xlsx,.xls" />
      </div>
      <div class="sub-status" id="status-items">í’ˆëª© íŒŒì¼ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”. (ì•ŒíŒŒ ì „ìš© ê·œì¹™ì— í•„ìš”)</div>

      <h3 class="section-title" style="margin-top:20px;">2-2. ì£¼ë¬¸ íŒŒì¼ ì—…ë¡œë“œ</h3>
      <div class="file-input">
        <input type="file" id="file-input-orders" accept=".xlsx,.xls" />
      </div>
      <div class="sub-status" id="status-orders">ì£¼ë¬¸ íŒŒì¼ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.</div>

      <div class="mapping" id="mapping">
        ì£¼ë¬¸ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ì—´ ë§¤í•‘ ì˜µì…˜ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
      </div>
    </div>

    <!-- 3. ë¯¸ë¦¬ë³´ê¸° & ë³€í™˜ ì‹¤í–‰ -->
    <div class="card">
      <h2>3. ë¯¸ë¦¬ë³´ê¸° & ë³€í™˜ ì‹¤í–‰</h2>
      <p>
        ì£¼ë¬¸ íŒŒì¼ì˜ ìƒìœ„ ëª‡ í–‰ì„ ë¯¸ë¦¬ ë³´ì—¬ì¤ë‹ˆë‹¤. ì—…ì²´ëª…/íŒŒì¼ ì—…ë¡œë“œ/ë§¤í•‘ì„ í™•ì¸í•œ ë’¤,<br />
        <strong>ì—‘ì…€ ë³€í™˜í•˜ê¸°</strong>ë¥¼ ëˆ„ë¥´ë©´ waybill í˜•ì‹ìœ¼ë¡œ ë³€í™˜ëœ ì—‘ì…€ì´ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.
      </p>

      <button id="convert-btn" disabled>ì—‘ì…€ ë³€í™˜í•˜ê¸° (waybill.xlsx)</button>

      <div class="status" id="status-convert"></div>

      <div class="preview" id="preview"></div>
    </div>
  </main>

  <script>
    const vendorSelect      = document.getElementById("vendor-select");
    const statusVendorEl    = document.getElementById("status-vendor");

    const fileInputItems    = document.getElementById("file-input-items");
    const fileInputOrders   = document.getElementById("file-input-orders");
    const statusItemsEl     = document.getElementById("status-items");
    const statusOrdersEl    = document.getElementById("status-orders");

    const convertBtn        = document.getElementById("convert-btn");
    const statusConvertEl   = document.getElementById("status-convert");
    const previewEl         = document.getElementById("preview");
    const mappingEl         = document.getElementById("mapping");

    let selectedVendor = "";
    let itemRows  = [];   // í’ˆëª© íŒŒì¼
    let orderRows = [];   // ì£¼ë¬¸ íŒŒì¼
    let orderHeaders = [];

    const WAYBILL_FIELDS = [
      { key: "ë°›ëŠ”ë¶„ì„±ëª…",               label: "ë°›ëŠ”ë¶„ ì„±ëª…" },
      { key: "ë°›ëŠ”ë¶„ì£¼ì†Œ(ì „ì²´, ë¶„í• )",    label: "ë°›ëŠ”ë¶„ ì£¼ì†Œ(ì „ì²´, ë¶„í• )" },
      { key: "ë°›ëŠ”ë¶„ì „í™”ë²ˆí˜¸",           label: "ë°›ëŠ”ë¶„ ì „í™”ë²ˆí˜¸" },
      { key: "ë°›ëŠ”ë¶„ê¸°íƒ€ì—°ë½ì²˜",         label: "ë°›ëŠ”ë¶„ ê¸°íƒ€ ì—°ë½ì²˜" },
      { key: "í’ˆëª©ëª…",                  label: "í’ˆëª©ëª…" },
      { key: "ë°•ìŠ¤ìˆ˜ëŸ‰",                label: "ë°•ìŠ¤ ìˆ˜ëŸ‰" },
      { key: "ê¸°ë³¸ìš´ì„",                label: "ê¸°ë³¸ ìš´ì„" },
      { key: "ìš´ì„êµ¬ë¶„",                label: "ìš´ì„ êµ¬ë¶„" },
      { key: "ë³´ë‚´ëŠ”ë¶„ì„±ëª…",            label: "ë³´ë‚´ëŠ”ë¶„ ì„±ëª…" },
      { key: "ë³´ë‚´ëŠ”ë¶„ì£¼ì†Œ(ì „ì²´, ë¶„í• )", label: "ë³´ë‚´ëŠ”ë¶„ ì£¼ì†Œ(ì „ì²´, ë¶„í• )" },
      { key: "ë³´ë‚´ëŠ”ë¶„ì „í™”ë²ˆí˜¸",        label: "ë³´ë‚´ëŠ”ë¶„ ì „í™”ë²ˆí˜¸" },
      { key: "ë°°ì†¡ë©”ì„¸ì§€1",             label: "ë°°ì†¡ ë©”ì„¸ì§€ 1" },
      { key: "ê¸°íƒ€1",                   label: "ê¸°íƒ€1" }
    ];

    const alphaGoodsByCode = new Map();
    let alphaGoodsLoaded   = false;

    vendorSelect.addEventListener("change", (e) => {
      selectedVendor = e.target.value;
      if (!selectedVendor) {
        statusVendorEl.textContent = "ì—…ì²´ëª…ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.";
      } else {
        statusVendorEl.textContent = `ì„ íƒëœ ì—…ì²´: ${selectedVendor}`;
      }
      updateConvertButtonState();
    });

    fileInputItems.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      alphaGoodsByCode.clear();
      alphaGoodsLoaded = false;

      if (!file) {
        statusItemsEl.textContent = "í’ˆëª© íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•´ ì£¼ì„¸ìš”.";
        updateConvertButtonState();
        return;
      }

      try {
        statusItemsEl.textContent = "í’ˆëª© íŒŒì¼ ì½ëŠ” ì¤‘...";
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];

        itemRows = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

        if (!itemRows || itemRows.length === 0) {
          statusItemsEl.textContent = `í’ˆëª© ì‹œíŠ¸("${firstSheetName}")ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`;
          updateConvertButtonState();
          return;
        }

        for (const row of itemRows) {
          const code      = (row["ìƒí’ˆì½”ë“œ"]   ?? "").toString().trim();
          const itemName  = (row["í’ˆëª©ëª…"]     ?? "").toString().trim();
          const units     = row["ì…ìˆ˜"];
          const cat1      = (row["ìƒí’ˆë¶„ë¥˜1"]  ?? "").toString().trim();
          const basicFare = row["ê¸°ë³¸"];
          const carton    = row["ì¹´í†¤"];
          const fareShip  = row["ìš´ì„"];

          if (!code) continue;

          alphaGoodsByCode.set(code, {
            ìƒí’ˆì½”ë“œ:   code,
            í’ˆëª©ëª…:     itemName,
            ì…ìˆ˜:       units,
            ìƒí’ˆë¶„ë¥˜1:  cat1,
            ê¸°ë³¸:       basicFare,
            ì¹´í†¤:       carton,
            ìš´ì„:       fareShip
          });
        }

        alphaGoodsLoaded = alphaGoodsByCode.size > 0;
        statusItemsEl.textContent =
          `í’ˆëª© íŒŒì¼(${firstSheetName})ì—ì„œ ${itemRows.length}í–‰, ìƒí’ˆì½”ë“œ ${alphaGoodsByCode.size}ê°œë¥¼ ì½ì—ˆìŠµë‹ˆë‹¤.`;
      } catch (err) {
        console.error(err);
        statusItemsEl.textContent = "í’ˆëª© íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      }

      updateConvertButtonState();
    });

    fileInputOrders.addEventListener("change", async (e) => {
      const file = e.target.files[0];

      if (!file) {
        statusOrdersEl.textContent = "ì£¼ë¬¸ íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•´ ì£¼ì„¸ìš”.";
        orderRows = [];
        orderHeaders = [];
        mappingEl.textContent = "ì£¼ë¬¸ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ì—´ ë§¤í•‘ ì˜µì…˜ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.";
        previewEl.innerHTML = "";
        updateConvertButtonState();
        return;
      }

      try {
        statusOrdersEl.textContent = "ì£¼ë¬¸ íŒŒì¼ ì½ëŠ” ì¤‘...";
        previewEl.innerHTML = "";
        mappingEl.textContent = "(ì—´ ì •ë³´ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...)";

        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];

        orderRows = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

        if (!orderRows || orderRows.length === 0) {
          statusOrdersEl.textContent = `ì£¼ë¬¸ ì‹œíŠ¸("${firstSheetName}")ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`;
          mappingEl.textContent = "ë§¤í•‘ì„ í•  ì£¼ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
          orderHeaders = [];
          updateConvertButtonState();
          return;
        }

        orderHeaders = Object.keys(orderRows[0]);
        statusOrdersEl.textContent =
          `ì£¼ë¬¸ ì‹œíŠ¸("${firstSheetName}")ì—ì„œ ${orderRows.length}ê°œì˜ í–‰ì„ ì½ì—ˆìŠµë‹ˆë‹¤.`;

        showPreviewTable(orderRows);
        buildMappingUI(orderHeaders);
      } catch (err) {
        console.error(err);
        statusOrdersEl.textContent = "ì£¼ë¬¸ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        mappingEl.textContent = "ë§¤í•‘ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
      }

      updateConvertButtonState();
    });

    convertBtn.addEventListener("click", () => {
      statusConvertEl.textContent = "";

      if (!selectedVendor) {
        statusConvertEl.textContent = "ë¨¼ì € ì—…ì²´ëª…ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.";
        return;
      }

      if (!orderRows || orderRows.length === 0) {
        statusConvertEl.textContent = "ë¨¼ì € ì£¼ë¬¸ íŒŒì¼ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.";
        return;
      }

      if (selectedVendor === "ì•ŒíŒŒ" && !alphaGoodsLoaded) {
        statusConvertEl.textContent = "ì•ŒíŒŒ í’ˆëª© íŒŒì¼(ìƒí’ˆ ë§ˆìŠ¤í„°)ì„ ë¨¼ì € ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.";
        return;
      }

      const mapping = getMapping();
      if (!mapping) {
        statusConvertEl.textContent = "ì—´ ë§¤í•‘ì„ ì½ì–´ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        return;
      }

      try {
        statusConvertEl.textContent = "ê·œì¹™ì„ ì ìš©í•˜ëŠ” ì¤‘...";

        let transformedRows = applyRules(orderRows, mapping);

        // ì•ŒíŒŒ ì „ìš© ìš´ì„êµ¬ë¶„ í›„ì²˜ë¦¬
        transformedRows = applyPostFareRules(transformedRows);

        // ë°›ëŠ”ë¶„ì„±ëª… ê¸°ì¤€ ì •ë ¬
        transformedRows.sort((a, b) => {
          const nameA = (a["ë°›ëŠ”ë¶„ì„±ëª…"] ?? "").toString().trim();
          const nameB = (b["ë°›ëŠ”ë¶„ì„±ëª…"] ?? "").toString().trim();
          return nameA.localeCompare(nameB, "ko");
        });

        const cleanedRows = transformedRows.map(row => {
          const copy = { ...row };
          delete copy["_internal_qty"];
          delete copy["_adjusted_qty"];
          delete copy["_carton"];
          return copy;
        });

        const newWorksheet = XLSX.utils.json_to_sheet(cleanedRows);
        const newWorkbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, "waybill");

        XLSX.writeFile(newWorkbook, "waybill.xlsx", { compression: true });

        statusConvertEl.textContent =
          `ë³€í™˜ ì™„ë£Œ! ì´ ${cleanedRows.length}ê°œì˜ í–‰ì´ waybill.xlsxì— í¬í•¨ë˜ì—ˆìŠµë‹ˆë‹¤.`;
      } catch (err) {
        console.error(err);
        statusConvertEl.textContent = "ë³€í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      }
    });

    function updateConvertButtonState() {
      let enable = !!selectedVendor && orderRows.length > 0;
      if (selectedVendor === "ì•ŒíŒŒ") {
        enable = enable && alphaGoodsLoaded;
      }
      convertBtn.disabled = !enable;
    }

    function buildMappingUI(headers) {
      if (!headers || headers.length === 0) {
        mappingEl.textContent = "ì£¼ë¬¸ íŒŒì¼ì˜ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      let html = "";
      html += `<div class="mapping-hint">`;
      html += `ê° waybill í•­ëª©ì— ëŒ€í•´, ì–´ë–¤ <strong>ì£¼ë¬¸ íŒŒì¼ì˜ ì—´</strong>ì„ ì‚¬ìš©í• ì§€ ì„ íƒí•˜ì„¸ìš”. `;
      html += `ì„ íƒí•˜ì§€ ì•Šì€ í•­ëª©ì€ ë¹ˆ ê°’ìœ¼ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤.`;
      html += `</div>`;

      html += `<div class="mapping-grid">`;

      for (const field of WAYBILL_FIELDS) {
        html += `<div class="mapping-item">`;
        html += `<label for="map-${field.key}">waybill: ${field.key}</label>`;
        html += `<select id="map-${field.key}" data-field="${field.key}">`;
        html += `<option value="">(ë¹„ì›Œë‘ê¸°)</option>`;

        for (const h of headers) {
          html += `<option value="${escapeHtml(h)}">${escapeHtml(h)}</option>`;
        }

        html += `</select>`;
        html += `</div>`;
      }

      html += `</div>`;
      mappingEl.innerHTML = html;
    }

    function getMapping() {
      const mapping = {};
      for (const field of WAYBILL_FIELDS) {
        const select = document.querySelector(`select[data-field="${field.key}"]`);
        if (!select) continue;
        const value = select.value;
        mapping[field.key] = value || null;
      }
      return mapping;
    }

    function toNumberOrZero(value) {
      if (value === null || value === undefined) return 0;
      if (value === "") return 0;
      const num = Number(String(value).replace(/,/g, "").trim() || "0");
      return Number.isFinite(num) ? num : 0;
    }

    // ğŸ”¹ ë©”ì¸ ë³€í™˜ ë¡œì§
    function applyRules(rows, mapping) {
      let workingRows = [...rows];

      // ì•ŒíŒŒ ì „ìš© ì„ ì²˜ë¦¬: ë°œì£¼ì²˜ & ìˆ˜ë ¹ìëª… ëª¨ë‘ "ì•ˆì„±ë¬¼ë¥˜"ë©´ ì£¼ë¬¸ëŸ‰ì„ 0ìœ¼ë¡œ
      if (selectedVendor === "ì•ŒíŒŒ") {
        workingRows = workingRows.map((row) => {
          const purchaser = (row["ë°œì£¼ì²˜"] ?? "").toString().trim();
          const receiver  = (row["ìˆ˜ë ¹ìëª…"] ?? "").toString().trim();

          if (purchaser === "ì•ˆì„±ë¬¼ë¥˜" && receiver === "ì•ˆì„±ë¬¼ë¥˜") {
            return { ...row, ì£¼ë¬¸ëŸ‰: 0 };
          }
          return row;
        });
      }

      // ì•ŒíŒŒ ì „ìš©: ì£¼ë¬¸ëŸ‰ 0 í–‰ ì œê±°
      if (selectedVendor === "ì•ŒíŒŒ") {
        workingRows = workingRows.filter((row) => {
          const raw = row["ì£¼ë¬¸ëŸ‰"];
          if (raw === null || raw === undefined || raw === "") return false;
          const num = toNumberOrZero(raw);
          return num !== 0;
        });
      }

      const result = [];

      workingRows.forEach((row) => {
        let internalQty = 0;
        let cartonForRow = 0;

        // ìˆ˜ëŸ‰ ê³„ì‚°
        if (selectedVendor === "ì•ŒíŒŒ") {
          const orderQty = toNumberOrZero(row["ì£¼ë¬¸ëŸ‰"]);
          let unitsPerBox = 0;
          let isArtMate   = false;

          const code = (row["ìƒí’ˆì½”ë“œ"] ?? "").toString().trim();
          if (code && alphaGoodsByCode.has(code)) {
            const goods = alphaGoodsByCode.get(code);
            unitsPerBox = toNumberOrZero(goods.ì…ìˆ˜);
            if (goods.ìƒí’ˆë¶„ë¥˜1 === "ì•„íŠ¸ë©”ì´íŠ¸") {
              isArtMate = true;
            }
            cartonForRow = toNumberOrZero(goods.ì¹´í†¤);
          }

          internalQty = isArtMate ? orderQty : unitsPerBox * orderQty;
        } else {
          internalQty = toNumberOrZero(row["ì£¼ë¬¸ëŸ‰"] ?? row["ìˆ˜ëŸ‰"]);
          cartonForRow = 0; // ë„¤ì´ë²„ ë“±ì€ ì¹´í†¤ ê·œì¹™ ì—†ìŒ
        }

        // ì¹´í†¤/ë‚˜ë¨¸ì§€ ê³„ì‚°
        let adjustedQtyMain;
        let boxQtyMain;
        let remainder = 0;

        if (
          selectedVendor === "ì•ŒíŒŒ" &&
          cartonForRow > 0 &&
          internalQty > cartonForRow
        ) {
          const quotient = Math.floor(internalQty / cartonForRow);
          remainder = internalQty - quotient * cartonForRow;

          adjustedQtyMain = cartonForRow;
          boxQtyMain = quotient;
        } else {
          adjustedQtyMain = internalQty;
          boxQtyMain = 1;
          remainder = 0;
        }

        // ê¸°ë³¸ í–‰ ìƒì„± (ì¹´í†¤ ê¸°ì¤€, ë˜ëŠ” ì „ì²´ ìˆ˜ëŸ‰)
        const baseRow = buildWaybillRowFromSource(
          row,
          mapping,
          internalQty,
          adjustedQtyMain,
          boxQtyMain,
          cartonForRow
        );
        result.push(baseRow);

        // ğŸ”¹ ë‚˜ë¨¸ì§€ê°€ ìˆì„ ê²½ìš°, ë™ì¼ ìˆ˜ì·¨ì¸ ì •ë³´ë¡œ ìƒˆ í–‰ ì¶”ê°€
        if (
          selectedVendor === "ì•ŒíŒŒ" &&
          cartonForRow > 0 &&
          remainder > 0
        ) {
          const remainderRow = buildWaybillRowFromSource(
            row,
            mapping,
            internalQty,
            remainder,   // ë‚˜ë¨¸ì§€ ìˆ˜ëŸ‰
            1,           // ë°•ìŠ¤ìˆ˜ëŸ‰ 1
            cartonForRow
          );
          result.push(remainderRow);
        }
      });

      return result;
    }

    // ğŸ”§ ê°œë³„ í–‰(waybill í•œ ì¤„) ìƒì„± í•¨ìˆ˜
    function buildWaybillRowFromSource(srcRow, mapping, internalQty, adjustedQty, boxQty, cartonForRow) {
      const out = {};

      for (const field of WAYBILL_FIELDS) {
        const key = field.key;

        // ë³´ë‚´ëŠ”ë¶„ ì£¼ì†Œ/ì „í™”ëŠ” ëª¨ë“  ì—…ì²´ ê³µí†µ ê³ ì •ê°’
        if (key === "ë³´ë‚´ëŠ”ë¶„ì£¼ì†Œ(ì „ì²´, ë¶„í• )") {
          out[key] = "ê²½ê¸°ë„ ê¹€í¬ì‹œ ì• ê¸°ë´‰ë¡œ 206";
          continue;
        }
        if (key === "ë³´ë‚´ëŠ”ë¶„ì „í™”ë²ˆí˜¸") {
          out[key] = "031-987-9495";
          continue;
        }

        // ì•ŒíŒŒ ì „ìš©: ë°œì£¼ì²˜=ì•ˆì„±ë¬¼ë¥˜ â†’ ë³´ë‚´ëŠ”ë¶„ì„±ëª… = "ì•ŒíŒŒ ì•ˆì„±"
        if (selectedVendor === "ì•ŒíŒŒ" && key === "ë³´ë‚´ëŠ”ë¶„ì„±ëª…") {
          const purchaser = (srcRow["ë°œì£¼ì²˜"] ?? "").toString().trim();
          out[key] = purchaser === "ì•ˆì„±ë¬¼ë¥˜" ? "ì•ŒíŒŒ ì•ˆì„±" : "";
          continue;
        }

        // ì•ŒíŒŒ ì „ìš©: ìˆ˜ë ¹ì ë§¤í•‘
        if (selectedVendor === "ì•ŒíŒŒ") {
          if (key === "ë°›ëŠ”ë¶„ì„±ëª…") {
            out[key] = srcRow["ìˆ˜ë ¹ìëª…"] ?? "";
            continue;
          }
          if (key === "ë°›ëŠ”ë¶„ì£¼ì†Œ(ì „ì²´, ë¶„í• )") {
            out[key] = srcRow["ìˆ˜ë ¹ì ì£¼ì†Œ"] ?? "";
            continue;
          }
          if (key === "ë°›ëŠ”ë¶„ì „í™”ë²ˆí˜¸") {
            const phone1 = (srcRow["ìˆ˜ë ¹ì ì „í™”ë²ˆí˜¸"] ?? "").toString().trim();
            const phone2 = (srcRow["ìˆ˜ë ¹ì íœ´ëŒ€ì „í™”"] ?? "").toString().trim();
            out[key] = phone1 || phone2 || "";
            continue;
          }
          if (key === "ë°›ëŠ”ë¶„ê¸°íƒ€ì—°ë½ì²˜") {
            out[key] = srcRow["ìˆ˜ë ¹ì íœ´ëŒ€ì „í™”"] ?? "";
            continue;
          }
        }

        // ë„¤ì´ë²„ ì „ìš©: ìˆ˜ë ¹ì ë§¤í•‘
        if (selectedVendor === "ë„¤ì´ë²„") {
          if (key === "ë°›ëŠ”ë¶„ì„±ëª…") {
            out[key] = srcRow["ìˆ˜ì·¨ì¸ëª…"] ?? "";
            continue;
          }
          if (key === "ë°›ëŠ”ë¶„ì£¼ì†Œ(ì „ì²´, ë¶„í• )") {
            out[key] = srcRow["í†µí•©ë°°ì†¡ì§€"] ?? "";
            continue;
          }
          if (key === "ë°›ëŠ”ë¶„ì „í™”ë²ˆí˜¸") {
            out[key] = srcRow["ìˆ˜ì·¨ì¸ì—°ë½ì²˜1"] ?? "";
            continue;
          }
          if (key === "ë°›ëŠ”ë¶„ê¸°íƒ€ì—°ë½ì²˜") {
            out[key] = srcRow["ìˆ˜ì·¨ì¸ì—°ë½ì²˜2"] ?? "";
            continue;
          }
        }

        // ì•ŒíŒŒ ì „ìš©: ê¸°ë³¸ìš´ì„
        // - adjustedQty == ì¹´í†¤ & ìš´ì„ê°’ ìˆìœ¼ë©´ â†’ ìš´ì„ ì‚¬ìš©
        // - ê·¸ ì™¸ â†’ ê¸°ë³¸ ì‚¬ìš©
        if (selectedVendor === "ì•ŒíŒŒ" && key === "ê¸°ë³¸ìš´ì„") {
          let value = "";

          const code = (srcRow["ìƒí’ˆì½”ë“œ"] ?? "").toString().trim();
          if (code && alphaGoodsByCode.has(code)) {
            const goods      = alphaGoodsByCode.get(code);
            const cartonNum  = toNumberOrZero(goods.ì¹´í†¤);
            const basicFare  = goods.ê¸°ë³¸;
            const shipFare   = goods.ìš´ì„;
            const qtyForFare = toNumberOrZero(adjustedQty);

            if (
              cartonNum > 0 &&
              qtyForFare === cartonNum &&
              shipFare !== undefined &&
              shipFare !== null &&
              shipFare !== ""
            ) {
              value = shipFare;
            } else if (
              basicFare !== undefined &&
              basicFare !== null &&
              basicFare !== ""
            ) {
              value = basicFare;
            }
          }

          if (!value) {
            const mappedHeader = mapping[key];
            if (mappedHeader) {
              value = srcRow[mappedHeader] ?? "";
            }
          }

          out[key] = value;
          continue;
        }

        // ì•ŒíŒŒ ì „ìš©: í’ˆëª©ëª… = (í’ˆëª©íŒŒì¼ í’ˆëª©ëª… or ë§¤í•‘ê°’) + " - " + adjustedQty + "EA"
        if (selectedVendor === "ì•ŒíŒŒ" && key === "í’ˆëª©ëª…") {
          let baseName = "";
          const code = (srcRow["ìƒí’ˆì½”ë“œ"] ?? "").toString().trim();

          if (code && alphaGoodsByCode.has(code)) {
            const goods = alphaGoodsByCode.get(code);
            if (goods && goods.í’ˆëª©ëª…) {
              baseName = goods.í’ˆëª©ëª…;
            }
          }

          if (!baseName) {
            const mappedHeaderForItem = mapping[key];
            if (mappedHeaderForItem) {
              baseName = srcRow[mappedHeaderForItem] ?? "";
            }
          }

          out[key] = `${baseName} - ${adjustedQty}EA`;
          continue;
        }

        // ì•ŒíŒŒ ì „ìš©: ë°•ìŠ¤ìˆ˜ëŸ‰
        if (selectedVendor === "ì•ŒíŒŒ" && key === "ë°•ìŠ¤ìˆ˜ëŸ‰") {
          out[key] = boxQty;
          continue;
        }

        // ê·¸ ì™¸ ê³µí†µ: ë§¤í•‘ UIì— ë”°ë¥¸ ê°’ ì‚¬ìš©
        const mappedHeader = mapping[key];

        if (!mappedHeader) {
          if (key === "ë°•ìŠ¤ìˆ˜ëŸ‰") {
            out[key] = 1;
          } else {
            out[key] = "";
          }
          continue;
        }

        const value = srcRow[mappedHeader];

        if (key === "ë°•ìŠ¤ìˆ˜ëŸ‰") {
          const num = Number(value);
          out[key] = Number.isFinite(num) && num > 0 ? num : 1;
        } else {
          out[key] = value ?? "";
        }
      }

      // í›„ì²˜ë¦¬ìš© ë‚´ë¶€ í•„ë“œ
      out["_internal_qty"]  = internalQty;
      out["_adjusted_qty"]  = adjustedQty;
      out["_carton"]        = cartonForRow;

      return out;
    }

    // ğŸ”¹ ì•ŒíŒŒ ì „ìš© ìš´ì„êµ¬ë¶„ í›„ì²˜ë¦¬
    // - ê¸°ë³¸ìš´ì„ì´ "X" ì´ë©´ ìš´ì„êµ¬ë¶„ = "â– â– Xâ– â– " (ìµœìš°ì„ )
    // - ë°›ëŠ”ë¶„ì„±ëª…+ì£¼ì†Œ+ì „í™”ê°€ 2ê°œ ì´ìƒ ì¤‘ë³µì´ê³ , ìˆ˜ëŸ‰(adjusted_qty) < ì¹´í†¤ â†’ ìš´ì„êµ¬ë¶„ = "â˜…â˜…Oâ˜…â˜…"
    function applyPostFareRules(rows) {
      if (selectedVendor !== "ì•ŒíŒŒ") return rows;

      const groups = new Map();

      rows.forEach((row, idx) => {
        const name  = (row["ë°›ëŠ”ë¶„ì„±ëª…"] ?? "").toString().trim();
        const addr  = (row["ë°›ëŠ”ë¶„ì£¼ì†Œ(ì „ì²´, ë¶„í• )"] ?? "").toString().trim();
        const phone = (row["ë°›ëŠ”ë¶„ì „í™”ë²ˆí˜¸"] ?? "").toString().trim();
        const key   = `${name}||${addr}||${phone}`;

        if (!groups.has(key)) groups.set(key, []);
        groups.get(key).push(idx);
      });

      rows.forEach((row, idx) => {
        const name  = (row["ë°›ëŠ”ë¶„ì„±ëª…"] ?? "").toString().trim();
        const addr  = (row["ë°›ëŠ”ë¶„ì£¼ì†Œ(ì „ì²´, ë¶„í• )"] ?? "").toString().trim();
        const phone = (row["ë°›ëŠ”ë¶„ì „í™”ë²ˆí˜¸"] ?? "").toString().trim();
        const key   = `${name}||${addr}||${phone}`;
        const idxList = groups.get(key) || [];
        const duplicatedReceiver = idxList.length >= 2;

        const basicFareRaw = row["ê¸°ë³¸ìš´ì„"];
        const basicFareStr = basicFareRaw === null || basicFareRaw === undefined
          ? ""
          : String(basicFareRaw).trim().toUpperCase();

        // 1) ê¸°ë³¸ìš´ì„ì´ Xì¸ í–‰: ìš´ì„êµ¬ë¶„ = "â– â– Xâ– â– "
        if (basicFareStr === "X") {
          row["ìš´ì„êµ¬ë¶„"] = "â– â– Xâ– â– ";
          return;
        }

        // 2) ìˆ˜ì·¨ì¸ ì¤‘ë³µ + ìˆ˜ëŸ‰ < ì¹´í†¤: ìš´ì„êµ¬ë¶„ = "â˜…â˜…Oâ˜…â˜…"
        if (duplicatedReceiver) {
          const qty    = toNumberOrZero(row["_adjusted_qty"]);
          const carton = toNumberOrZero(row["_carton"]);
          if (carton > 0 && qty < carton) {
            row["ìš´ì„êµ¬ë¶„"] = "â˜…â˜…Oâ˜…â˜…";
          }
        }
      });

      return rows;
    }

    function showPreviewTable(rows) {
      if (!rows || rows.length === 0) {
        previewEl.innerHTML = "<em>ë¯¸ë¦¬ë³´ê¸°í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</em>";
        return;
      }

      const maxRows = 10;
      const previewRows = rows.slice(0, maxRows);
      const keys = Object.keys(previewRows[0]);

      let html = "<div>ì£¼ë¬¸ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (ìƒìœ„ " + previewRows.length + "í–‰)</div>";
      html += "<table><thead><tr>";
      for (const key of keys) {
        html += "<th>" + escapeHtml(key) + "</th>";
      }
      html += "</tr></thead><tbody>";

      for (const row of previewRows) {
        html += "<tr>";
        for (const key of keys) {
          html += "<td>" + escapeHtml(row[key]) + "</td>";
        }
        html += "</tr>";
      }

      html += "</tbody></table>";
      previewEl.innerHTML = html;
    }

    function escapeHtml(value) {
      if (value === null || value === undefined) return "";
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/"/g, "&quot;");
    }
  </script>
</body>
</html>
