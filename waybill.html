<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Waybill 변환 (알파/네이버/오피스디포)</title>

  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, sans-serif; background:#0f172a; color:#e5e7eb; }
    main { max-width: 980px; margin: 0 auto; padding: 24px 16px 40px; }
    .card { background: rgba(15,23,42,.9); border: 1px solid rgba(148,163,184,.35); border-radius: 16px; padding: 18px; margin-bottom: 16px; }
    h1 { font-size: 18px; margin: 0 0 8px; }
    p { margin: 0 0 10px; color:#cbd5f5; font-size: 13px; line-height: 1.5; }
    label { display:block; font-size: 12px; margin: 12px 0 6px; color:#e5e7eb; }
    select, input[type="file"]{
      width:100%; padding:10px; background:#020617; color:#e5e7eb;
      border:1px solid rgba(148,163,184,.6); border-radius:10px;
    }
    button{
      margin-top:14px; padding:10px 16px; border:0; border-radius:9999px;
      background:#2563eb; color:#fff; cursor:pointer; font-size: 13px;
    }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .status{ margin-top:10px; font-size:12px; color:#a5b4fc; white-space:pre-wrap; min-height: 18px; }
    .preview { margin-top: 12px; max-height: 280px; overflow:auto; border-top:1px solid rgba(148,163,184,.35); padding-top: 12px; }
    .excludeWrap { margin-top: 12px; border-top:1px solid rgba(148,163,184,.35); padding-top: 12px; display:none; }
    table{ border-collapse:collapse; width:100%; font-size:12px; }
    th,td{ border:1px solid rgba(148,163,184,.5); padding:4px 6px; white-space:nowrap; }
    th{ background:rgba(37,99,235,.25); position: sticky; top: 0; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .small { font-size: 12px; color:#cbd5f5; margin: 6px 0 10px; }
    .badge { font-size: 11px; color:#e5e7eb; background: rgba(148,163,184,.18); border:1px solid rgba(148,163,184,.35); padding: 2px 8px; border-radius: 9999px; }
    code { background: rgba(148,163,184,.15); padding: 2px 6px; border-radius: 6px; }
  </style>
</head>

<body>
<main>
  <h1>Waybill 변환 (알파/네이버/오피스디포)</h1>
  <p>
    공통 품목 파일 + 주문 파일 업로드 → <code>waybill.xlsx</code> 생성<br/>
    (제외) 네이버: 위킵 / 공통: 주문량=0 / 금액&lt;1 / 품목명에 [단종]
  </p>

  <div class="card">
    <label>0. 업체 선택</label>
    <select id="vendor">
      <option value="">선택하세요</option>
      <option value="alpha">알파</option>
      <option value="naver">네이버</option>
      <option value="office">오피스디포</option>
    </select>

    <label style="margin-top:16px;">1. 공통 품목 파일 업로드</label>
    <input id="goodsFile" type="file" accept=".xlsx,.xls" />

    <label style="margin-top:16px;">2. 주문 파일 업로드</label>
    <input id="orderFile" type="file" accept=".xlsx,.xls" />

    <button id="convertBtn" disabled>waybill.xlsx 생성</button>
    <div id="status" class="status"></div>

    <div id="excludeWrap" class="excludeWrap">
      <div class="row">
        <div class="small"><b>제외된 행 목록</b> (제외사유 / 받는분성명 / 상품코드 / 품목명 / 주문번호)</div>
        <div class="badge" id="excludeCount">0건</div>
      </div>
      <div id="excludeTable" style="max-height:260px; overflow:auto;"></div>
      <div class="small" id="excludeNote" style="display:none;"></div>
    </div>

    <div class="preview" id="preview"></div>
  </div>
</main>

<script>
/* ===============================
   고정값
================================ */
const SENDER_ADDR  = "경기도 김포시 애기봉로 206";
const SENDER_PHONE = "031-987-9495";

/* ===============================
   상태 변수
================================ */
let goodsRows = [];
let orderRows = [];
let goodsMap = new Map(); // 기존 코드 유지(알파/오피스디포 등 공통 코드 매핑)

// ✅ 네이버 전용 인덱스(요청사항 반영)
// key = "상품번호|옵션정규화"
let goodsNaverMap = new Map();      // "상품번호|옵션" -> goods row
let goodsNaverListMap = new Map();  // "상품번호" -> goods rows(list)

const vendorEl   = document.getElementById("vendor");
const goodsFileEl = document.getElementById("goodsFile");
const orderFileEl = document.getElementById("orderFile");
const convertBtn  = document.getElementById("convertBtn");
const statusEl    = document.getElementById("status");
const previewEl   = document.getElementById("preview");

const excludeWrapEl = document.getElementById("excludeWrap");
const excludeTableEl = document.getElementById("excludeTable");
const excludeCountEl = document.getElementById("excludeCount");
const excludeNoteEl  = document.getElementById("excludeNote");

/* ✅ 업체 변경 시 주문파일 자동 재로딩 */
vendorEl.addEventListener("change", async () => {
  setStatus("");
  const f = orderFileEl.files?.[0];
  if (f) await loadOrderFile(f);
  updateBtn();
});

/* ===============================
   품목 파일 업로드
================================ */
goodsFileEl.addEventListener("change", async (e) => {
  const f = e.target.files?.[0];
  goodsMap.clear();
  goodsRows = [];

  // ✅ 네이버 인덱스 초기화
  goodsNaverMap.clear();
  goodsNaverListMap.clear();

  if (!f) { setStatus("품목 파일을 선택해 주세요."); updateBtn(); return; }

  try {
    setStatus("품목 파일 읽는 중...");
    goodsRows = await readExcelFirstSheet(f);

    for (const r of goodsRows) {
      // (기존) 공통 코드 매핑 유지
      const codeCandidates = collectGoodsCodes(r);
      for (const c of codeCandidates) {
        const key = normCode(c);
        if (key) goodsMap.set(key, r);
      }

      // ✅ (추가) 네이버 전용 매핑: 네이버 상품코드 + 옵션
      const naverCodes = splitCodes(r["네이버 상품코드"]);
      const goodsOptNorm = normOption(r["옵션"]);

      for (const c of naverCodes) {
        const code = normCode(c);
        if (!code) continue;

        const k = `${code}|${goodsOptNorm}`;
        goodsNaverMap.set(k, r);

        if (!goodsNaverListMap.has(code)) goodsNaverListMap.set(code, []);
        goodsNaverListMap.get(code).push(r);

        // 옵션이 비어있는 경우, fallback 키도 하나 만들어 둠
        if (!goodsOptNorm) {
          const fallbackKey = `${code}|`;
          if (!goodsNaverMap.has(fallbackKey)) goodsNaverMap.set(fallbackKey, r);
        }
      }
    }

    setStatus(
      `품목 파일 로드 완료\n` +
      `코드 매핑(공통): ${goodsMap.size}개\n` +
      `네이버 매핑(상품번호|옵션): ${goodsNaverMap.size}개`
    );

  } catch (err) {
    console.error(err);
    setStatus("품목 파일 읽기 오류가 발생했습니다.");
  }

  updateBtn();
});

/* ===============================
   주문 파일 업로드
================================ */
orderFileEl.addEventListener("change", async (e) => {
  const f = e.target.files?.[0];
  orderRows = [];
  if (!f) { setStatus("주문 파일을 선택해 주세요."); updateBtn(); return; }
  await loadOrderFile(f);
  updateBtn();
});

async function loadOrderFile(file) {
  try {
    const vendor = vendorEl.value;
    if (!vendor) {
      orderRows = await readExcelFirstSheet(file);
      setStatus(`주문 파일 로드(업체 미선택 → 첫 시트)\n행 수: ${orderRows.length}\n※ 업체 선택 후 자동 재로딩됩니다.`);
      showPreview(orderRows, "주문 파일 미리보기");
      return;
    }

    setStatus("주문 파일 읽는 중...");

    if (vendor === "naver") {
      orderRows = await readExcelByBestSheet(file, ["발주발송관리"]);
    } else {
      // 알파/오피스디포(품목별 현황) → 첫 시트
      orderRows = await readExcelFirstSheet(file);
    }

    const vendorName = vendor === "naver" ? "네이버" : (vendor === "office" ? "오피스디포" : "알파");
    setStatus(`주문 파일 로드 완료\n행 수: ${orderRows.length}\n(업체: ${vendorName})`);
    showPreview(orderRows, "주문 파일 미리보기");
  } catch (err) {
    console.error(err);
    setStatus("주문 파일 읽기 오류가 발생했습니다.");
  }
}

function updateBtn() {
  const vendor = vendorEl.value;
  convertBtn.disabled = !(vendor && goodsMap.size > 0 && orderRows.length > 0);
}

/* ===============================
   변환 실행
================================ */
convertBtn.addEventListener("click", () => {
  try {
    setStatus("변환 중...");
    clearExcludeTable();

    const vendor = vendorEl.value;
    let result;
    if (vendor === "naver") result = buildWaybillNaver(orderRows);
    else if (vendor === "office") result = buildWaybillOffice(orderRows);
    else result = buildWaybillAlpha(orderRows);

    const ws = XLSX.utils.json_to_sheet(result.rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "waybill");
    XLSX.writeFile(wb, "waybill.xlsx");

    setStatus(
      `완료!\n생성 행 수: ${result.rows.length}\n` +
      `제외 행 수: ${result.excluded.length}\n` +
      (result.statsText ? `\n${result.statsText}` : "")
    );

    showPreview(result.rows, "waybill 결과 미리보기");
    renderExcludeTable(result.excluded);

  } catch (err) {
    console.error(err);
    setStatus("변환 중 오류가 발생했습니다. 콘솔을 확인해 주세요.");
  }
});

/* ===============================
   제외 row 생성
================================ */
function makeExcludeRow(reason, receiverName, code, itemName, orderNo) {
  return {
    "제외사유": reason,
    "받는분성명": receiverName || "",
    "상품코드":
