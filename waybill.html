<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Waybill 변환 (알파/네이버/오피스디포/밸류포인트/오피스넥스/이베이/드림오피스)</title>

  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, sans-serif; background:#0f172a; color:#e5e7eb; }
    main { max-width: 980px; margin: 0 auto; padding: 24px 16px 40px; }
    .card { background: rgba(15,23,42,.9); border: 1px solid rgba(148,163,184,.35); border-radius: 16px; padding: 18px; margin-bottom: 16px; }
    h1 { font-size: 18px; margin: 0 0 8px; }
    p { margin: 0 0 10px; color:#cbd5f5; font-size: 13px; line-height: 1.5; }
    label { display:block; font-size: 12px; margin: 12px 0 6px; color:#e5e7eb; }
    select, input[type="file"]{
      width:100%; padding:10px; background:#020617; color:#e5e7eb;
      border:1px solid rgba(148,163,184,.6); border-radius:10px;
    }
    button{
      margin-top:14px; padding:10px 16px; border:0; border-radius:9999px;
      background:#2563eb; color:#fff; cursor:pointer; font-size: 13px;
    }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .status{ margin-top:10px; font-size:12px; color:#a5b4fc; white-space:pre-wrap; min-height: 18px; }
    .preview { margin-top: 12px; max-height: 280px; overflow:auto; border-top:1px solid rgba(148,163,184,.35); padding-top: 12px; }
    .excludeWrap { margin-top: 12px; border-top:1px solid rgba(148,163,184,.35); padding-top: 12px; display:none; }
    table{ border-collapse:collapse; width:100%; font-size:12px; }
    th,td{ border:1px solid rgba(148,163,184,.5); padding:4px 6px; white-space:nowrap; }
    th{ background:rgba(37,99,235,.25); position: sticky; top: 0; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .small { font-size: 12px; color:#cbd5f5; margin: 6px 0 10px; }
    .badge { font-size: 11px; color:#e5e7eb; background: rgba(148,163,184,.18); border:1px solid rgba(148,163,184,.35); padding: 2px 8px; border-radius: 9999px; }
    code { background: rgba(148,163,184,.15); padding: 2px 6px; border-radius: 6px; }
  </style>
</head>

<body>
<main>
  <h1>Waybill 변환 (알파/네이버/오피스디포/밸류포인트/오피스넥스/이베이/드림오피스)</h1>
  <p>
    공통 품목 파일 + 주문 파일 업로드 → <code>waybill.xlsx</code> 생성<br/>
    (제외) 네이버: 위킵 / 공통: 주문량=0 / 금액&lt;1 / 품목명에 [단종]
  </p>

  <div class="card">
    <label>0. 업체 선택</label>
    <select id="vendor">
      <option value="">선택하세요</option>
      <option value="alpha">알파</option>
      <option value="naver">네이버</option>
      <option value="office">오피스디포</option>
      <option value="valuepoint">밸류포인트</option>
      <option value="officenex">오피스넥스</option>
      <option value="ebay">이베이(옥션/지마켓)</option>
      <option value="dreamoffice">드림오피스</option>
    </select>

    <label style="margin-top:16px;">1. 공통 품목 파일 업로드</label>
    <input id="goodsFile" type="file" accept=".xlsx,.xls" />

    <label style="margin-top:16px;">2. 주문 파일 업로드</label>
    <input id="orderFile" type="file" accept=".xlsx,.xls" />

    <button id="convertBtn" disabled>waybill.xlsx 생성</button>
    <div id="status" class="status"></div>

    <div id="excludeWrap" class="excludeWrap">
      <div class="row">
        <div class="small"><b>제외된 행 목록</b> (제외사유 / 받는분성명 / 상품코드 / 품목명 / 주문번호)</div>
        <div class="badge" id="excludeCount">0건</div>
      </div>
      <div id="excludeTable" style="max-height:260px; overflow:auto;"></div>
      <div class="small" id="excludeNote" style="display:none;"></div>
    </div>

    <div class="preview" id="preview"></div>
  </div>
</main>

<script>
/* ===============================
   고정값
================================ */
const SENDER_ADDR  = "경기도 김포시 애기봉로 206";
const SENDER_PHONE = "031-987-9495";

/* ===============================
   상태 변수
================================ */
let goodsRows = [];
let orderRows = [];

// 공통 코드 -> goods row (알파/오피스디포/밸류포인트/오피스넥스/드림오피스 등)
let goodsMap = new Map();

// 네이버: 네이버 상품코드(=주문파일 상품번호) -> goods rows[]
let goodsNaverListMap = new Map();

// 이베이: 옥션/지마켓 상품코드 매핑
let goodsAuctionMap = new Map();  // 옥션 상품코드 -> goods row
let goodsGmarketMap = new Map();  // 지마켓 상품코드 -> goods row

const vendorEl   = document.getElementById("vendor");
const goodsFileEl = document.getElementById("goodsFile");
const orderFileEl = document.getElementById("orderFile");
const convertBtn  = document.getElementById("convertBtn");
const statusEl    = document.getElementById("status");
const previewEl   = document.getElementById("preview");

const excludeWrapEl = document.getElementById("excludeWrap");
const excludeTableEl = document.getElementById("excludeTable");
const excludeCountEl = document.getElementById("excludeCount");
const excludeNoteEl  = document.getElementById("excludeNote");

/* ✅ 업체 변경 시 주문파일 자동 재로딩 */
vendorEl.addEventListener("change", async () => {
  setStatus("");
  const f = orderFileEl.files?.[0];
  if (f) await loadOrderFile(f);
  updateBtn();
});

/* ===============================
   품목 파일 업로드
================================ */
goodsFileEl.addEventListener("change", async (e) => {
  const f = e.target.files?.[0];
  goodsRows = [];

  goodsMap.clear();
  goodsNaverListMap.clear();
  goodsAuctionMap.clear();
  goodsGmarketMap.clear();

  if (!f) { setStatus("품목 파일을 선택해 주세요."); updateBtn(); return; }

  try {
    setStatus("품목 파일 읽는 중...");
    goodsRows = await readExcelFirstSheet(f);

    for (const r of goodsRows) {
      // 1) 공통 코드 매핑
      const codeCandidates = collectGoodsCodes(r);
      for (const c of codeCandidates) {
        const key = normCode(c);
        if (key) goodsMap.set(key, r);
      }

      // 2) 네이버 전용 매핑 (네이버 상품코드 -> 동일 상품번호 그룹)
      for (const c of splitCodes(r["네이버 상품코드"])) {
        const code = normCode(c);
        if (!code) continue;
        if (!goodsNaverListMap.has(code)) goodsNaverListMap.set(code, []);
        goodsNaverListMap.get(code).push(r);
      }

      // 3) 이베이 전용 매핑 (옥션/지마켓 상품코드)
      for (const c of splitCodes(r["옥션 상품코드"])) {
        const code = normCode(c);
        if (code) goodsAuctionMap.set(code, r);
      }
      for (const c of splitCodes(r["지마켓 상품코드"])) {
        const code = normCode(c);
        if (code) goodsGmarketMap.set(code, r);
      }
    }

    setStatus(
      `품목 파일 로드 완료\n` +
      `코드 매핑(공통): ${goodsMap.size}개\n` +
      `네이버 매핑(상품번호별): ${goodsNaverListMap.size}개\n` +
      `이베이-옥션 매핑: ${goodsAuctionMap.size}개\n` +
      `이베이-지마켓 매핑: ${goodsGmarketMap.size}개`
    );
  } catch (err) {
    console.error(err);
    setStatus("품목 파일 읽기 오류가 발생했습니다.");
  }

  updateBtn();
});

/* ===============================
   주문 파일 업로드
================================ */
orderFileEl.addEventListener("change", async (e) => {
  const f = e.target.files?.[0];
  orderRows = [];
  if (!f) { setStatus("주문 파일을 선택해 주세요."); updateBtn(); return; }
  await loadOrderFile(f);
  updateBtn();
});

async function loadOrderFile(file) {
  try {
    const vendor = vendorEl.value;
    if (!vendor) {
      orderRows = await readExcelFirstSheet(file);
      setStatus(`주문 파일 로드(업체 미선택 → 첫 시트)\n행 수: ${orderRows.length}\n※ 업체 선택 후 자동 재로딩됩니다.`);
      showPreview(orderRows, "주문 파일 미리보기");
      return;
    }

    setStatus("주문 파일 읽는 중...");

    if (vendor === "naver") {
      orderRows = await readExcelByBestSheet(file, ["발주발송관리"]);
    } else {
      // 그 외 → 첫 시트
      orderRows = await readExcelFirstSheet(file);
    }

    const vendorName =
      vendor === "naver" ? "네이버" :
      vendor === "office" ? "오피스디포" :
      vendor === "valuepoint" ? "밸류포인트" :
      vendor === "officenex" ? "오피스넥스" :
      vendor === "ebay" ? "이베이(옥션/지마켓)" :
      vendor === "dreamoffice" ? "드림오피스" : "알파";

    setStatus(`주문 파일 로드 완료\n행 수: ${orderRows.length}\n(업체: ${vendorName})`);
    showPreview(orderRows, "주문 파일 미리보기");
  } catch (err) {
    console.error(err);
    setStatus("주문 파일 읽기 오류가 발생했습니다.");
  }
}

function updateBtn() {
  const vendor = vendorEl.value;

  let hasGoods = false;
  if (vendor === "naver") hasGoods = (goodsNaverListMap.size > 0);
  else if (vendor === "ebay") hasGoods = (goodsAuctionMap.size > 0 || goodsGmarketMap.size > 0);
  else hasGoods = (goodsMap.size > 0);

  convertBtn.disabled = !(vendor && hasGoods && orderRows.length > 0);
}

/* ===============================
   변환 실행
================================ */
convertBtn.addEventListener("click", () => {
  try {
    setStatus("변환 중...");
    clearExcludeTable();

    const vendor = vendorEl.value;
    let result;
    if (vendor === "naver") result = buildWaybillNaver(orderRows);
    else if (vendor === "office") result = buildWaybillOffice(orderRows);
    else if (vendor === "valuepoint") result = buildWaybillValuePoint(orderRows);
    else if (vendor === "officenex") result = buildWaybillOfficeNex(orderRows);
    else if (vendor === "ebay") result = buildWaybillEbay(orderRows);
    else if (vendor === "dreamoffice") result = buildWaybillDreamOffice(orderRows);
    else result = buildWaybillAlpha(orderRows);

    // ✅ 중복 컬럼 채우기(내부필드 제거 포함)
    applyDuplicateColumn(result.rows);

    const ws = XLSX.utils.json_to_sheet(result.rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "waybill");
    XLSX.writeFile(wb, "waybill.xlsx");

    setStatus(
      `완료!\n생성 행 수: ${result.rows.length}\n` +
      `제외 행 수: ${result.excluded.length}\n` +
      (result.statsText ? `\n${result.statsText}` : "")
    );

    showPreview(result.rows, "waybill 결과 미리보기");
    renderExcludeTable(result.excluded);

  } catch (err) {
    console.error(err);
    setStatus("변환 중 오류가 발생했습니다. 콘솔을 확인해 주세요.");
  }
});

/* ===============================
   제외 row 생성
================================ */
function makeExcludeRow(reason, receiverName, code, itemName, orderNo) {
  return {
    "제외사유": reason,
    "받는분성명": receiverName || "",
    "상품코드": code || "",
    "품목명": itemName || "",
    "주문번호": orderNo || ""
  };
}

/* ===============================
   알파 변환
================================ */
function buildWaybillAlpha(rows) {
  const out = [];
  const excluded = [];
  const missingCodes = new Set();

  for (const r of rows) {
    const orderQty = toNum(r["주문량"]);
    const amt = pickAmount(r);

    const code = normCode(r["상품코드"]);
    const goods = goodsMap.get(code);

    const baseName = goods ? (goods["품목명"] || "").toString().trim()
                           : (r["상품명"] || "").toString().trim();

    const receiverName = (r["수령자명"] || "").toString().trim();
    const orderNo = (r["주문번호"] || "").toString().trim();

    if (!orderQty) { excluded.push(makeExcludeRow("주문량0", receiverName, code, baseName, orderNo)); continue; }
    if (amt < 1)   { excluded.push(makeExcludeRow("금액<1", receiverName, code, baseName, orderNo)); continue; }
    if (baseName.includes("[단종]")) { excluded.push(makeExcludeRow("[단종]", receiverName, code, baseName, orderNo)); continue; }

    let carton = 0, fare = "", alphaTag = "";
    if (goods) {
      carton = toNum(goods["입수량"]);
      fare = (goods["최대운임"] || "").toString().trim();
      alphaTag = (goods["알파"] || "").toString().trim();
    } else {
      missingCodes.add(code);
    }

    const units = toNum(r["입수"]);
    const isSpecial = baseName.includes("시트지") || baseName.includes("아트메이트");
    const totalQty = isSpecial ? orderQty : (units * orderQty);

    splitAndPush(out, r, baseName, alphaTag, totalQty, carton, fare, "alpha");
  }

  out.sort((a,b)=>String(a["받는분성명"]||"").localeCompare(String(b["받는분성명"]||""),"ko"));

  const lines = [];
  if (missingCodes.size > 0) {
    const sample = Array.from(missingCodes).filter(Boolean).slice(0, 10);
    lines.push(`[주의] 품목 파일에서 못 찾은 상품코드: ${missingCodes.size}개`);
    if (sample.length) lines.push(`예시: ${sample.join(", ")}`);
  }

  return { rows: out, excluded, statsText: lines.join("\n") };
}

/* ===============================
   네이버 변환 (옵션은 매칭용만)
   ✅ 품목명 뒤 태그: 공통품목 "NAVER, 이베이" 컬럼값
================================ */
function buildWaybillNaver(rows) {
  const out = [];
  const excluded = [];
  const missingCodes = new Set();

  for (const r of rows) {
    const receiverName = (r["수취인명"] || "").toString().trim();
    const orderNo = (r["주문번호"] || r["상품주문번호"] || "").toString().trim();

    const productNo = normCode(r["상품번호"]);
    const goodsList = goodsNaverListMap.get(productNo) || [];
    const goods = pickBestNaverGoods(goodsList, r["옵션정보"]);

    let baseName = goods
      ? (goods["품목명"] || "").toString().trim()
      : (r["상품명"] || "").toString().trim();

    if (!baseName) baseName = (r["상품명"] || "").toString().trim();

    const fulfillment = normalizeText(r["풀필먼트사"] ?? r["풀필먼트사(주문 기준)"] ?? "");
    if (fulfillment === "위킵") {
      excluded.push(makeExcludeRow("위킵", receiverName, productNo, baseName, orderNo));
      continue;
    }

    const orderQty = pickNaverQty(r);
    const amt = pickAmount(r);

    if (!orderQty) { excluded.push(makeExcludeRow("주문량0", receiverName, productNo, baseName, orderNo)); continue; }
    if (amt < 1)   { excluded.push(makeExcludeRow("금액<1", receiverName, productNo, baseName, orderNo)); continue; }
    if (baseName.includes("[단종]")) { excluded.push(makeExcludeRow("[단종]", receiverName, productNo, baseName, orderNo)); continue; }

    let carton = 0, fare = "", naverTag = "";
    if (goods) {
      carton = toNum(goods["입수량"]);
      fare = (goods["최대운임"] || "").toString().trim();
      naverTag = getNaverEbayTagFromGoods(goods); // "NAVER, 이베이"
    } else {
      missingCodes.add(productNo);
    }

    splitAndPush(out, r, baseName, naverTag, orderQty, carton, fare, "naver");
  }

  out.sort((a,b)=>String(a["받는분성명"]||"").localeCompare(String(b["받는분성명"]||""),"ko"));

  const lines = [];
  if (missingCodes.size > 0) {
    const sample = Array.from(missingCodes).filter(Boolean).slice(0, 10);
    lines.push(`[주의] 품목 파일에서 못 찾은 코드(상품번호): ${missingCodes.size}개`);
    if (sample.length) lines.push(`예시: ${sample.join(", ")}`);
  }

  return { rows: out, excluded, statsText: lines.join("\n") };
}

/* ===============================
   오피스디포 변환
================================ */
function buildWaybillOffice(rows) {
  const out = [];
  const excluded = [];
  const missingCodes = new Set();

  for (const r of rows) {
    const orderQty = toNum(r["주문량"]);
    const amt = pickAmount(r);

    const code = normCode(r["상품코드"]);
    const goods = goodsMap.get(code);

    const baseName = goods ? (goods["품목명"] || "").toString().trim()
                           : (r["상품명"] || "").toString().trim();

    const receiverName = (r["수령자명"] || "").toString().trim();
    const orderNo = (r["주문번호"] || "").toString().trim();

    if (!orderQty) { excluded.push(makeExcludeRow("주문량0", receiverName, code, baseName, orderNo)); continue; }
    if (amt < 1)   { excluded.push(makeExcludeRow("금액<1", receiverName, code, baseName, orderNo)); continue; }
    if (baseName.includes("[단종]")) { excluded.push(makeExcludeRow("[단종]", receiverName, code, baseName, orderNo)); continue; }

    let carton = 0, fare = "", officeTag = "";
    if (goods) {
      carton = toNum(goods["입수량"]);
      fare = (goods["최대운임"] || "").toString().trim();
      officeTag = (goods["오피스디포"] || "").toString().trim();
    } else {
      missingCodes.add(code);
    }

    const units = toNum(r["입수"]);
    const isSpecial = baseName.includes("시트지") || baseName.includes("아트메이트");
    const totalQty = isSpecial ? orderQty : (units * orderQty);

    splitAndPush(out, r, baseName, officeTag, totalQty, carton, fare, "office");
  }

  out.sort((a,b)=>String(a["받는분성명"]||"").localeCompare(String(b["받는분성명"]||""),"ko"));

  const lines = [];
  if (missingCodes.size > 0) {
    const sample = Array.from(missingCodes).filter(Boolean).slice(0, 10);
    lines.push(`[주의] 품목 파일에서 못 찾은 상품코드: ${missingCodes.size}개`);
    if (sample.length) lines.push(`예시: ${sample.join(", ")}`);
  }

  return { rows: out, excluded, statsText: lines.join("\n") };
}

/* ===============================
   밸류포인트 변환
================================ */
function buildWaybillValuePoint(rows) {
  const out = [];
  const excluded = [];
  const missingCodes = new Set();

  for (const r of rows) {
    const orderQty = toNum(r["주문량"]);
    const amt = pickAmount(r);

    const code = normCode(r["상품코드"]);
    const goods = goodsMap.get(code);

    const baseName = goods ? (goods["품목명"] || "").toString().trim()
                           : (r["상품명"] || "").toString().trim();

    const receiverName = (r["수령자명"] || "").toString().trim();
    const orderNo = (r["주문번호"] || "").toString().trim();

    if (!orderQty) { excluded.push(makeExcludeRow("주문량0", receiverName, code, baseName, orderNo)); continue; }
    if (amt < 1)   { excluded.push(makeExcludeRow("금액<1", receiverName, code, baseName, orderNo)); continue; }
    if (baseName.includes("[단종]")) { excluded.push(makeExcludeRow("[단종]", receiverName, code, baseName, orderNo)); continue; }

    let carton = 0, fare = "", vpTag = "";
    if (goods) {
      carton = toNum(goods["입수량"]);
      fare = (goods["최대운임"] || "").toString().trim();
      vpTag = (goods["밸류포인트"] || "").toString().trim();
    } else {
      missingCodes.add(code);
    }

    let units = toNum(r["입수"]);
    if (!units || units <= 0) units = 1;

    const isSpecial = baseName.includes("시트지") || baseName.includes("아트메이트");
    const totalQty = isSpecial ? orderQty : (units * orderQty);

    splitAndPush(out, r, baseName, vpTag, totalQty, carton, fare, "valuepoint");
  }

  out.sort((a,b)=>String(a["받는분성명"]||"").localeCompare(String(b["받는분성명"]||""),"ko"));

  const lines = [];
  if (missingCodes.size > 0) {
    const sample = Array.from(missingCodes).filter(Boolean).slice(0, 10);
    lines.push(`[주의] 품목 파일에서 못 찾은 밸류포인트 상품코드: ${missingCodes.size}개`);
    if (sample.length) lines.push(`예시: ${sample.join(", ")}`);
  }

  return { rows: out, excluded, statsText: lines.join("\n") };
}

/* ===============================
   오피스넥스 변환
================================ */
function buildWaybillOfficeNex(rows) {
  const out = [];
  const excluded = [];
  const missingCodes = new Set();

  for (const r of rows) {
    const orderQty = toNum(r["주문량"]);
    const amt = pickAmount(r);

    const code = normCode(r["상품코드"]);
    const goods = goodsMap.get(code);

    const baseName = goods ? (goods["품목명"] || "").toString().trim()
                           : (r["상품명"] || "").toString().trim();

    const receiverName = (r["수령자명"] || "").toString().trim();
    const orderNo = (r["주문번호"] || "").toString().trim();

    if (!orderQty) { excluded.push(makeExcludeRow("주문량0", receiverName, code, baseName, orderNo)); continue; }
    if (amt < 1)   { excluded.push(makeExcludeRow("금액<1", receiverName, code, baseName, orderNo)); continue; }
    if (baseName.includes("[단종]")) { excluded.push(makeExcludeRow("[단종]", receiverName, code, baseName, orderNo)); continue; }

    let carton = 0, fare = "", nexTag = "";
    if (goods) {
      carton = toNum(goods["입수량"]);
      fare = (goods["최대운임"] || "").toString().trim();
      nexTag = (goods["오피스넥스"] || "").toString().trim();
    } else {
      missingCodes.add(code);
    }

    let units = toNum(r["입수"]);
    if (!units || units <= 0) units = 1;

    const isSpecial = baseName.includes("시트지") || baseName.includes("아트메이트");
    const totalQty = isSpecial ? orderQty : (units * orderQty);

    splitAndPush(out, r, baseName, nexTag, totalQty, carton, fare, "officenex");
  }

  out.sort((a,b)=>String(a["받는분성명"]||"").localeCompare(String(b["받는분성명"]||""),"ko"));

  const lines = [];
  if (missingCodes.size > 0) {
    const sample = Array.from(missingCodes).filter(Boolean).slice(0, 10);
    lines.push(`[주의] 품목 파일에서 못 찾은 오피스넥스 코드: ${missingCodes.size}개`);
    if (sample.length) lines.push(`예시: ${sample.join(", ")}`);
  }

  return { rows: out, excluded, statsText: lines.join("\n") };
}

/* ===============================
   ✅ 이베이 변환(옥션/지마켓)
================================ */
function buildWaybillEbay(rows) {
  const out = [];
  const excluded = [];
  const missingCodes = new Set();

  for (const r of rows) {
    const sellerId = (r["판매아이디"] || "").toString().trim();
    const platform = detectEbayPlatform(sellerId); // "옥션" | "지마켓" | ""

    const orderQty = toNum(firstNonEmpty(r, ["수량", "주문수량", "구매수량"]));
    const amt = pickAmount(r);

    const productNo = normCode(firstNonEmpty(r, ["상품번호", "상품코드", "판매상품번호", "옵션관리코드"]));

    let goods = null;
    if (platform === "옥션") goods = goodsAuctionMap.get(productNo) || null;
    else if (platform === "지마켓") goods = goodsGmarketMap.get(productNo) || null;
    else goods = goodsMap.get(productNo) || null;

    const baseName = goods ? (goods["품목명"] || "").toString().trim()
                           : (r["상품명"] || r["상품명(옵션포함)"] || "").toString().trim();

    const receiverName = (r["수령인명"] || r["수취인명"] || "").toString().trim();
    const orderNo = (r["주문번호"] || r["주문번호(통합)"] || "").toString().trim();

    if (!orderQty) { excluded.push(makeExcludeRow("주문량0", receiverName, productNo, baseName, orderNo)); continue; }
    if (amt < 1)   { excluded.push(makeExcludeRow("금액<1", receiverName, productNo, baseName, orderNo)); continue; }
    if (baseName.includes("[단종]")) { excluded.push(makeExcludeRow("[단종]", receiverName, productNo, baseName, orderNo)); continue; }

    let carton = 0, fare = "", tag = "";
    if (goods) {
      carton = toNum(goods["입수량"]);
      fare = (goods["최대운임"] || "").toString().trim();
      tag = getNaverEbayTagFromGoods(goods); // "NAVER, 이베이"
    } else {
      missingCodes.add(`${platform || "이베이"}:${productNo}`);
    }

    splitAndPush(out, r, baseName, tag, orderQty, carton, fare, "ebay");
  }

  out.sort((a,b)=>String(a["받는분성명"]||"").localeCompare(String(b["받는분성명"]||""),"ko"));

  const lines = [];
  if (missingCodes.size > 0) {
    const sample = Array.from(missingCodes).filter(Boolean).slice(0, 10);
    lines.push(`[주의] 품목 파일에서 못 찾은 이베이 코드: ${missingCodes.size}개`);
    if (sample.length) lines.push(`예시: ${sample.join(", ")}`);
  }

  return { rows: out, excluded, statsText: lines.join("\n") };
}

/* ===============================
   ✅ 드림오피스 변환 (수주처리_상세현황)
   - 주문파일 컬럼(확인): 발주번호, 상품코드, 상품명, 수량, 출고수량, 합계,
                         출고메모, 배송처, 거래처명, 배송주소, 전화번호, 핸드폰, 주문메세지 등
   - 공통품목: "드림오피스 품목코드"로 goodsMap 매칭
================================ */
function buildWaybillDreamOffice(rows) {
  const out = [];
  const excluded = [];
  const missingCodes = new Set();

  for (const r of rows) {
    const qtyShip = toNum(r["출고수량"]);
    const qtyOrd  = toNum(r["수량"]);
    const orderQty = qtyShip > 0 ? qtyShip : qtyOrd;

    const amt = pickAmount(r);

    const code = normCode(r["상품코드"]);
    const goods = goodsMap.get(code);

    const baseName = goods ? (goods["품목명"] || "").toString().trim()
                           : (r["상품명"] || "").toString().trim();

    const receiverName = (r["배송처"] || r["거래처명"] || "").toString().trim();
    const orderNo = (r["발주번호"] || "").toString().trim();

    if (!orderQty) { excluded.push(makeExcludeRow("주문량0", receiverName, code, baseName, orderNo)); continue; }
    if (amt < 1)   { excluded.push(makeExcludeRow("금액<1", receiverName, code, baseName, orderNo)); continue; }
    if (baseName.includes("[단종]")) { excluded.push(makeExcludeRow("[단종]", receiverName, code, baseName, orderNo)); continue; }

    let carton = 0, fare = "", dreamTag = "";
    if (goods) {
      carton = toNum(goods["입수량"]);
      fare = (goods["최대운임"] || "").toString().trim();
      // (선택) 공통품목에 표기용 "드림오피스" 컬럼이 있으면 품목명에 붙음
      dreamTag = (goods["드림오피스"] || "").toString().trim();
    } else {
      missingCodes.add(code);
    }

    splitAndPush(out, r, baseName, dreamTag, orderQty, carton, fare, "dreamoffice");
  }

  out.sort((a,b)=>String(a["받는분성명"]||"").localeCompare(String(b["받는분성명"]||""),"ko"));

  const lines = [];
  if (missingCodes.size > 0) {
    const sample = Array.from(missingCodes).filter(Boolean).slice(0, 10);
    lines.push(`[주의] 품목 파일에서 못 찾은 드림오피스 상품코드: ${missingCodes.size}개`);
    if (sample.length) lines.push(`예시: ${sample.join(", ")}`);
  }

  return { rows: out, excluded, statsText: lines.join("\n") };
}

/* ===============================
   네이버 수량 추출
================================ */
function pickNaverQty(r) {
  if (Object.prototype.hasOwnProperty.call(r, "수량")) return toNum(r["수량"]);

  const keys = Object.keys(r);
  for (const k of keys) {
    const kk = String(k).replace(/\u00A0/g, "").replace(/\s+/g, "");
    if (kk === "수량") return toNum(r[k]);
  }
  for (const k of keys) {
    const kk = String(k).replace(/\u00A0/g, "").replace(/\s+/g, "");
    if (kk.includes("수량") && !kk.includes("클레임")) return toNum(r[k]);
  }
  return 0;
}

/* ===============================
   카톤 분할 + 행 추가
================================ */
function splitAndPush(out, r, baseName, vendorTag, totalQty, carton, fare, mode) {
  const totalQtyInt = Math.round(totalQty);
  const cartonInt = Math.round(carton);

  let mainQty = totalQtyInt;
  let boxQty = 1;
  let remainder = 0;

  if (cartonInt > 0 && totalQtyInt > cartonInt) {
    boxQty = Math.floor(totalQtyInt / cartonInt);
    mainQty = cartonInt;
    remainder = totalQtyInt - cartonInt * boxQty;
  }
  if (remainder < 0) remainder = 0;

  out.push(makeWaybillRow(r, baseName, vendorTag, mainQty, boxQty, fare, mode, cartonInt));
  if (remainder > 0) out.push(makeWaybillRow(r, baseName, vendorTag, remainder, 1, fare, mode, cartonInt));
}

/* ===============================
   waybill row 생성
================================ */
function makeWaybillRow(r, baseName, vendorTag, qty, boxQty, fare, mode, cartonSize) {
  let receiver="", addr="", phone1="", phone2="", memo="", orderNo="", purchaser="";

  if (mode === "naver") {
    receiver = (r["수취인명"] || "").toString().trim();
    addr = (r["통합배송지"] || "").toString().trim();
    phone1 = (r["수취인연락처1"] || "").toString().trim();
    phone2 = (r["수취인연락처2"] || "").toString().trim();
    memo = (firstNonEmpty(r, ["배송메세지", "배송메시지", "배송요청사항", "요청사항"]) || "").toString().trim();
    orderNo = (r["주문번호"] || r["상품주문번호"] || "").toString().trim();
  } else if (mode === "ebay") {
    receiver = (r["수령인명"] || r["수취인명"] || "").toString().trim();
    addr = (r["주소"] || r["배송지주소"] || "").toString().trim();
    phone1 = (r["수령인 휴대폰"] || r["수취인휴대폰"] || "").toString().trim();
    phone2 = (r["수령인 전화번호"] || r["수취인전화번호"] || "").toString().trim();
    memo = (r["배송시 요구사항"] || r["배송요청사항"] || "").toString().trim();
    orderNo = (r["주문번호"] || r["주문번호(통합)"] || "").toString().trim();
  } else if (mode === "dreamoffice") {
    receiver = (r["배송처"] || r["거래처명"] || "").toString().trim();
    addr = (r["배송주소"] || "").toString().trim();
    phone1 = (r["핸드폰"] || "").toString().trim();
    phone2 = (r["전화번호"] || "").toString().trim();
    memo = (r["주문메세지"] || r["출고메모"] || "").toString().trim();
    orderNo = (r["발주번호"] || "").toString().trim();
    purchaser = (r["거래처명"] || "").toString().trim();
  } else {
    receiver = (r["수령자명"] || "").toString().trim();
    addr = (r["수령자 주소"] || "").toString().trim();
    phone1 = (r["수령자 전화번호"] || "").toString().trim();
    phone2 = (r["수령자 휴대전화"] || "").toString().trim();
    memo = (r["요청메모"] || "").toString().trim();
    orderNo = (r["주문번호"] || "").toString().trim();
    purchaser = (r["발주처"] || "").toString().trim();
  }

  const originalReceiver = receiver;
  const receiverNorm = String(originalReceiver || "").replace(/\s+/g, "");

  // 밸류포인트 특수 수령자
  const isValuePointSpecialReceiver =
    mode === "valuepoint" &&
    (receiverNorm.includes("남궁현식") || receiverNorm.includes("김남석담당"));
  if (isValuePointSpecialReceiver) receiver = "밸류포인트";

  // 오피스넥스 물류센터 규칙
  const purchaserNorm = String(purchaser || "").replace(/\s+/g, "");
  const isOfficeNexCenter =
    mode === "officenex" &&
    purchaserNorm.includes("넥스물류센터") &&
    receiverNorm.includes("넥스물류센터");
  if (isOfficeNexCenter) receiver = "오피스넥스";

  // ✅ 오피스디포 물류센터 규칙(수령자=물류센터 & 발주처=물류센터)
  const isOfficeWarehouse =
    mode === "office" &&
    purchaserNorm.includes("물류센터") &&
    receiverNorm.includes("물류센터");

  // ✅ 드림오피스 가산물류: 받는분성명에 "드림오피스 가산물류" 포함이면 보내는분성명 라미에이스
  const isDreamOfficeGasan =
    mode === "dreamoffice" &&
    receiverNorm.includes("드림오피스가산물류");

  // 1차 보정: 둘 다 비면 주문자 연락처로
  if (!phone1 && !phone2) {
    phone1 = (r["주문자 전화번호"] || r["구매자연락처"] || r["구매자 전화번호"] || "").toString().trim();
    phone2 = (r["주문자 휴대전화"] || r["구매자 휴대폰"] || "").toString().trim();
  } else if (!phone1) {
    phone1 = phone2;
  }

  // phone1이 0으로 시작하지 않으면 phone2를 phone1로 승격
  if (phone1 && !String(phone1).trim().startsWith("0") && phone2) {
    const prev1 = phone1;
    phone1 = phone2;
    phone2 = (normalizePhone(prev1) === normalizePhone(phone1)) ? "" : prev1;
  }

  // phone2가 0으로 시작하지 않으면 공란
  if (phone2 && !String(phone2).trim().startsWith("0")) phone2 = "";

  // 보내는분성명
  let senderName = "";
  if (mode === "naver") senderName = "네이버";
  else if (mode === "ebay") {
    const platform = detectEbayPlatform((r["판매아이디"] || "").toString());
    senderName = platform || "이베이";
  }
  else if (mode === "office") {
    senderName = isOfficeWarehouse ? "라미에이스" : "오피스디포";
  } else if (mode === "valuepoint") {
    senderName = isValuePointSpecialReceiver ? "라미에이스" : "밸류포인트";
  } else if (mode === "officenex") {
    senderName = isOfficeNexCenter ? "라미에이스" : "오피스넥스";
  } else if (mode === "dreamoffice") {
    // ✅ 요청 반영
    senderName = isDreamOfficeGasan ? "라미에이스" : "드림오피스";
  } else {
    if (purchaser === "안성물류" && originalReceiver === "안성물류") senderName = "라미에이스";
    else {
      const isSpecialStore =
        (purchaser === "동부이촌점" || purchaser === "본점") &&
        originalReceiver !== "" &&
        originalReceiver === purchaser;

      senderName = (purchaser === "안성물류") ? "알파 안성" : "";
      if (isSpecialStore) senderName = "라미에이스";
    }
  }

  // 품목명 규칙
  let itemName = baseName;
  const dupKey = `${receiver}|${addr}|${phone1}`;

  // 오피스디포: 컬럼값만 붙임(값 있을 때만) + 조기 return
  if (mode === "office" && vendorTag && String(vendorTag).trim() !== "") {
    const odVal = String(vendorTag).trim();
    itemName = `${baseName} ${odVal}`.replace(/\s+/g, " ").trim();

    return {
      "중복": "",
      "받는분성명": receiver,
      "받는분주소(전체, 분할)": addr,
      "받는분전화번호": phone1,
      "받는분기타연락처": phone2,
      "품목명": `${itemName} - ${qty}EA`,
      "박스수량": boxQty,
      "기본운임": fare,
      "운임구분": "",
      "보내는분성명": senderName,
      "보내는분주소(전체, 분할)": SENDER_ADDR,
      "보내는분전화번호": SENDER_PHONE,
      "배송메세지1": memo,
      "주문번호": orderNo,
      "__qty": qty,
      "__carton": cartonSize,
      "__dupKey": dupKey
    };
  }

  // 밸류포인트/오피스넥스/드림오피스: vendorTag(해당 컬럼 값) 붙임(있을 때만)
  if ((mode === "valuepoint" || mode === "officenex" || mode === "dreamoffice") && vendorTag && String(vendorTag).trim() !== "") {
    const v = String(vendorTag).trim().replace(/\s*-\s*$/g, "");
    if (v) itemName = `${baseName} ${v}`.replace(/\s+/g, " ").trim();
  }

  // 네이버/이베이: "NAVER, 이베이" 값 붙임(있을 때만)  (vendorTag로 넘어옴)
  if ((mode === "naver" || mode === "ebay") && vendorTag && String(vendorTag).trim() !== "") {
    const cleaned = String(vendorTag).trim().replace(/\s*-\s*$/g, "");
    if (cleaned) itemName = `${baseName} ${cleaned}`.replace(/\s+/g, " ").trim();
  }

  // 알파: 알파 컬럼값 붙임(있을 때만)
  if (mode === "alpha" && vendorTag && String(vendorTag).trim() !== "") {
    const cleaned = String(vendorTag).trim().replace(/\s*-\s*$/g, "");
    if (cleaned) itemName = `${baseName} ${cleaned}`.replace(/\s+/g, " ").trim();
  }

  return {
    "중복": "",
    "받는분성명": receiver,
    "받는분주소(전체, 분할)": addr,
    "받는분전화번호": phone1,
    "받는분기타연락처": phone2,
    "품목명": `${itemName} - ${qty}EA`,
    "박스수량": boxQty,
    "기본운임": fare,
    "운임구분": "",
    "보내는분성명": senderName,
    "보내는분주소(전체, 분할)": SENDER_ADDR,
    "보내는분전화번호": SENDER_PHONE,
    "배송메세지1": memo,
    "주문번호": orderNo,
    "__qty": qty,
    "__carton": cartonSize,
    "__dupKey": dupKey
  };
}

/* ===============================
   ✅ 중복 컬럼 채우기
   - 동일(받는분성명+주소+전화) 그룹이 2개 이상일 때
   - qty != 입수량(carton) 인 행 개수(notFullCount) 계산
   - notFullCount가 2 이상일 때만, "입수량이 아닌 행"에만 표기
================================ */
function applyDuplicateColumn(rows) {
  const groups = new Map();

  for (const row of rows) {
    const key =
      row.__dupKey ??
      `${row["받는분성명"] || ""}|${row["받는분주소(전체, 분할)"] || ""}|${row["받는분전화번호"] || ""}`;
    if (!groups.has(key)) groups.set(key, []);
    groups.get(key).push(row);
  }

  for (const list of groups.values()) {
    for (const row of list) row["중복"] = "";
    if (list.length < 2) continue;

    const notFullRows = list.filter(row => {
      const q = Number(row.__qty ?? 0);
      const c = Number(row.__carton ?? 0);
      return c > 0 && q !== c;
    });

    const notFullCount = notFullRows.length;
    if (notFullCount <= 1) continue; // ✅ 1이면 생략
    for (const row of notFullRows) row["중복"] = notFullCount; // ✅ 입수량행은 표기 안 함
  }

  for (const row of rows) {
    delete row.__qty;
    delete row.__carton;
    delete row.__dupKey;
  }
}

/* ===============================
   금액 후보 선택
================================ */
function pickAmount(r) {
  const candidates = [
    "합계",                  // ✅ 드림오피스 파일
    "합계금액",
    "납품금액",
    "최종 상품별 총 주문금액",
    "상품가격",
    "최초 상품별 총 주문금액",
    "정산예정금액",
    "판매금액"
  ];
  for (const k of candidates) {
    if (r && Object.prototype.hasOwnProperty.call(r, k)) return toNum(r[k]);
  }
  return 999999;
}

/* ===============================
   공통 품목 파일 코드 수집
================================ */
function collectGoodsCodes(row) {
  const codes = [];
  const preferred = [
    "알파 상품코드",
    "네이버 상품코드",
    "밸류포인트 상품코드",
    "오피스넥스 품목코드",
    "드림오피스 품목코드",
    "옥션 상품코드",
    "지마켓 상품코드",
    "네이버 상품번호",
    "상품번호",
    "상품코드",
    "옵션관리코드",
    "판매자 상품코드",
    "품목코드"
  ];

  for (const k of preferred) {
    if (row[k]) codes.push(...splitCodes(row[k]));
  }

  for (const k of Object.keys(row)) {
    if (preferred.includes(k)) continue;
    if (String(k).includes("상품코드") && row[k]) {
      codes.push(...splitCodes(row[k]));
    }
  }

  return Array.from(new Set(codes));
}

function firstNonEmpty(r, keys) {
  for (const k of keys) {
    const v = r[k];
    if (v !== undefined && v !== null && String(v).trim() !== "") return v;
  }
  return "";
}

/* ===============================
   ✅ 공통 품목 파일의 "NAVER, 이베이" 컬럼 값 읽기 (네이버/이베이 공용)
================================ */
function getNaverEbayTagFromGoods(goodsRow) {
  if (!goodsRow) return "";

  const direct = goodsRow["NAVER, 이베이"];
  if (direct !== undefined && direct !== null && String(direct).trim() !== "") {
    return String(direct).trim();
  }

  // 공백/특수공백/대소문자 차이 대비
  for (const k of Object.keys(goodsRow)) {
    const nk = String(k)
      .replace(/\u00A0/g, " ")
      .replace(/\s+/g, "")
      .trim()
      .toUpperCase();

    if (nk === "NAVER,이베이" || nk === "NAVER,EBAY") {
      const v = goodsRow[k];
      if (v !== undefined && v !== null && String(v).trim() !== "") {
        return String(v).trim();
      }
    }
  }
  return "";
}

/* ===============================
   제외 표
================================ */
function clearExcludeTable() {
  excludeWrapEl.style.display = "none";
  excludeTableEl.innerHTML = "";
  excludeCountEl.textContent = "0건";
  excludeNoteEl.style.display = "none";
  excludeNoteEl.textContent = "";
}

function renderExcludeTable(list) {
  const count = list?.length || 0;
  if (count === 0) { clearExcludeTable(); return; }

  excludeWrapEl.style.display = "block";
  excludeCountEl.textContent = `${count}건`;

  const keys = ["제외사유", "받는분성명", "상품코드", "품목명", "주문번호"];
  const maxShow = 300;
  const rows = list.slice(0, maxShow);

  let html = "<table><thead><tr>";
  for (const k of keys) html += `<th>${escapeHtml(k)}</th>`;
  html += "</tr></thead><tbody>";

  for (const r of rows) {
    html += "<tr>";
    for (const k of keys) html += `<td>${escapeHtml(r[k] ?? "")}</td>`;
    html += "</tr>";
  }
  html += "</tbody></table>";

  excludeTableEl.innerHTML = html;

  if (count > maxShow) {
    excludeNoteEl.style.display = "block";
    excludeNoteEl.textContent = `※ 화면에는 ${maxShow}행까지만 표시됩니다. (전체 ${count}행)`;
  }
}

/* ===============================
   엑셀 읽기
================================ */
async function readExcelFirstSheet(file) {
  const data = await file.arrayBuffer();
  const wb = XLSX.read(data);
  const ws = wb.Sheets[wb.SheetNames[0]];
  return XLSX.utils.sheet_to_json(ws, { defval: "" });
}

async function readExcelByBestSheet(file, sheetCandidates) {
  const data = await file.arrayBuffer();
  const wb = XLSX.read(data);

  let ws = null;
  for (const name of sheetCandidates) {
    if (wb.Sheets[name]) { ws = wb.Sheets[name]; break; }
  }
  if (!ws) ws = wb.Sheets[wb.SheetNames[0]];

  return XLSX.utils.sheet_to_json(ws, { defval: "" });
}

/* ===============================
   미리보기
================================ */
function showPreview(rows, title) {
  if (!rows || !rows.length) { previewEl.innerHTML = "<em>미리보기 데이터가 없습니다.</em>"; return; }

  const sample = rows.slice(0, 10);
  const keys = Object.keys(sample[0]);

  let html = `<div style="margin-bottom:8px;">${escapeHtml(title)} (상위 ${sample.length}행)</div>`;
  html += "<table><thead><tr>";
  for (const k of keys) html += `<th>${escapeHtml(k)}</th>`;
  html += "</tr></thead><tbody>";

  for (const r of sample) {
    html += "<tr>";
    for (const k of keys) html += `<td>${escapeHtml(r[k])}</td>`;
    html += "</tr>";
  }
  html += "</tbody></table>";

  previewEl.innerHTML = html;
}

/* ===============================
   유틸
================================ */
function normCode(x) {
  if (x === null || x === undefined) return "";
  let s = String(x).trim();
  if (/^\d+\.0$/.test(s)) s = s.slice(0, -2);
  return s;
}

function toNum(x) {
  if (x === null || x === undefined) return 0;
  if (typeof x === "number") return Number.isFinite(x) ? x : 0;

  let s = String(x)
    .replace(/\u00A0/g, " ")
    .replace(/,/g, "")
    .trim();

  if (!s) return 0;

  const n = Number(s);
  if (Number.isFinite(n)) return n;

  const m = s.match(/-?\d+(\.\d+)?/);
  return m ? Number(m[0]) : 0;
}

function normalizeText(v) {
  return (v ?? "")
    .toString()
    .replace(/\u00A0/g, " ")
    .trim()
    .replace(/\s+/g, "");
}

function normalizePhone(v) {
  return String(v ?? "").replace(/[^\d]/g, "");
}

function setStatus(t) { statusEl.textContent = t; }

function escapeHtml(v) {
  if (v === null || v === undefined) return "";
  return String(v)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/"/g, "&quot;");
}

function splitCodes(v) {
  if (v === null || v === undefined) return [];
  const s = String(v).trim();
  if (!s) return [];
  return s
    .split(/[,\n\/\|]/g)
    .map(x => String(x).trim())
    .filter(Boolean);
}

// ✅ 이베이 플랫폼 판별 (판매아이디 기준)
function detectEbayPlatform(sellerId) {
  const s = String(sellerId || "").replace(/\s+/g, "");
  if (s.includes("옥션")) return "옥션";
  if (s.includes("지마켓")) return "지마켓";
  return "";
}

/* ===============================
   네이버 옵션 매칭 (2옵션 이상 대응) - 매칭용만!
================================ */
function optionTokens(v) {
  let s = (v ?? "").toString().replace(/\u00A0/g, " ").trim();
  if (!s || s.toLowerCase() === "nan") return [];

  const parts = s.split(/[\/\|\n]/).map(x => x.trim()).filter(Boolean);

  let tokens = [];
  for (let p of parts) {
    const m = p.match(/[:=]\s*(.+)$/);
    let val = (m ? m[1] : p).trim();
    if (!val) continue;
    tokens.push(...val.split(/[,，]/).map(x => x.trim()).filter(Boolean));
  }

  tokens = tokens
    .map(t => t.replace(/\s+/g, " ").trim())
    .map(t => {
      const mm = t.match(/^(\d+)\s*mm$/i);
      return mm ? mm[1] : t;
    })
    .filter(Boolean);

  const seen = new Set();
  const out = [];
  for (const t of tokens) {
    if (!seen.has(t)) { seen.add(t); out.push(t); }
  }
  return out;
}

function nameIncludesAllTokens(name, tokens) {
  const n = (name ?? "").toString();
  return tokens.every(t => {
    if (!t) return true;
    if (/^\d+$/.test(t)) return n.includes(t) || n.includes(`${t}mm`);
    return n.includes(t);
  });
}

function pickBestNaverGoods(goodsList, optionInfo) {
  if (!goodsList || goodsList.length === 0) return null;

  const orderTokens = optionTokens(optionInfo);

  if (orderTokens.length > 0) {
    let hit = goodsList.find(gr => {
      const gTokens = optionTokens(gr["옵션"]);
      return gTokens.length > 0 && orderTokens.every(t => gTokens.includes(t));
    });
    if (hit) return hit;

    hit = goodsList.find(gr => nameIncludesAllTokens(gr["품목명"], orderTokens));
    if (hit) return hit;

    if (goodsList.length === 1) return goodsList[0];
    return null;
  }

  let hit = goodsList.find(gr => optionTokens(gr["옵션"]).length === 0);
  if (hit) return hit;

  if (goodsList.length === 1) return goodsList[0];
  return null;
}
</script>
</body>
</html>
