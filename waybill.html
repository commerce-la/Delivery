<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ìš´ì†¡ì¥ ë³€í™˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SheetJS (ë¸Œë¼ìš°ì €ìš©) -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      line-height: 1.5;
    }
    main {
      max-width: 1040px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }
    .title { font-size: 18px; margin: 0 0 8px; }
    .subtitle { font-size: 13px; color: #9ca3af; margin-bottom: 18px; }

    .card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.4);
      margin-bottom: 24px;
    }
    .card h2 { margin-top: 0; font-size: 20px; margin-bottom: 8px; }
    .card p { margin-top: 0; margin-bottom: 16px; color: #cbd5f5; font-size: 14px; }

    .file-input { margin: 8px 0 16px; }
    input[type="file"], select { font-size: 14px; }

    button {
      margin-top: 16px;
      padding: 10px 20px;
      border-radius: 9999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      background: #2563eb;
      color: #f9fafb;
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .status {
      margin-top: 8px;
      font-size: 13px;
      color: #a5b4fc;
      min-height: 18px;
    }

    .preview {
      margin-top: 24px;
      font-size: 13px;
      color: #e5e7eb;
      max-height: 260px;
      overflow: auto;
      border-top: 1px solid rgba(148, 163, 184, 0.4);
      padding-top: 16px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 12px;
      background: rgba(15, 23, 42, 0.9);
    }
    th, td {
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 4px 6px;
      white-space: nowrap;
    }
    th { background: rgba(37, 99, 235, 0.3); }

    .mapping { margin-top: 16px; font-size: 13px; }
    .mapping-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px 16px;
      margin-top: 12px;
    }
    .mapping-item { display: flex; flex-direction: column; gap: 4px; }
    .mapping-item label { font-size: 12px; color: #e5e7eb; }
    .mapping-item select {
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
    }
    .mapping-hint { font-size: 12px; color: #9ca3af; margin-top: 4px; }

    .section-title { font-size: 16px; margin-top: 0; margin-bottom: 8px; }
    .sub-status { font-size: 12px; color: #9ca3af; margin-top: 4px; min-height: 16px; }
  </style>
</head>
<body>
  <main>
    <h1 class="title">ìš´ì†¡ì¥ ë³€í™˜</h1>
    <p class="subtitle">ì•ŒíŒŒ / ë„¤ì´ë²„ / ì˜¤í”¼ìŠ¤ë””í¬ ì „ìš© ê·œì¹™ì„ ì‚¬ìš©í•˜ì—¬ ì£¼ë¬¸ ì—‘ì…€ì„ waybill í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.</p>

    <!-- 1. ì—…ì²´ëª… ì„ íƒ -->
    <div class="card">
      <h2>1. ì—…ì²´ëª… ì„ íƒ</h2>
      <p>ë¨¼ì € ì–´ë–¤ ì—…ì²´ì˜ ê·œì¹™ì„ ì‚¬ìš©í• ì§€ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>

      <div class="mapping-item" style="max-width: 260px;">
        <label for="vendor-select">ì—…ì²´ëª…</label>
        <select id="vendor-select">
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          <option value="ì•ŒíŒŒ">ì•ŒíŒŒ</option>
          <option value="ë„¤ì´ë²„">ë„¤ì´ë²„</option>
          <option value="ì˜¤í”¼ìŠ¤ë””í¬">ì˜¤í”¼ìŠ¤ë””í¬</option>
        </select>
        <div class="mapping-hint">
          * ì•ŒíŒŒëŠ” í’ˆëª© íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤. ë„¤ì´ë²„/ì˜¤í”¼ìŠ¤ë””í¬ëŠ” ìˆ˜ë ¹ì ì»¬ëŸ¼ ì „ìš© ë§¤í•‘ë§Œ ì ìš©ë©ë‹ˆë‹¤.
        </div>
      </div>
      <div class="status" id="status-vendor"></div>
    </div>

    <!-- 2. íŒŒì¼ ì—…ë¡œë“œ -->
    <div class="card">
      <h2>2. í’ˆëª© íŒŒì¼ & ì£¼ë¬¸ íŒŒì¼ ì—…ë¡œë“œ</h2>
      <p>
        <strong>í’ˆëª© íŒŒì¼</strong>: ìƒí’ˆì½”ë“œ, í’ˆëª©ëª…, ì…ìˆ˜, ìƒí’ˆë¶„ë¥˜1, ê¸°ë³¸, ì¹´í†¤, ìš´ì„ ë“±<br />
        <strong>ì£¼ë¬¸ íŒŒì¼</strong>: ì‹¤ì œ ì£¼ë¬¸ ë°ì´í„°
      </p>

      <h3 class="section-title">2-1. í’ˆëª© íŒŒì¼ ì—…ë¡œë“œ (ì•ŒíŒŒ ìƒí’ˆ ë§ˆìŠ¤í„°)</h3>
      <div class="file-input">
        <input type="file" id="file-input-items" accept=".xlsx,.xls" />
      </div>
      <div class="sub-status" id="status-items">í’ˆëª© íŒŒì¼ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”. (ì•ŒíŒŒ ì „ìš© ê·œì¹™ì— í•„ìš”)</div>

      <h3 class="section-title" style="margin-top:20px;">2-2. ì£¼ë¬¸ íŒŒì¼ ì—…ë¡œë“œ</h3>
      <div class="file-input">
        <input type="file" id="file-input-orders" accept=".xlsx,.xls" />
      </div>
      <div class="sub-status" id="status-orders">ì£¼ë¬¸ íŒŒì¼ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.</div>

      <div class="mapping" id="mapping">
        ì£¼ë¬¸ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ì—´ ë§¤í•‘ ì˜µì…˜ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
      </div>
    </div>

    <!-- 3. ë³€í™˜ -->
    <div class="card">
      <h2>3. ë¯¸ë¦¬ë³´ê¸° & ë³€í™˜ ì‹¤í–‰</h2>
      <p>
        ì£¼ë¬¸ íŒŒì¼ ìƒìœ„ ì¼ë¶€ í–‰ì„ ë¯¸ë¦¬ ë³´ì—¬ì¤ë‹ˆë‹¤. í™•ì¸ í›„ <strong>ì—‘ì…€ ë³€í™˜í•˜ê¸°</strong>ë¥¼ ëˆ„ë¥´ì„¸ìš”.
      </p>

      <button id="convert-btn" disabled>ì—‘ì…€ ë³€í™˜í•˜ê¸° (waybill.xlsx)</button>
      <div class="status" id="status-convert"></div>
      <div class="preview" id="preview"></div>
    </div>
  </main>

  <script>
    const vendorSelect      = document.getElementById("vendor-select");
    const statusVendorEl    = document.getElementById("status-vendor");

    const fileInputItems    = document.getElementById("file-input-items");
    const fileInputOrders   = document.getElementById("file-input-orders");
    const statusItemsEl     = document.getElementById("status-items");
    const statusOrdersEl    = document.getElementById("status-orders");

    const convertBtn        = document.getElementById("convert-btn");
    const statusConvertEl   = document.getElementById("status-convert");
    const previewEl         = document.getElementById("preview");
    const mappingEl         = document.getElementById("mapping");

    let selectedVendor = "";
    let itemRows  = [];
    let orderRows = [];
    let orderHeaders = [];

    const WAYBILL_FIELDS = [
      { key: "ë°›ëŠ”ë¶„ì„±ëª…",               label: "ë°›ëŠ”ë¶„ ì„±ëª…" },
      { key: "ë°›ëŠ”ë¶„ì£¼ì†Œ(ì „ì²´, ë¶„í• )",    label: "ë°›ëŠ”ë¶„ ì£¼ì†Œ(ì „ì²´, ë¶„í• )" },
      { key: "ë°›ëŠ”ë¶„ì „í™”ë²ˆí˜¸",           label: "ë°›ëŠ”ë¶„ ì „í™”ë²ˆí˜¸" },
      { key: "ë°›ëŠ”ë¶„ê¸°íƒ€ì—°ë½ì²˜",         label: "ë°›ëŠ”ë¶„ ê¸°íƒ€ ì—°ë½ì²˜" },
      { key: "í’ˆëª©ëª…",                  label: "í’ˆëª©ëª…" },
      { key: "ë°•ìŠ¤ìˆ˜ëŸ‰",                label: "ë°•ìŠ¤ ìˆ˜ëŸ‰" },
      { key: "ê¸°ë³¸ìš´ì„",                label: "ê¸°ë³¸ ìš´ì„" },
      { key: "ìš´ì„êµ¬ë¶„",                label: "ìš´ì„ êµ¬ë¶„" },
      { key: "ë³´ë‚´ëŠ”ë¶„ì„±ëª…",            label: "ë³´ë‚´ëŠ”ë¶„ ì„±ëª…" },
      { key: "ë³´ë‚´ëŠ”ë¶„ì£¼ì†Œ(ì „ì²´, ë¶„í• )", label: "ë³´ë‚´ëŠ”ë¶„ ì£¼ì†Œ(ì „ì²´, ë¶„í• )" },
      { key: "ë³´ë‚´ëŠ”ë¶„ì „í™”ë²ˆí˜¸",        label: "ë³´ë‚´ëŠ”ë¶„ ì „í™”ë²ˆí˜¸" },
      { key: "ë°°ì†¡ë©”ì„¸ì§€1",             label: "ë°°ì†¡ ë©”ì„¸ì§€ 1" },
      { key: "ê¸°íƒ€1",                   label: "ê¸°íƒ€1" }
    ];

    const alphaGoodsByCode = new Map();
    let alphaGoodsLoaded   = false;

    vendorSelect.addEventListener("change", (e) => {
      selectedVendor = e.target.value;
      statusVendorEl.textContent = selectedVendor ? `ì„ íƒëœ ì—…ì²´: ${selectedVendor}` : "ì—…ì²´ëª…ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.";
      updateConvertButtonState();
    });

    fileInputItems.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      alphaGoodsByCode.clear();
      alphaGoodsLoaded = false;

      if (!file) {
        statusItemsEl.textContent = "í’ˆëª© íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•´ ì£¼ì„¸ìš”.";
        updateConvertButtonState();
        return;
      }

      try {
        statusItemsEl.textContent = "í’ˆëª© íŒŒì¼ ì½ëŠ” ì¤‘...";
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];

        itemRows = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

        if (!itemRows || itemRows.length === 0) {
          statusItemsEl.textContent = `í’ˆëª© ì‹œíŠ¸("${firstSheetName}")ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`;
          updateConvertButtonState();
          return;
        }

        for (const row of itemRows) {
          const code      = (row["ìƒí’ˆì½”ë“œ"]   ?? "").toString().trim();
          if (!code) continue;

          alphaGoodsByCode.set(code, {
            ìƒí’ˆì½”ë“œ:   code,
            í’ˆëª©ëª…:     (row["í’ˆëª©ëª…"] ?? "").toString().trim(),
//          ì…ìˆ˜:       row["ì…ìˆ˜"],
//          ìƒí’ˆë¶„ë¥˜1:  (row["ìƒí’ˆë¶„ë¥˜1"] ?? "").toString().trim(),
//          ê¸°ë³¸:       row["ê¸°ë³¸"],
            ì¹´í†¤:       row["ìµœëŒ€ìˆ˜ëŸ‰"],
            ìš´ì„:       row["ìµœëŒ€ìš´ì„"]
          });
        }

        alphaGoodsLoaded = alphaGoodsByCode.size > 0;
        statusItemsEl.textContent =
          `í’ˆëª© íŒŒì¼(${firstSheetName})ì—ì„œ ${itemRows.length}í–‰, ìƒí’ˆì½”ë“œ ${alphaGoodsByCode.size}ê°œë¥¼ ì½ì—ˆìŠµë‹ˆë‹¤.`;
      } catch (err) {
        console.error(err);
        statusItemsEl.textContent = "í’ˆëª© íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      }

      updateConvertButtonState();
    });

    fileInputOrders.addEventListener("change", async (e) => {
      const file = e.target.files[0];

      if (!file) {
        statusOrdersEl.textContent = "ì£¼ë¬¸ íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•´ ì£¼ì„¸ìš”.";
        orderRows = [];
        orderHeaders = [];
        mappingEl.textContent = "ì£¼ë¬¸ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ì—´ ë§¤í•‘ ì˜µì…˜ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.";
        previewEl.innerHTML = "";
        updateConvertButtonState();
        return;
      }

      try {
        statusOrdersEl.textContent = "ì£¼ë¬¸ íŒŒì¼ ì½ëŠ” ì¤‘...";
        previewEl.innerHTML = "";
        mappingEl.textContent = "(ì—´ ì •ë³´ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...)";

        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];

        orderRows = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

        if (!orderRows || orderRows.length === 0) {
          statusOrdersEl.textContent = `ì£¼ë¬¸ ì‹œíŠ¸("${firstSheetName}")ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`;
          mappingEl.textContent = "ë§¤í•‘ì„ í•  ì£¼ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
          orderHeaders = [];
          updateConvertButtonState();
          return;
        }

        orderHeaders = Object.keys(orderRows[0]);
        statusOrdersEl.textContent =
          `ì£¼ë¬¸ ì‹œíŠ¸("${firstSheetName}")ì—ì„œ ${orderRows.length}ê°œì˜ í–‰ì„ ì½ì—ˆìŠµë‹ˆë‹¤.`;

        showPreviewTable(orderRows);
        buildMappingUI(orderHeaders);
      } catch (err) {
        console.error(err);
        statusOrdersEl.textContent = "ì£¼ë¬¸ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        mappingEl.textContent = "ë§¤í•‘ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
      }

      updateConvertButtonState();
    });

    convertBtn.addEventListener("click", () => {
      statusConvertEl.textContent = "";

      if (!selectedVendor) {
        statusConvertEl.textContent = "ë¨¼ì € ì—…ì²´ëª…ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.";
        return;
      }
      if (!orderRows || orderRows.length === 0) {
        statusConvertEl.textContent = "ë¨¼ì € ì£¼ë¬¸ íŒŒì¼ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.";
        return;
      }
      if (selectedVendor === "ì•ŒíŒŒ" && !alphaGoodsLoaded) {
        statusConvertEl.textContent = "ì•ŒíŒŒ í’ˆëª© íŒŒì¼(ìƒí’ˆ ë§ˆìŠ¤í„°)ì„ ë¨¼ì € ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.";
        return;
      }

      const mapping = getMapping();

      try {
        statusConvertEl.textContent = "ê·œì¹™ì„ ì ìš©í•˜ëŠ” ì¤‘...";

        let transformedRows = applyRules(orderRows, mapping);

        // ì•ŒíŒŒ ì „ìš© ìš´ì„êµ¬ë¶„ í›„ì²˜ë¦¬
        transformedRows = applyPostFareRules(transformedRows);

        // ë°›ëŠ”ë¶„ì„±ëª… ê¸°ì¤€ ì •ë ¬
        transformedRows.sort((a, b) => {
          const nameA = (a["ë°›ëŠ”ë¶„ì„±ëª…"] ?? "").toString().trim();
          const nameB = (b["ë°›ëŠ”ë¶„ì„±ëª…"] ?? "").toString().trim();
          return nameA.localeCompare(nameB, "ko");
        });

        // ë‚´ë¶€ í•„ë“œ ì œê±° í›„ ì €ì¥
        const cleanedRows = transformedRows.map(row => {
          const copy = { ...row };
          delete copy["_internal_qty"];
          delete copy["_adjusted_qty"];
          delete copy["_carton"];
          return copy;
        });

        const newWorksheet = XLSX.utils.json_to_sheet(cleanedRows);
        const newWorkbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, "waybill");

        XLSX.writeFile(newWorkbook, "waybill.xlsx", { compression: true });

        statusConvertEl.textContent =
          `ë³€í™˜ ì™„ë£Œ! ì´ ${cleanedRows.length}ê°œì˜ í–‰ì´ waybill.xlsxì— í¬í•¨ë˜ì—ˆìŠµë‹ˆë‹¤.`;
      } catch (err) {
        console.error(err);
        statusConvertEl.textContent = "ë³€í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      }
    });

    function updateConvertButtonState() {
      let enable = !!selectedVendor && orderRows.length > 0;
      if (selectedVendor === "ì•ŒíŒŒ") enable = enable && alphaGoodsLoaded;
      convertBtn.disabled = !enable;
    }

    function buildMappingUI(headers) {
      if (!headers || headers.length === 0) {
        mappingEl.textContent = "ì£¼ë¬¸ íŒŒì¼ì˜ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      let html = "";
      html += `<div class="mapping-hint">ê° waybill í•­ëª©ì— ëŒ€í•´ ì£¼ë¬¸ íŒŒì¼ì˜ ì—´ì„ ì„ íƒí•˜ì„¸ìš”. (ì„ íƒ ì•ˆ í•˜ë©´ ë¹ˆ ê°’)</div>`;
      html += `<div class="mapping-grid">`;

      for (const field of WAYBILL_FIELDS) {
        html += `<div class="mapping-item">`;
        html += `<label for="map-${field.key}">waybill: ${field.key}</label>`;
        html += `<select id="map-${field.key}" data-field="${field.key}">`;
        html += `<option value="">(ë¹„ì›Œë‘ê¸°)</option>`;
        for (const h of headers) html += `<option value="${escapeHtml(h)}">${escapeHtml(h)}</option>`;
        html += `</select></div>`;
      }

      html += `</div>`;
      mappingEl.innerHTML = html;
    }

    function getMapping() {
      const mapping = {};
      for (const field of WAYBILL_FIELDS) {
        const select = document.querySelector(`select[data-field="${field.key}"]`);
        mapping[field.key] = select ? (select.value || null) : null;
      }
      return mapping;
    }

    function toNumberOrZero(value) {
      if (value === null || value === undefined) return 0;
      if (value === "") return 0;
      const num = Number(String(value).replace(/,/g, "").trim() || "0");
      return Number.isFinite(num) ? num : 0;
    }

    // âœ… ì•ŒíŒŒ ì£¼ë¬¸ì‹œíŠ¸ì—ì„œ "ìƒí’ˆì½”ë“œ(ì•ŒíŒŒ ìƒí’ˆì½”ë“œ)"ë¥¼ ë‹¤ì–‘í•œ í›„ë³´ ì»¬ëŸ¼ëª…ì—ì„œ ìë™ìœ¼ë¡œ ì°¾ê¸°
    function pickFirstExistingKey(row, candidates) {
      for (const c of candidates) {
        if (row && Object.prototype.hasOwnProperty.call(row, c)) return c;
      }
      return null;
    }
    function getAlphaProductCodeFromOrderRow(row) {
      const candidates = ["ìƒí’ˆì½”ë“œ", "ì•ŒíŒŒìƒí’ˆì½”ë“œ", "ì•ŒíŒŒ ìƒí’ˆì½”ë“œ", "SKU", "sku", "ìƒí’ˆSKU", "í’ˆëª©ì½”ë“œ"];
      const key = pickFirstExistingKey(row, candidates);
      if (!key) return "";
      return (row[key] ?? "").toString().trim();
    }

    // ğŸ”¹ ë³€í™˜ ë¡œì§
    function applyRules(rows, mapping) {
      let workingRows = [...rows];

      // ì•ŒíŒŒ ì „ìš©: ë°œì£¼ì²˜ & ìˆ˜ë ¹ìëª…ì´ "ì•ˆì„±ë¬¼ë¥˜"ë©´ ì£¼ë¬¸ëŸ‰ 0 ì²˜ë¦¬
      if (selectedVendor === "ì•ŒíŒŒ") {
        workingRows = workingRows.map((row) => {
          const purchaser = (row["ë°œì£¼ì²˜"] ?? "").toString().trim();
          const receiver  = (row["ìˆ˜ë ¹ìëª…"] ?? "").toString().trim();
          if (purchaser === "ì•ˆì„±ë¬¼ë¥˜" && receiver === "ì•ˆì„±ë¬¼ë¥˜") return { ...row, ì£¼ë¬¸ëŸ‰: 0 };
          return row;
        });

        // ì£¼ë¬¸ëŸ‰ 0 ì œê±°
        workingRows = workingRows.filter((row) => toNumberOrZero(row["ì£¼ë¬¸ëŸ‰"]) !== 0);
      }

      const result = [];

      workingRows.forEach((row) => {
        let internalQty = 0;
        let cartonForRow = 0;

        if (selectedVendor === "ì•ŒíŒŒ") {
          const orderQty = toNumberOrZero(row["ì£¼ë¬¸ëŸ‰"]);
          let unitsPerBox = 0;
          let isArtMate = false;

          const code = getAlphaProductCodeFromOrderRow(row);
          if (code && alphaGoodsByCode.has(code)) {
            const goods = alphaGoodsByCode.get(code);
            unitsPerBox = toNumberOrZero(goods.ì…ìˆ˜);
            isArtMate   = (goods.ìƒí’ˆë¶„ë¥˜1 === "ì•„íŠ¸ë©”ì´íŠ¸");
            cartonForRow = toNumberOrZero(goods.ì¹´í†¤);
          }

          internalQty = isArtMate ? orderQty : (unitsPerBox * orderQty);
        } else {
          internalQty = toNumberOrZero(row["ì£¼ë¬¸ëŸ‰"] ?? row["ìˆ˜ëŸ‰"]);
          cartonForRow = 0;
        }

        // ì¹´í†¤ ë¶„í• (ì•ŒíŒŒë§Œ)
        let adjustedQtyMain = internalQty;
        let boxQtyMain = 1;
        let remainder = 0;

        if (selectedVendor === "ì•ŒíŒŒ" && cartonForRow > 0 && internalQty > cartonForRow) {
          const quotient = Math.floor(internalQty / cartonForRow);
          remainder = internalQty - quotient * cartonForRow;

          adjustedQtyMain = cartonForRow;
          boxQtyMain = quotient;
        }

        // ë©”ì¸ í–‰
        const baseRow = buildWaybillRowFromSource(row, mapping, internalQty, adjustedQtyMain, boxQtyMain, cartonForRow);
        result.push(baseRow);

        // ë‚˜ë¨¸ì§€ í–‰(ì•ŒíŒŒë§Œ, remainder > 0)
        if (selectedVendor === "ì•ŒíŒŒ" && cartonForRow > 0 && remainder > 0) {
          const remainderRow = buildWaybillRowFromSource(row, mapping, internalQty, remainder, 1, cartonForRow);
          result.push(remainderRow);
        }
      });

      return result;
    }

    function buildWaybillRowFromSource(srcRow, mapping, internalQty, adjustedQty, boxQty, cartonForRow) {
      const out = {};

      for (const field of WAYBILL_FIELDS) {
        const key = field.key;

        // ê³µí†µ ê³ ì •
        if (key === "ë³´ë‚´ëŠ”ë¶„ì£¼ì†Œ(ì „ì²´, ë¶„í• )") { out[key] = "ê²½ê¸°ë„ ê¹€í¬ì‹œ ì• ê¸°ë´‰ë¡œ 206"; continue; }
        if (key === "ë³´ë‚´ëŠ”ë¶„ì „í™”ë²ˆí˜¸")        { out[key] = "031-987-9495"; continue; }

        // ì•ŒíŒŒ: ë°œì£¼ì²˜=ì•ˆì„±ë¬¼ë¥˜ â†’ ë³´ë‚´ëŠ”ë¶„ì„±ëª…
        if (selectedVendor === "ì•ŒíŒŒ" && key === "ë³´ë‚´ëŠ”ë¶„ì„±ëª…") {
          const purchaser = (srcRow["ë°œì£¼ì²˜"] ?? "").toString().trim();
          out[key] = purchaser === "ì•ˆì„±ë¬¼ë¥˜" ? "ì•ŒíŒŒ ì•ˆì„±" : "";
          continue;
        }

        // ì•ŒíŒŒ: ë°›ëŠ”ë¶„ ë§¤í•‘
        if (selectedVendor === "ì•ŒíŒŒ") {
          if (key === "ë°›ëŠ”ë¶„ì„±ëª…") { out[key] = srcRow["ìˆ˜ë ¹ìëª…"] ?? ""; continue; }
          if (key === "ë°›ëŠ”ë¶„ì£¼ì†Œ(ì „ì²´, ë¶„í• )") { out[key] = srcRow["ìˆ˜ë ¹ì ì£¼ì†Œ"] ?? ""; continue; }
          if (key === "ë°›ëŠ”ë¶„ì „í™”ë²ˆí˜¸") {
            const p1 = (srcRow["ìˆ˜ë ¹ì ì „í™”ë²ˆí˜¸"] ?? "").toString().trim();
            const p2 = (srcRow["ìˆ˜ë ¹ì íœ´ëŒ€ì „í™”"] ?? "").toString().trim();
            out[key] = p1 || p2 || "";
            continue;
          }
          if (key === "ë°›ëŠ”ë¶„ê¸°íƒ€ì—°ë½ì²˜") { out[key] = srcRow["ìˆ˜ë ¹ì íœ´ëŒ€ì „í™”"] ?? ""; continue; }
        }

        // ë„¤ì´ë²„: ë°›ëŠ”ë¶„ ë§¤í•‘
        if (selectedVendor === "ë„¤ì´ë²„") {
          if (key === "ë°›ëŠ”ë¶„ì„±ëª…") { out[key] = srcRow["ìˆ˜ì·¨ì¸ëª…"] ?? ""; continue; }
          if (key === "ë°›ëŠ”ë¶„ì£¼ì†Œ(ì „ì²´, ë¶„í• )") { out[key] = srcRow["í†µí•©ë°°ì†¡ì§€"] ?? ""; continue; }
          if (key === "ë°›ëŠ”ë¶„ì „í™”ë²ˆí˜¸") { out[key] = srcRow["ìˆ˜ì·¨ì¸ì—°ë½ì²˜1"] ?? ""; continue; }
          if (key === "ë°›ëŠ”ë¶„ê¸°íƒ€ì—°ë½ì²˜") { out[key] = srcRow["ìˆ˜ì·¨ì¸ì—°ë½ì²˜2"] ?? ""; continue; }
        }

        // ì˜¤í”¼ìŠ¤ë””í¬: ë°›ëŠ”ë¶„ ë§¤í•‘
        if (selectedVendor === "ì˜¤í”¼ìŠ¤ë””í¬") {
          if (key === "ë°›ëŠ”ë¶„ì„±ëª…") { out[key] = srcRow["ìˆ˜ë ¹ìëª…"] ?? ""; continue; }
          if (key === "ë°›ëŠ”ë¶„ì£¼ì†Œ(ì „ì²´, ë¶„í• )") { out[key] = srcRow["ìˆ˜ë ¹ì ì£¼ì†Œ"] ?? ""; continue; }
          if (key === "ë°›ëŠ”ë¶„ì „í™”ë²ˆí˜¸") { out[key] = srcRow["ìˆ˜ë ¹ì ì „í™”ë²ˆí˜¸"] ?? ""; continue; }
          if (key === "ë°›ëŠ”ë¶„ê¸°íƒ€ì—°ë½ì²˜") { out[key] = srcRow["ìˆ˜ë ¹ì íœ´ëŒ€ì „í™”"] ?? ""; continue; }
        }

        // ì•ŒíŒŒ: ê¸°ë³¸ìš´ì„(ìˆ˜ëŸ‰==ì¹´í†¤ì´ë©´ ìš´ì„, ì•„ë‹ˆë©´ ê¸°ë³¸)
        if (selectedVendor === "ì•ŒíŒŒ" && key === "ê¸°ë³¸ìš´ì„") {
          let value = "";
          const code = getAlphaProductCodeFromOrderRow(srcRow);
          if (code && alphaGoodsByCode.has(code)) {
            const goods = alphaGoodsByCode.get(code);
            const cartonNum = toNumberOrZero(goods.ì¹´í†¤);
            const shipFare  = goods.ìš´ì„;
            const basicFare = goods.ê¸°ë³¸;
            const qtyForFare = toNumberOrZero(adjustedQty);

            if (cartonNum > 0 && qtyForFare === cartonNum && shipFare !== undefined && shipFare !== null && shipFare !== "") {
              value = shipFare;
            } else if (basicFare !== undefined && basicFare !== null && basicFare !== "") {
              value = basicFare;
            }
          }
          if (!value) {
            const mapped = mapping[key];
            if (mapped) value = srcRow[mapped] ?? "";
          }
          out[key] = value;
          continue;
        }

        // âœ… ì•ŒíŒŒ: í’ˆëª©ëª… = í’ˆëª©íŒŒì¼(ìƒí’ˆì½”ë“œ) ì¡°íšŒ + " - " + adjustedQty + "EA"
        if (selectedVendor === "ì•ŒíŒŒ" && key === "í’ˆëª©ëª…") {
          let baseName = "";
          const code = getAlphaProductCodeFromOrderRow(srcRow);

          if (code && alphaGoodsByCode.has(code)) {
            const goods = alphaGoodsByCode.get(code);
            baseName = (goods?.í’ˆëª©ëª… ?? "").toString().trim();
          }

          if (!baseName) {
            const mapped = mapping[key];
            if (mapped) baseName = (srcRow[mapped] ?? "").toString().trim();
          }

          out[key] = `${baseName} - ${adjustedQty}EA`;
          continue;
        }

        // ì•ŒíŒŒ: ë°•ìŠ¤ìˆ˜ëŸ‰
        if (selectedVendor === "ì•ŒíŒŒ" && key === "ë°•ìŠ¤ìˆ˜ëŸ‰") {
          out[key] = boxQty;
          continue;
        }

        // ê·¸ ì™¸: ë§¤í•‘ UI ê°’
        const mappedHeader = mapping[key];
        if (!mappedHeader) {
          out[key] = (key === "ë°•ìŠ¤ìˆ˜ëŸ‰") ? 1 : "";
          continue;
        }

        const value = srcRow[mappedHeader];
        if (key === "ë°•ìŠ¤ìˆ˜ëŸ‰") {
          const num = Number(value);
          out[key] = Number.isFinite(num) && num > 0 ? num : 1;
        } else {
          out[key] = value ?? "";
        }
      }

      // í›„ì²˜ë¦¬ìš© ë‚´ë¶€ í•„ë“œ
      out["_internal_qty"] = internalQty;
      out["_adjusted_qty"] = adjustedQty;
      out["_carton"] = cartonForRow;

      return out;
    }

    // ì•ŒíŒŒ ì „ìš© ìš´ì„êµ¬ë¶„ í›„ì²˜ë¦¬
    function applyPostFareRules(rows) {
      if (selectedVendor !== "ì•ŒíŒŒ") return rows;

      const groups = new Map();

      rows.forEach((row, idx) => {
        const name  = (row["ë°›ëŠ”ë¶„ì„±ëª…"] ?? "").toString().trim();
        const addr  = (row["ë°›ëŠ”ë¶„ì£¼ì†Œ(ì „ì²´, ë¶„í• )"] ?? "").toString().trim();
        const phone = (row["ë°›ëŠ”ë¶„ì „í™”ë²ˆí˜¸"] ?? "").toString().trim();
        const k = `${name}||${addr}||${phone}`;
        if (!groups.has(k)) groups.set(k, []);
        groups.get(k).push(idx);
      });

      rows.forEach((row) => {
        const name  = (row["ë°›ëŠ”ë¶„ì„±ëª…"] ?? "").toString().trim();
        const addr  = (row["ë°›ëŠ”ë¶„ì£¼ì†Œ(ì „ì²´, ë¶„í• )"] ?? "").toString().trim();
        const phone = (row["ë°›ëŠ”ë¶„ì „í™”ë²ˆí˜¸"] ?? "").toString().trim();
        const k = `${name}||${addr}||${phone}`;
        const duplicated = (groups.get(k) || []).length >= 2;

        const basicFareStr = (row["ê¸°ë³¸ìš´ì„"] ?? "").toString().trim().toUpperCase();

        // ìµœìš°ì„ : ê¸°ë³¸ìš´ì„ X
        if (basicFareStr === "X") {
          row["ìš´ì„êµ¬ë¶„"] = "â– â– Xâ– â– ";
          return;
        }

        // ì¤‘ë³µ ìˆ˜ì·¨ì¸ + ìˆ˜ëŸ‰ < ì¹´í†¤
        if (duplicated) {
          const qty = toNumberOrZero(row["_adjusted_qty"]);
          const carton = toNumberOrZero(row["_carton"]);
          if (carton > 0 && qty < carton) row["ìš´ì„êµ¬ë¶„"] = "â˜…â˜…Oâ˜…â˜…";
        }
      });

      return rows;
    }

    function showPreviewTable(rows) {
      if (!rows || rows.length === 0) {
        previewEl.innerHTML = "<em>ë¯¸ë¦¬ë³´ê¸°í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</em>";
        return;
      }

      const previewRows = rows.slice(0, 10);
      const keys = Object.keys(previewRows[0]);

      let html = `<div>ì£¼ë¬¸ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (ìƒìœ„ ${previewRows.length}í–‰)</div>`;
      html += "<table><thead><tr>";
      for (const key of keys) html += `<th>${escapeHtml(key)}</th>`;
      html += "</tr></thead><tbody>";

      for (const row of previewRows) {
        html += "<tr>";
        for (const key of keys) html += `<td>${escapeHtml(row[key])}</td>`;
        html += "</tr>";
      }

      html += "</tbody></table>";
      previewEl.innerHTML = html;
    }

    function escapeHtml(value) {
      if (value === null || value === undefined) return "";
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/"/g, "&quot;");
    }
  </script>
</body>
</html>
