<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Waybill 변환</title>

  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }

    body{
      margin:0;
      min-height:100vh;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(59,130,246,.25), transparent 55%),
        radial-gradient(900px 500px at 80% 20%, rgba(14,165,233,.18), transparent 55%),
        linear-gradient(180deg, #0b1220 0%, #070b14 100%);
      color:#e5e7eb;
    }

    .wrap{
      max-width: 1080px;
      margin: 0 auto;
      padding: 28px 22px 40px;
    }

    h1{
      margin: 0 0 8px;
      font-size: 28px;
      line-height: 1.15;
      font-weight: 800;
      letter-spacing: -0.02em;
      color: #f8fafc;
    }

    .sub{
      margin: 0 0 18px;
      color:#cbd5e1;
      font-size: 13px;
      line-height: 1.6;
    }
    .sub b{ color:#f8fafc; }

    .panel{
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 18px;
      padding: 22px;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }

    .row{ margin: 14px 0 18px; }

    .label{
      display:block;
      margin: 0 0 10px;
      font-weight: 800;
      font-size: 14px;
      color:#f1f5f9;
    }

    .control, .select{
      width:100%;
      height: 48px;
      border-radius: 14px;
      background: rgba(2,6,23,0.55);
      border: 1px solid rgba(148,163,184,0.25);
      color:#e5e7eb;
      padding: 10px 14px;
      outline:none;
    }

    .control:focus, .select:focus{
      border-color: rgba(59,130,246,.65);
      box-shadow: 0 0 0 4px rgba(59,130,246,.18);
    }

    /* 커스텀 파일 업로더 (2번째 이미지 느낌) */
    .filewrap{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      width: 100%;
      min-height: 56px;
      border-radius: 16px;
      background: rgba(2,6,23,0.55);
      border: 1px solid rgba(148,163,184,0.25);
      padding: 10px 12px;
    }

    .filewrap:focus-within{
      border-color: rgba(59,130,246,.65);
      box-shadow: 0 0 0 4px rgba(59,130,246,.18);
    }

    .filewrap .pick{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height: 34px;
      padding: 0 12px;
      border-radius: 10px;
      background: #f8fafc;
      color: #0b1220;
      font-weight: 900;
      font-size: 13px;
      cursor: pointer;
      user-select: none;
      border: 1px solid rgba(0,0,0,0.12);
      flex: 0 0 auto;
    }

    .filewrap .name{
      flex: 1 1 auto;
      color:#cbd5e1;
      font-size: 13px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    input[type="file"]{
      position:absolute;
      left:-9999px;
      width:1px;height:1px;
      opacity:0;
    }

    .actions{
      margin-top: 8px;
      display:flex;
      align-items:center;
      gap: 12px;
    }

    .btn{
      height: 44px;
      padding: 0 18px;
      border-radius: 999px;
      border: 0;
      font-weight: 900;
      cursor: pointer;
      display:inline-flex;
      align-items:center;
      gap: 10px;
      color:#fff;
      background: linear-gradient(180deg, rgba(59,130,246,1) 0%, rgba(37,99,235,1) 100%);
      box-shadow: 0 12px 26px rgba(37,99,235,.25);
    }

    .btn:disabled{
      opacity: .55;
      cursor: not-allowed;
      box-shadow: none;
    }

    /* 2번째 이미지의 긴 가로 라인 느낌 */
    .divider{
      height: 1px;
      background: rgba(148,163,184,0.22);
      margin: 22px 0 14px;
    }

    .divider.big{
      margin: 18px 0 0;
    }

    .log{
      background: rgba(2,6,23,0.55);
      border: 1px solid rgba(148,163,184,0.20);
      border-radius: 14px;
      padding: 12px 14px;
      min-height: 100px;
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px;
      color:#e2e8f0;
      margin-top: 14px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Waybill 변환 (알파/네이버/오피스디포/웰루포인트/오피스넥스/이베이/드림오피스)</h1>
    <div class="sub">
      공통 품목 파일 + 주문 파일 업로드 → <b>waybill.xlsx</b> 생성<br/>
      (제외) 네이버: 위/김 / 공통: 주문량=0 / 금액&lt;1 / 품목명에 [단종]
    </div>

    <div class="panel">

      <div class="row">
        <label class="label">0. 업체 선택</label>
        <!-- 스타일만 맞추기 위한 UI (현재 로직엔 영향 없음) -->
        <select id="vendor" class="select">
          <option value="">선택하세요</option>
          <option value="alpha">알파</option>
          <option value="naver">네이버</option>
          <option value="office_depot">오피스디포</option>
          <option value="wellupoint">웰루포인트</option>
          <option value="officenex">오피스넥스</option>
          <option value="ebay">이베이</option>
          <option value="dreamoffice">드림오피스</option>
        </select>
      </div>

      <div class="row">
        <label class="label">1. 공통 품목 파일 업로드</label>
        <div class="filewrap">
          <label class="pick" for="goodsFile">파일 선택</label>
          <div class="name" id="goodsName">선택된 파일 없음</div>
          <input id="goodsFile" type="file" accept=".xlsx,.xls" />
        </div>
      </div>

      <div class="row">
        <label class="label">2. 주문 파일 업로드</label>
        <div class="filewrap">
          <label class="pick" for="orderFile">파일 선택</label>
          <div class="name" id="orderName">선택된 파일 없음</div>
          <input id="orderFile" type="file" accept=".xlsx,.xls" />
        </div>
      </div>

      <div class="actions">
        <button id="runBtn" class="btn" disabled>waybill.xlsx 생성</button>
      </div>

      <div class="divider"></div>

      <div id="log" class="log"></div>

      <div class="divider big"></div>
    </div>
  </div>

  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    const $ = (sel) => document.querySelector(sel);

    const vendorSel = $("#vendor"); // UI용(현재 로직엔 영향 없음)
    const orderInput = $("#orderFile");
    const goodsInput = $("#goodsFile");
    const runBtn = $("#runBtn");
    const logEl = $("#log");
    const goodsName = $("#goodsName");
    const orderName = $("#orderName");

    function log(msg) { logEl.textContent += msg + "\n"; }
    function clearLog() { logEl.textContent = ""; }

    function normalizeHeader(h) {
      return String(h ?? "").trim().replace(/\s+/g, "").toLowerCase();
    }

    function normalizeCode(v) {
      if (v === null || v === undefined) return "";
      let s = String(v).trim();
      if (/^\d+(\.0+)?$/.test(s)) s = s.replace(/\.0+$/, "");
      return s;
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    function findHeaderRowIndex(aoa, requiredHeaderCandidates, scanRows = 30) {
      const limit = Math.min(scanRows, aoa.length);
      for (let r = 0; r < limit; r++) {
        const row = (aoa[r] || []).map(normalizeHeader);
        let ok = true;
        for (const group of requiredHeaderCandidates) {
          const hasAny = group.some(cand => row.includes(normalizeHeader(cand)));
          if (!hasAny) { ok = false; break; }
        }
        if (ok) return r;
      }
      return 0;
    }

    function findColIndex(headers, candidates) {
      const hnorm = headers.map(normalizeHeader);
      for (const cand of candidates) {
        const c = normalizeHeader(cand);
        const idx = hnorm.indexOf(c);
        if (idx >= 0) return idx;
      }
      for (const cand of candidates) {
        const c = normalizeHeader(cand);
        const idx = hnorm.findIndex(h => h.includes(c) || c.includes(h));
        if (idx >= 0) return idx;
      }
      return -1;
    }

    function todayYMD() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}${mm}${dd}`;
    }

    function enableIfReady() {
      // 기능 변화 없이 "파일 2개 업로드"만으로 활성화 (업체선택은 스타일용)
      runBtn.disabled = !(orderInput.files?.[0] && goodsInput.files?.[0]);
    }

    function syncFileName(inputEl, labelEl) {
      const f = inputEl.files?.[0];
      labelEl.textContent = f ? f.name : "선택된 파일 없음";
      enableIfReady();
    }

    vendorSel.addEventListener("change", enableIfReady);
    goodsInput.addEventListener("change", () => syncFileName(goodsInput, goodsName));
    orderInput.addEventListener("change", () => syncFileName(orderInput, orderName));

    runBtn.addEventListener("click", async () => {
      clearLog();
      try {
        const orderFile = orderInput.files[0];
        const goodsFile = goodsInput.files[0];

        log("[1/4] 파일 읽는 중...");
        const [orderBuf, goodsBuf] = await Promise.all([
          readFileAsArrayBuffer(orderFile),
          readFileAsArrayBuffer(goodsFile)
        ]);

        log("[2/4] 엑셀 파싱 중...");
        const orderWb = XLSX.read(orderBuf, { type: "array" });
        const goodsWb = XLSX.read(goodsBuf, { type: "array" });

        const orderSheetName = orderWb.SheetNames[0];
        const goodsSheetName = goodsWb.SheetNames[0];

        const orderWs = orderWb.Sheets[orderSheetName];
        const goodsWs = goodsWb.Sheets[goodsSheetName];

        const orderAoa = XLSX.utils.sheet_to_json(orderWs, { header: 1, defval: "" });
        const goodsAoa = XLSX.utils.sheet_to_json(goodsWs, { header: 1, defval: "" });

        const orderHeaderRow = findHeaderRowIndex(orderAoa, [
          ["상품코드", "알파 상품코드", "알파상품코드"],
          ["수량", "주문수량", "발주수량"]
        ]);

        const goodsHeaderRow = findHeaderRowIndex(goodsAoa, [
          ["알파 상품코드", "알파상품코드"],
          ["품목코드"]
        ]);

        const orderHeaders = orderAoa[orderHeaderRow] || [];
        const goodsHeaders = goodsAoa[goodsHeaderRow] || [];

        const orderAlphaIdx = findColIndex(orderHeaders, ["알파 상품코드", "알파상품코드", "상품코드"]);
        const orderQtyIdx   = findColIndex(orderHeaders, ["수량", "주문수량", "발주수량"]);
        const orderNameIdx  = findColIndex(orderHeaders, ["상품명", "품명"]);
        const orderSpecIdx  = findColIndex(orderHeaders, ["규격", "옵션", "세부사항"]);

        const goodsAlphaIdx = findColIndex(goodsHeaders, ["알파 상품코드", "알파상품코드"]);
        const goodsItemIdx  = findColIndex(goodsHeaders, ["품목코드"]);

        if (orderAlphaIdx < 0) throw new Error("주문서에서 상품코드(알파 상품코드) 컬럼을 찾지 못했습니다.");
        if (orderQtyIdx < 0)   throw new Error("주문서에서 수량 컬럼을 찾지 못했습니다.");
        if (goodsAlphaIdx < 0) throw new Error("erp_goods에서 알파 상품코드 컬럼을 찾지 못했습니다.");
        if (goodsItemIdx < 0)  throw new Error("erp_goods에서 품목코드 컬럼을 찾지 못했습니다.");

        log(`- 주문서 시트: ${orderSheetName} / 헤더행: ${orderHeaderRow + 1}`);
        log(`- erp_goods 시트: ${goodsSheetName} / 헤더행: ${goodsHeaderRow + 1}`);

        log("[3/4] 알파 상품코드 → 품목코드 매핑 생성 중...");
        const alphaToItem = new Map();
        for (let r = goodsHeaderRow + 1; r < goodsAoa.length; r++) {
          const row = goodsAoa[r] || [];
          const alpha = normalizeCode(row[goodsAlphaIdx]);
          const item = String(row[goodsItemIdx] ?? "").trim();
          if (!alpha || !item) continue;
          if (!alphaToItem.has(alpha)) alphaToItem.set(alpha, item);
        }

        log("[4/4] Template(주문서입력) 데이터 생성 중...");
        const outHeaders = ["품목코드", "수량", "세부사항", "입수량", "카톤수", "무게"];
        const outRows = [];
        const unmatchedRows = [];

        for (let r = orderHeaderRow + 1; r < orderAoa.length; r++) {
          const row = orderAoa[r] || [];
          const alpha = normalizeCode(row[orderAlphaIdx]);
          const qty = row[orderQtyIdx];

          if (!alpha && (qty === "" || qty === null || qty === undefined)) continue;

          const itemCode = alphaToItem.get(alpha) || "";
          const name = orderNameIdx >= 0 ? String(row[orderNameIdx] ?? "").trim() : "";
          const spec = orderSpecIdx >= 0 ? String(row[orderSpecIdx] ?? "").trim() : "";
          const detail = [name, spec].filter(Boolean).join(" / ");

          outRows.push([itemCode, qty, detail, "", "", ""]);

          if (!itemCode) {
            unmatchedRows.push({
              "주문서행번호(엑셀기준)": r + 1,
              "알파상품코드": alpha,
              "수량": qty,
              "상품명": name,
              "규격": spec
            });
          }
        }

        const outWb = XLSX.utils.book_new();
        const wsOut = XLSX.utils.aoa_to_sheet([outHeaders, ...outRows]);
        XLSX.utils.book_append_sheet(outWb, wsOut, "주문서입력");

        if (unmatchedRows.length > 0) {
          const wsUn = XLSX.utils.json_to_sheet(unmatchedRows, { skipHeader: false });
          XLSX.utils.book_append_sheet(outWb, wsUn, "미매칭");
          log(`- 미매칭: ${unmatchedRows.length}건 (미매칭 시트에 저장)`);
        } else {
          log("- 미매칭: 0건");
        }

        const outName = `waybill_${todayYMD()}.xlsx`;
        XLSX.writeFile(outWb, outName);
        log(`\n완료! 다운로드 파일: ${outName}`);
      } catch (err) {
        console.error(err);
        log("\n[오류] " + (err?.message || String(err)));
      }
    });
  </script>
</body>
</html>
