<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>주문서 → Template(품목코드 채움)</title>
  <style>
    /* ✅ 다크모드/자동반전 환경에서도 글자 안 사라지게 */
    :root { color-scheme: light; }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 24px;
      background: #fff;
      color: #111; /* ✅ 기본 글자색 */
    }

    h2 { color: #111; }

    .card {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 16px;
      max-width: 820px;
      background: #fff;
      color: #111;
    }

    label {
      display:block;
      margin: 12px 0 6px;
      font-weight: 600;
      color: #111; /* ✅ */
    }

    input[type="file"] {
      width: 100%;
      color: #111; /* ✅ 파일명 표시 */
    }

    button {
      margin-top: 16px;
      padding: 10px 14px;
      border: 0;
      border-radius: 10px;
      cursor: pointer;
      background: #111;
      color: #fff; /* ✅ 버튼 글자 */
    }

    button:disabled {
      opacity: .5;
      cursor: not-allowed;
    }

    .hint {
      color:#222; /* ✅ */
      font-size: 13px;
      line-height: 1.5;
      margin-top: 10px;
    }
    .hint b { color: #111; } /* ✅ 강조 텍스트 */

    .log {
      background:#fafafa;
      border:1px solid #eee;
      border-radius:10px;
      padding:12px;
      margin-top:16px;
      white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px;
      color: #111; /* ✅ 로그 글자 */
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>erp_goods + 주문서 현황 → Template(주문서입력) 생성</h2>

    <label>1) 공통 품목 파일(erp_goods) 업로드 (.xlsx)</label>
    <input id="goodsFile" type="file" accept=".xlsx,.xls" />

    <label>2) 주문서 현황 파일 업로드 (.xlsx)</label>
    <input id="orderFile" type="file" accept=".xlsx,.xls" />

    <button id="runBtn" disabled>변환 & 다운로드</button>

    <div class="hint">
      - 주문서에서 <b>(알파) 상품코드</b>를 찾고, erp_goods의 <b>알파 상품코드 → 품목코드</b>로 매핑합니다.<br/>
      - 결과 엑셀은 Template 업로드 없이, 시트명 <b>주문서입력</b> / 헤더 <b>품목코드, 수량, 세부사항, 입수량, 카톤수, 무게</b>로 생성됩니다.<br/>
      - 매칭 실패 건은 <b>미매칭</b> 시트에 따로 저장합니다.
    </div>

    <div id="log" class="log"></div>
  </div>

  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const orderInput = $("#orderFile");
    const goodsInput = $("#goodsFile");
    const runBtn = $("#runBtn");
    const logEl = $("#log");

    function log(msg) {
      logEl.textContent += msg + "\n";
    }
    function clearLog() {
      logEl.textContent = "";
    }

    function normalizeHeader(h) {
      return String(h ?? "")
        .trim()
        .replace(/\s+/g, "")
        .toLowerCase();
    }

    function normalizeCode(v) {
      if (v === null || v === undefined) return "";
      let s = String(v).trim();
      if (/^\d+(\.0+)?$/.test(s)) s = s.replace(/\.0+$/, "");
      return s;
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    function findHeaderRowIndex(aoa, requiredHeaderCandidates, scanRows = 30) {
      const limit = Math.min(scanRows, aoa.length);
      for (let r = 0; r < limit; r++) {
        const row = (aoa[r] || []).map(normalizeHeader);
        let ok = true;
        for (const group of requiredHeaderCandidates) {
          const hasAny = group.some(cand => row.includes(normalizeHeader(cand)));
          if (!hasAny) { ok = false; break; }
        }
        if (ok) return r;
      }
      return 0;
    }

    function fi
